<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>刷量统计</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/ok-admin/lib/layui/css/layui.css">
    <link rel="stylesheet" href="/static/ok-admin/css/sub-page.css">
    <style>
        /* 下拉条件框 */
        .my-collapse {
            position: relative;
            box-shadow: none;
        }

        .my-collapse * {
            box-shadow: none;
        }

        .my-collapse .layui-form-select dl,
        .my-collapse .layui-form-select .layui-anim {
            top: 33px !important;
        }

        .my-collapse > div:first-child {
            background: #f2f2f2;
            border: 1px solid #e6e6e6;
        }

        .my-collapse > div {
            padding: 6px 5px;
        }

        .my-hide {
            padding-bottom: 1px !important;
            width: 100%;
            display: none;
            position: absolute;
            top: 43px;
            left: 0;
            z-index: 894;
            background: #fff;
            border-left: 1px solid #e6e6e6;
            border-right: 1px solid #e6e6e6;
            border-bottom: 1px solid #e6e6e6;
            border-bottom-right-radius: 2px;
            border-bottom-left-radius: 2px;
        }

        .my-collapse button {
            height: 30px;
            line-height: 30px;
        }

        .my-collapse .my-btn {
            height: 30px !important;
            line-height: 30px !important;
            padding: 0 18px;
            background-color: #45a3c2;
            color: #fff;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
        }

        .my-collapse .my-btn:hover {
            opacity: .8;
            transition: opacity 0.5s;
        }

        .layui-input-inline input {
            height: 30px;
        }

        .layui-form-pane .layui-form-label {
            width: 116px;
            padding: 8px 15px;
            height: 30px;
            line-height: 13px;
            border-width: 1px;
            border-style: solid;
            border-radius: 2px 0 0 2px;
            text-align: center;
            background-color: #FBFBFB;
            overflow: hidden;
            box-sizing: border-box
        }

        .layui-inline label {
            border-right: none;
        }

        .layui-form-pane .layui-form-checkbox {
            margin: 0;
        }

        .layui-inline input {
            width: 180px;
            height: 30px;
        }

        .layui-inline:nth-child(1) input {
            width: 140px;
        }

        .layui-table-body .layui-table-cell {
            text-align: left;
        }

        .layui-table-body .laytable-cell-checkbox {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="ok-body">
    <div class="layui-tab layui-tab-card" lay-filter="refreshTab">
        <ul class="layui-tab-title" id="tabItem">
            <li data-type="pt" data-terminal="PC" class="layui-this">单词电脑</li>
            <li data-type="pt" data-terminal="Phone">单词手机</li>
            <li data-type="qz" data-terminal="PC">整站电脑</li>
            <li data-type="qz" data-terminal="Phone">整站手机</li>
            <li data-type="fm" data-terminal="PC">负面电脑</li>
            <li data-type="fm" data-terminal="Phone">负面手机</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="layui-card">
                    <div class="layui-card-body ">
                        <form class="layui-form layui-form-pane" id="searchForm">
                            <div class="my-collapse">
                                <div>
<!--                                    <div class="layui-inline">-->
<!--                                        <select name="entryType" lay-filter="entryType">-->
<!--                                            <option value="qz">全站链接</option>-->
<!--                                            <option value="pt" selected>普通链接</option>-->
<!--                                            <option value="fm">负面链接</option>-->
<!--                                            <option value="bc">BC链接</option>-->
<!--                                        </select>-->
<!--                                    </div>-->
                                    <input type="hidden" id="entryType" name="entryType" value="pt">
                                    <input type="hidden" id="terminalType" name="terminalType" value="PC">
                                    <div class="layui-inline">
                                        <input type="text" name="groupName" id="groupName" placeholder="请输入分组查询" class="layui-input">
                                    </div>
                                    <div class="layui-inline">
                                        <input type="checkbox" name="groupNameFuzzyQuery" title="模糊搜索">
                                    </div>
                                    <div class="layui-inline">
                                        <input type="text" name="machineGroup" placeholder="请输入机器分组" class="layui-input">
                                    </div>
                                    <div class="layui-inline">
                                        <input type="text" name="customerName" id="customerName" placeholder="请输入客户名称" class="layui-input">
                                    </div>
                                    <!--                        <div class="layui-inline">-->
                                    <!--                            <select name="categoryTag">-->
                                    <!--                                <option value="">请选择分类标签</option>-->
                                    <!--                            </select>-->
                                    <!--                        </div>-->
                                    <div class="layui-inline">
                                        <select name="dayNum">
                                            <option value="">请选择历史记录</option>
                                            <option value="1">一天前</option>
                                            <option value="2">两天前</option>
                                            <option value="3">三天前</option>
                                            <option value="4">四天前</option>
                                            <option value="5">五天前</option>
                                            <option value="6">六天前</option>
                                        </select>
                                    </div>
                                    <div class="layui-inline">
                                        <button class="layui-btn" lay-submit lay-filter="search"
                                                id="searchBtn">搜索
                                        </button>
                                    </div>
                                    <div class="layui-inline">
                                        <button style="background: #897c00;color: #ffffff" class="layui-btn"
                                                type="reset">
                                            重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <!--数据表格-->
                <table class="layui-hide" id="refreshTable" lay-filter="refreshTable"></table>
            </div>
        </div>
    </div>
    <!--TODO 跳转页面 但是跳但是目前跳转的是久的页面-->
    <form id="searchCustomerKeywordForm" style="display: none;" method="post" target="_blank"
          action="/internal/customerKeyword/searchCustomerKeywordLists">
        <input type="hidden" name="optimizeGroupName" id="optimizeGroupName" value=""/>
        <input type="hidden" name="invalidRefreshCount" id="invalidRefreshCount" value=""/>
        <input type="hidden" name="noReachStandardDays" id="noReachStandardDays" value=""/>
        <input type="hidden" name="status" id="status" value="1"/>
    </form>
</div>
<!--js逻辑-->
<script src="/static/ok-admin/lib/layui/layui.js"></script>
<script src="/static/ok-admin/lib/nprogress/nprogress.js"></script>
<script>
    // 进度条加载提示
    NProgress.start();

    window.onload = function () {
        NProgress.done();
    };

    // layui相关
    layui.use(['element', 'table', 'form', 'jquery'], function () {
        var element = layui.element;
        var table = layui.table;
        var form = layui.form;
        var $ = layui.jquery;

        <@shiro.hasPermission name = "/internal/customerKeyword/searchCustomerKeywordLists" >
        window.searchCustomerKeywords = function (group) {
            $("#searchCustomerKeywordForm").find("#optimizeGroupName").val(group);
            $("#searchCustomerKeywordForm").submit();
        };
        </@shiro.hasPermission>

        <@shiro.hasPermission name="/internal/customerKeyword/searchCustomerKeywordLists">
        window.findKeyword = function (optimizeGroupName, invalidRefreshCount) {
            if (invalidRefreshCount == null) {
                $("#searchCustomerKeywordForm").find("#noReachStandardDays").val(-1);
            } else {
                $("#searchCustomerKeywordForm").find("#noReachStandardDays").val(0);
            }
            $("#searchCustomerKeywordForm").find("#invalidRefreshCount").val(invalidRefreshCount ? invalidRefreshCount : '');
            $("#searchCustomerKeywordForm").find("#optimizeGroupName").val(optimizeGroupName ? optimizeGroupName : '');
            $("#searchCustomerKeywordForm").submit();
        };
        </@shiro.hasPermission>

        window.resetInvaidRefreshCount = function (groupName, customerName, fullMatchGroup) {
            let condition = {};
            condition.customerName = customerName;
            condition.groupName = groupName;
            condition.fullMatchGroup = fullMatchGroup;
            condition.entryType = $.parseJSON(formToJson($("#searchForm").serialize())).entryType;
            $.ajax({
                url: '/internal/customerKeyword/resetInvalidRefresh',
                data: JSON.stringify(condition),
                type: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                success: function (res) {
                    if (res.code === 200) {
                        show_layer_msg('重置成功', 6, true);
                    } else {
                        show_layer_msg('重置失败', 5);
                    }
                },
                error: function () {
                    show_layer_msg('重置失败', 5);
                }
            });
        };

        init();

        function init() {
            let condition = $.parseJSON(formToJson($("#searchForm").serialize()));
            if (condition.dayNum === '') {
                condition.dayNum = 0;
            }
            tableInit(condition);
        }

        <@shiro.hasPermission name="/internal/refreshstatinfo/searchRefreshStatInfos">
        function tableInit(condition) {
            table.render({
                elem: '#refreshTable',
                method: 'post',
                url: '/internal/refreshstatistics/getRefreshDataByCondition',
                page: false,
                autoSort: true,
                size: 'sm',
                id: 'refreshTable',
                even: true,//隔行背景
                where: condition,
                defaultToolbar: ['filter'],
                contentType: 'application/json',
                cols: [[
                    {filed: 'uuid', type: 'checkbox', width: '2%', rowspan :2},
                    {filed: 'group', title: '类型', width: '10%', align: 'center', rowspan: 2 ,templet: '#group', sort: true},
                    {title: '关键字', width: '49%', align: 'center', colspan: 8},
                    {title: '刷的次数', width: '39%', align: 'center', colspan: 6}
                ],[
                    {field: 'totalKeywordCount', title: '总数', width: '6%', align: 'center', sort:true},
                    {
                        field: 'reachStandardKeywordCount', title: '达标数(金额)', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.reachStandardKeywordCount > 0) {
                                if (d.group === '总计') {
                                    return '<a href="javascript:findKeyword(\'\', \'\')" style="color: blue">' + d.reachStandardKeywordCount + '('
                                        + d.todaySubTotal + ')</a>';
                                }
                                return '<a href="javascript:findKeyword(\'' + d.group + '\', \'\')" style="color: blue">' + d.reachStandardKeywordCount + '('
                                    + d.todaySubTotal + ')</a>';
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'reachStandardPercentage', title: '达标率', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.reachStandardPercentage > 0) {
                                return d.reachStandardPercentage.toFixed(2) + '%';
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'zeroOptimizedCount', title: '没有刷量', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.zeroOptimizedCount > 0) {
                                return d.zeroOptimizedCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'needOptimizeKeywordCount', title: '待刷数', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.needOptimizeKeywordCount > 0) {
                                return d.needOptimizeKeywordCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'invalidKeywordCount', title: '无效刷量', width: '7%', align: 'center',sort:true, templet: function (d) {
                            if (d.invalidKeywordCount > 0) {
                                let html = '';
                                if (d.group === '总计') {
                                    html = '<a href="javascript:findKeyword(\'\', \'' + d.maxInvalidCount + '\')" style="color: blue">' + d.invalidKeywordCount
                                        + '</a>';
                                } else {
                                    html = '<a href="javascript:findKeyword(\'' + d.group + '\', \'' + d.maxInvalidCount + '\')" style="color: blue">'
                                        + d.invalidKeywordCount + '</a>';
                                }
                                <@shiro.hasPermission name="/internal/customerKeyword/resetInvalidRefreshCount">
                                let cus = document.getElementById('customerName').value;
                                if (d.group === '总计') {
                                    html += '<a href="javascript:resetInvaidRefreshCount(\'' + document.getElementById('groupName').value
                                        + '\',\'' + cus
                                        + '\', false)" style="color: blue;margin-left: 5px">重置</a>';
                                } else {
                                    html += '<a href="javascript:resetInvaidRefreshCount(\'' + d.group
                                        + '\',\'' + cus + '\', true)" style="color: blue;margin-left: 5px">重置</a>';
                                }
                                </@shiro.hasPermission>
                                return html;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'failedKeywordCount', title: '失败数', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.failedKeywordCount > 0) {
                                return d.failedKeywordCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'invalidKeywordPercentage', title: '无效占比', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.invalidKeywordPercentage > 0) {
                                let color = d.invalidKeywordPercentage > 20 ? "red" : (d.invalidKeywordPercentage > 10 ? "purple" : "#000");
                                return '<span style="color: ' + color + '">' + d.invalidKeywordPercentage.toFixed(2) + '%</span>';
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'totalOptimizeCount', title: '总次数', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.totalOptimizeCount > 0) {
                                return d.totalOptimizeCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'totalOptimizedCount', title: '已刷次数', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.totalOptimizedCount > 0) {
                                return d.totalOptimizedCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'needOptimizeCount', title: '待刷次数', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.needOptimizeCount > 0) {
                                return d.needOptimizeCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'avgOptimizedCount', title: '平均有效刷量', width: '8%', align: 'center', sort: true, templet: function (d) {
                            if (d.avgOptimizedCount > 0) {
                                let color = d.avgOptimizedCount <= 30 ? "red" : "black";
                                return '<span style="color: ' + color + '">' + d.avgOptimizedCount.toFixed(2) + '</span>';
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'queryCount', title: '取词次数', width: '7%', align: 'center', sort: true, templet: function (d) {
                            if (d.queryCount > 0) {
                                return d.queryCount;
                            } else {
                                return '';
                            }
                        }
                    },
                    {
                        field: 'invalidOptimizePercentage', title: '无效占比', width: '6%', align: 'center', sort: true, templet: function (d) {
                            if (d.invalidOptimizePercentage > 0) {
                                let color = d.invalidOptimizePercentage > 20 ? "red" : (d.invalidOptimizePercentage > 10 ? "purple" : "#000");
                                return '<span style="color: ' + color + '">' + d.invalidOptimizePercentage.toFixed(2) + '%</span>';
                            } else {
                                return '';
                            }
                        }
                    }
                ]],
                height: 'full-148',
                done: function (res, curr, count) {
                }
            });
        }
        </@shiro.hasPermission>

        // form.on('select(entryType)', function (data) {
        //     active['reload'].call(this);
        // });

        element.on('tab(refreshTab)', function (data) {
            let d = data.elem.context.dataset;
            $('#entryType').val(d.type);
            $('#terminalType').val(d.terminal);
            active['reload'].call(this);
        });

        //监听排序事件
        // table.on('sort(refreshTable)', function(obj){ //注：sort 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
        //     console.log(obj.field); //当前排序的字段名
        //     console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
        //     console.log(this); //当前排序的 th 对象
        //
        //     //尽管我们的 table 自带排序功能，但并没有请求服务端。
        //     //有些时候，你可能需要根据当前排序的字段，重新向服务端发送请求，从而实现服务端排序，如：
        //     table.reload('refreshTable', {
        //         initSort: obj, //记录初始排序，如果不设的话，将无法标记表头的排序状态。
        //         data: data
        //     });

        //监听工具条
        var active = {
            reload: function () {
                let condition = $.parseJSON(formToJson($("#searchForm").serialize()));
                if (condition.dayNum === '') {
                    condition.dayNum = 0;
                }
                if (!condition.groupNameFuzzyQuery) {
                    condition.groupNameFuzzyQuery = '';
                }
                table.reload('refreshTable', {
                    where: condition
                });
            }
        };

        form.on("submit(search)", function (data) {
            let condition = data.field;
            if (condition.dayNum === '') {
                condition.dayNum = 0;
            }
            if (!condition.groupNameFuzzyQuery) {
                condition.groupNameFuzzyQuery = '';
            }
            table.reload('refreshTable', {
                where: condition
            });
            return false;
        });

        function formToJson(data) {
            data = data.replace(/&/g, "\",\"");
            data = data.replace(/=/g, "\":\"");
            data = "{\"" + data + "\"}";
            return data;
        }

        function show_layer_msg(msg, icon, status, title) {
            layer.msg(msg, {
                icon: icon,
                title: title === undefined ? null : title,
                anim: 5,
                time: 1000,
                isOutAnim: false
            }, function () {
                if (status) {
                    active['reload'].call(this);
                }
            });
        }

        function dbs(d) {
            if (d.reachStandardKeywordCount > 0) {
                if (d.group === '总计') {
                    return '<a href="javascript:findKeyword(\'\', \'\')" style="color: blue">' + d.reachStandardKeywordCount + '('
                        + d.todaySubTotal + ')</a>';
                }
                return '<a href="javascript:findKeyword(\'' + d.group + '\', \'\')" style="color: blue">' + d.reachStandardKeywordCount + '('
                    + d.todaySubTotal + ')</a>';
            } else {
                return 1;
            }
        }

    });
</script>
<script type="text/html" id="group">
    {{#  if(d.group === '总计') { }}
    {{ d.group }}
    {{# }else{ }}
    <a href="javascript:searchCustomerKeywords('{{ d.group }}')" style="color: blue">{{ d.group }}</a>
    {{# } }}
</script>
</body>
</html>
