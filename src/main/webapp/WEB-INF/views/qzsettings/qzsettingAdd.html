<!DOCTYPE html>
<#assign organizationName = Session["organizationName"]>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>添加</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/ok-admin/lib/layui/css/layui.css">
    <link rel="stylesheet" href="/static/ok-admin/css/sub-page.css">
    <link rel="stylesheet" href="/static/layui/add-or-upd.css">
    <style>
        .layui-btn {
            width: 150px;
        }

        .four-row .layui-form-label {
            width: 120px;
        }

        .four-row .layui-input-block {
            margin-left: 120px;
        }

        .my-text {
            text-indent: 10px;
            line-height: 38px;
        }
    </style>
    <script>
        let v_com = 2;
        let v_phone = 2;

        function appendTable(f) {
            let t, v;
            if (f) {
                t = tbody_com;
                v = v_com++;
            } else {
                t = tbody_phone;
                v = v_phone++;
            }
            let html = '<tr>\n                                    <td>\n                                        <div class="my-label my-left my-padding">';
            html += v;
            html += '</div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-btn my-left my-bottom">\n                                            <button type="button" onclick="removeElement(this)"\n                                                    class="layui-btn layui-btn-xs layui-btn-danger">\n                                                删除\n                                            </button>\n                                        </div>\n                                    </td>\n                                </tr>';
            t.append(html);
        }

        function resetHidden() {
            let c = document.getElementsByName('computer')[0];
            if (c.nextElementSibling.getElementsByTagName('em')[0].innerText === '选中') {
                c.setAttribute('checked', '');
            } else {
                c.removeAttribute('checked');
            }
            let p = document.getElementsByName('phone')[0];
            if (p.nextElementSibling.getElementsByTagName('em')[0].innerText === '选中') {
                p.setAttribute('checked', '');
            } else {
                p.removeAttribute('checked');
            }
        }
    </script>
</head>
<div>
    <!--form表单-->
    <form class="layui-form layui-form-pane ok-form" lay-filter="addQZSetting">
        <div class="ok-body">
            <input type="hidden" name="uuid" value=""/>
            <div class="layui-row">
                <div class="layui-col-md9 padding-ten-right">
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 120px;">客户</label>
                        <div class="layui-input-block" style="margin-left: 120px;">
                            <select id="customerList" name="customerUuid" lay-verify="required" lay-search>
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left four-row">
                    <div class="layui-form-item">
                        <label class="layui-form-label">续费状态</label>
                        <input type="hidden" value="4" name="siteStatus" id="siteStatus">
                        <div class="layui-input-block my-text" id="siteStatusDiv" style="color: mediumseagreen;border: #e6e6e6 1px solid;height: 36px">其他</div>
                    </div>
                </div>
            </div>
            <div class="layui-row four-row">
                <div class="layui-col-md3 padding-ten-right">
                    <div class="layui-form-item">
                        <label class="layui-form-label">域名</label>
                        <div class="layui-input-block">
                            <input type="text" name="domain" placeholder="请输入顶级域名，不带www" autocomplete="off" class="layui-input" lay-verify="required|domain">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left padding-ten-right">
                    <div class="layui-form-item">
                        <label class="layui-form-label">搜索引擎</label>
                        <div class="layui-input-block">
                            <select id="searchList" name="searchEngine"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left padding-ten-right">
                    <div class="layui-form-item">
                        <label class="layui-form-label">熊掌号</label>
                        <div class="layui-input-block">
                            <input type="text" name="bearPawNumber" placeholder="请输入熊掌号" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left">
                    <div class="layui-form-item">
                        <label class="layui-form-label">标签</label>
                        <div class="layui-input-block">
                            <input type="text" name="tagNames" placeholder="例如MBA,算法,每个词用逗号隔开" autocomplete="off" class="layui-input" lay-verify="tagNames">
                        </div>
                    </div>
                </div>
            </div>
            <fieldset class="layui-elem-field layui-field-title">
                <legend>站点基本信息</legend>
            </fieldset>
            <div class="layui-row">
                <div class="layui-col-md6 padding-ten-right">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">电脑</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="computer" lay-skin="switch" lay-filter="computer" lay-text="选中|不选中">
                        </div>
                    </div>
                    <div id="comQzsettingBoxSelect" style="display: none" class="layui-form-item"
                         pane>
                        <label class="computer layui-form-label">达标优化类型</label>
                        <div class="layui-input-block">
                            <input type="radio" name="optimizationComType" lay-filter="optimizationComType" value="1" title="主优化" class="computer-input" checked>
                            <input type="radio" name="optimizationComType" lay-filter="optimizationComType" value="2" title="次优化" class="computer-input">
                            <input type="radio" name="optimizationComType" lay-filter="optimizationComType" value="0" title="辅助优化" class="computer-input">
                        </div>
                    </div>
                    <div id="comQzsettingBox" style="display: none" class="qzsetting-box">
                        <div class="layui-row">
                            <div class="layui-col-md6 padding-ten-right">
                                <div class="layui-form-item">
                                    <label class="computer layui-form-label">优化分组</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="pcGroup" placeholder="请输入分组" autocomplete="off" class="computer-input layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="computer layui-form-label">初始首页词数</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="comCurrentKeywordCount" placeholder="请输入初始首页词数" autocomplete="off" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="computer-input layui-input">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6 padding-ten-left">
                                <div class="layui-form-item">
                                    <label class="computer layui-form-label">电脑域名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="comSubDomainName" placeholder="请输入电脑域名" autocomplete="off" class="computer-input layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="computer layui-form-label">采词词数限制</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="comMaxKeywordCount" placeholder="请输入采词词数限制" autocomplete="off" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="computer-input layui-input" value="300">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="computer layui-form-label">达标备注</label>
                            <div class="layui-input-block">
                                <input type="text" name="comMonitorRemark" placeholder="请填写电脑端达标备注, 如：首月30-50个词 客供词 3000" autocomplete="off" class="computer-input layui-input">
                            </div>
                        </div>
                        <div id="comStandardSpecies" class="layui-form-item" pane>
                            <label class="computer layui-form-label">达标种类</label>
                            <div class="layui-input-block">
                                <input type="radio" name="comStandardSpecies" value="aiZhan" title="爱站" lay-filter="comStandardSpecies" class="computer-input" checked>
                                <input type="radio" name="comStandardSpecies" value="5118" title="5118" lay-filter="comStandardSpecies" class="computer-input">
                                <input type="radio" name="comStandardSpecies" value="designationWord" title="指定词" lay-filter="comStandardSpecies" class="computer-input">
                                <input type="radio" name="comStandardSpecies" value="other" title="其他" lay-filter="comStandardSpecies" class="computer-input">
                            </div>
                        </div>
                        <div>
                            <div id="computerTable" class="layui-form-item">
                                <table border="0" width="100%" class="computer">
                                    <tbody id="computerTbody">
                                    <tr class="my-bg">
                                        <td colspan="3">
                                            <div id="computerTitle" class="my-header-title my-label my-padding">
                                                爱站收费规则
                                            </div>
                                        </td>
                                        <td colspan="2">
                                            <div class="my-header-btn my-label">
                                                <button onclick="appendTable(true)" type="button" class="layui-btn layui-btn-sm">
                                                    增加收费规则
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="my-bg">
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                达标阶段
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                起始达标词数
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                终止达标词数
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                电脑端价格
                                            </div>
                                        </td>
                                        <td>
                                            <div
                                                class="my-label my-left my-padding my-bottom">
                                                操作
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                1
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-btn my-left my-bottom">
                                                <button type="button" onclick="removeElement(this)" class="layui-btn layui-btn-xs layui-btn-danger">
                                                    删除
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md6 padding-ten-left">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">手机</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="phone" lay-skin="switch" lay-filter="phone" lay-text="选中|不选中">
                        </div>
                    </div>
                    <div id="phoneQzsettingBoxSelect" style="display: none" class="layui-form-item"
                         pane>
                        <label class="phone layui-form-label">达标优化类型</label>
                        <div class="layui-input-block">
                            <input type="radio" name="optimizationPhoneType" lay-filter="optimizationPhoneType" value="1" title="主优化" class="phone-input" checked>
                            <input type="radio" name="optimizationPhoneType" lay-filter="optimizationPhoneType" value="2" title="次优化" class="phone-input">
                            <input type="radio" name="optimizationPhoneType" lay-filter="optimizationPhoneType" value="0" title="辅助优化" class="phone-input">
                        </div>
                    </div>
                    <div id="phoneQzsettingBox" style="display: none" class="qzsetting-box">
                        <div class="layui-row">
                            <div class="layui-col-md6 padding-ten-right">
                                <div class="layui-form-item">
                                    <label class="phone layui-form-label">优化分组</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="phoneGroup" placeholder="请输入分组" autocomplete="off" class="phone-input layui-input">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="phone layui-form-label">初始首页词数</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="phoneCurrentKeywordCount" placeholder="请输入初始首页词数" autocomplete="off" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="phone-input layui-input">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6 padding-ten-left">
                                <div class="layui-form-item">
                                    <label class="phone layui-form-label">手机域名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="phoneSubDomainName" placeholder="请输入手机域名" autocomplete="off" class="phone-input layui-input">
                                    </div>
                                </div>
                                <div class="phone layui-form-item">
                                    <label class="layui-form-label">采词词数限制</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="phoneMaxKeywordCount" placeholder="请输入采词词数限制" autocomplete="off" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="phone-input layui-input" value="300">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="phone layui-form-label">达标备注</label>
                            <div class="layui-input-block">
                                <input type="text" name="phoneMonitorRemark" placeholder="请填写手机端达标备注, 如：首月30-50个词 客供词 3000" autocomplete="off" class="phone-input layui-input">
                            </div>
                        </div>
                        <div id="phoneStandardSpecies" class="layui-form-item" pane>
                            <label class="phone layui-form-label">达标种类</label>
                            <div class="layui-input-block">
                                <input type="radio" name="phoneStandardSpecies" value="aiZhan" title="爱站" lay-filter="phoneStandardSpecies" class="phone-input" checked>
                                <input type="radio" name="phoneStandardSpecies" value="5118" title="5118" lay-filter="phoneStandardSpecies" class="phone-input">
                                <input type="radio" name="phoneStandardSpecies" value="designationWord" title="指定词" lay-filter="phoneStandardSpecies" class="phone-input">
                                <input type="radio" name="phoneStandardSpecies" value="other" title="其他" lay-filter="phoneStandardSpecies" class="phone-input">
                            </div>
                        </div>
                        <div>
                            <div id="phoneTable" class="layui-form-item">
                                <table border="0" width="100%" class="phone">
                                    <tbody id="phoneTbody">
                                    <tr class="my-bg">
                                        <td colspan="3">
                                            <div id="phoneTitle"
                                                 class="my-header-title my-label my-padding">
                                                爱站收费规则
                                            </div>
                                        </td>
                                        <td colspan="2">
                                            <div class="my-header-btn my-label">
                                                <button onclick="appendTable(false)" type="button"
                                                        class="layui-btn layui-btn-sm">
                                                    增加收费规则
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="my-bg">
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                达标阶段
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                起始达标词数
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                终止达标词数
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                手机端价格
                                            </div>
                                        </td>
                                        <td>
                                            <div
                                                class="my-label my-left my-padding my-bottom">
                                                操作
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="my-label my-left my-padding">
                                                1
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-left">
                                                <input type="text" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')" class="layui-input my-input">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="my-label my-btn my-left my-bottom">
                                                <button type="button" onclick="removeElement(this)" class="layui-btn layui-btn-xs layui-btn-danger">
                                                    删除
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <#if (organizationName == '运营部' || organizationName == '技术部')>
            <fieldset class="layui-elem-field layui-field-title">
                <legend>采词规则</legend>
            </fieldset>
            <div class="layui-row four-row">
                <div class="layui-col-md3 padding-ten-right">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">自动采词</label>
                        <div class="layui-input-block">
                            <!--<input type="radio" name="autoCrawlKeywordFlag" lay-filter="autoCrawlKeywordFlag" value="true" title="是" lay-skin="primary">
                            <input type="radio" name="autoCrawlKeywordFlag" lay-filter="autoCrawlKeywordFlag" value="false" title="否" lay-skin="primary" checked>-->
                            <input type="radio" name="autoCrawlKeywordFlag" lay-filter="autoCrawlKeywordFlag" value="false" title="否" lay-skin="primary" checked>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left padding-ten-right">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">采词来源</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="terminalType[PC]" lay-skin="primary" title="电脑" value="PC">
                            <input type="checkbox" name="terminalType[Phone]" lay-skin="primary" title="手机" value="Phone">
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left padding-ten-right">
                    <div class="layui-form-item">
                        <label class="layui-form-label">更新间隔</label>
                        <div class="layui-input-block">
                            <select name="updateInterval">
                                <option value="7">7天</option>
                                <option value="15" selected>15天</option>
                                <option value="30">30天</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3 padding-ten-left">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label" style="width: 110px">过滤规则</label>
                        <div class="layui-input-block" style="margin-left: 110px">
                            <input type="checkbox" name="filterRule[ignoreNoIndex]" lay-skin="primary" title="去掉没指数" checked>
                            <input type="checkbox" name="filterRule[ignoreNoOrder]" lay-skin="primary" title="去掉没排名" checked>
                        </div>
                    </div>
                </div>
            </div>
            </#if>
    </div>
<div style="height: 58px;"></div>
<div style="position: fixed;bottom: 0;width: 100%;background:#fff;text-align: right;">
    <div style="margin: 0 10px 6px 10px; padding-top: 8px;border-top: solid 1px #e6e6e6">
        <button class="layui-btn" lay-submit lay-filter="commitQZSetting">确定</button>
        <button type="reset" class="layui-btn layui-btn-primary" onclick="resetHidden()">
            重置
        </button>
        <button class="layui-btn layui-btn-primary" id="close" style="margin-right: 20px">
            取消
        </button>
    </div>
</div>
</form>
</div>
<!--js逻辑-->
<script src="/static/ok-admin/lib/layui/layui.js"></script>
<script src="/static/ok-admin/js/somePublic.js"></script>
<script>
    let uuid_ = null;
    let layui_ = null;
    let flag_ = true;

    /**
     * 供上方调用
     * 初始化数据使用
     */
    function initForm(data) {
        uuid_ = data;
        selectPhone();
        selectComputer();
        if (layui_ != null) {
            setForm(layui_, uuid_);
        }
    }

    function initForm2(isSEOSales) {
        if (isSEOSales === '1') {
            initRenewalStatus('2');
        } else {
            initRenewalStatus('4');
        }
    }

    /**
     * 初始化数据
     * @param l layui对象
     * @param u 需要修改的站点uuid
     */
    function setForm(l, u) {
        l.jquery.ajax({
            url: '/internal/qzsetting/getQZSettingsMsg/' + u,
            type: 'get',
            dataType: 'json',
            success: function (res) {
                if (res.code === 200) {
                    let d = res.data, d_n = {};
                    // 初始化续费状态
                    initRenewalStatus(d.renewalStatus + '');
                    // 初始化用户列表和搜索引擎下拉框
                    getInitData({
                            uuid: d.customerUuid,
                            contactPerson: d.contactPerson
                        },
                        d.searchEngine);
                    d_n['filterRule[ignoreNoIndex]'] = d.ignoreNoIndex; //去掉没指数
                    d_n['filterRule[ignoreNoOrder]'] = d.ignoreNoOrder;//去掉没排名
                    d_n['terminalType[PC]'] = exist(d.captureTerminalType, 'PC'); //电脑终端
                    d_n['terminalType[Phone]'] = exist(d.captureTerminalType, 'Phone');//手机终端
                    d_n.uuid = d.uuid; //uuid
                    d_n.domain = d.domain; //域名
                    d_n.tagNames = listToStr(d.qzCategoryTags); //标签
                    d_n.bearPawNumber = d.bearPawNumber; //熊掌号
                    d_n.updateInterval = d.updateInterval; //更新间隔
                    d_n.autoCrawlKeywordFlag = d.autoCrawlKeywordFlag ? 'true' : 'false'; //自动采词
                    d_n.computer = false; //电脑开关
                    d_n.phone = false; //手机开关
                    for (let i = 0; i < d.qzOperationTypes.length; i++) {
                        switch (d.qzOperationTypes[i].operationType) {
                            case "PC":
                                deselectPhone();
                                d_n.computer = true;
                                d_n.optimizationComType = d.qzOperationTypes[i].optimizationType;
                                if (d_n.optimizationComType === 0) {
                                    selectPhone(true);
                                    computerTableFlag = false;
                                }
                                d_n.pcGroup = d.qzOperationTypes[i].group;
                                d_n.comSubDomainName = d.qzOperationTypes[i].subDomainName;
                                d_n.comCurrentKeywordCount = d.qzOperationTypes[i].currentKeywordCount;
                                d_n.comMaxKeywordCount = d.qzOperationTypes[i].maxKeywordCount;
                                d_n.comMonitorRemark = d.qzOperationTypes[i].monitorRemark;
                                let html_c = listToHtml(d.qzOperationTypes[i].qzChargeRules);
                                if (html_c !== '') {
                                    d_n.comStandardSpecies = d.qzOperationTypes[i].qzChargeRules[0].standardSpecies;
                                    if (d.renewalStatus !== 4 && d_n.comStandardSpecies !== 'other') {
                                        html_c = getHeader(d_n.comStandardSpecies, true) + html_c;
                                        document.getElementById('computerTbody').innerHTML = html_c;
                                    }
                                }
                                if (d_n.comStandardSpecies === 'other') {
                                    computerTable.style.display = 'none';
                                    computerTableFlag = false;
                                }
                                break;
                            case "Phone":
                                deselectComputer();
                                d_n.phone = true;
                                d_n.optimizationPhoneType = d.qzOperationTypes[i].optimizationType;
                                if (d_n.optimizationPhoneType === 0) {
                                    selectComputer(true);
                                    phoneTableFlag = false;
                                }
                                d_n.phoneGroup = d.qzOperationTypes[i].group;
                                d_n.phoneSubDomainName = d.qzOperationTypes[i].subDomainName;
                                d_n.phoneCurrentKeywordCount = d.qzOperationTypes[i].currentKeywordCount;
                                d_n.phoneMaxKeywordCount = d.qzOperationTypes[i].maxKeywordCount;
                                d_n.phoneMonitorRemark = d.qzOperationTypes[i].monitorRemark;
                                let html_p = listToHtml(d.qzOperationTypes[i].qzChargeRules);
                                if (html_p !== '') {
                                    d_n.phoneStandardSpecies = d.qzOperationTypes[i].qzChargeRules[0].standardSpecies;
                                    if (d.renewalStatus !== 4 && d_n.phoneStandardSpecies !== 'other') {
                                        html_p = getHeader(d_n.phoneStandardSpecies, false) + html_p;
                                        document.getElementById('phoneTbody').innerHTML = html_p;
                                    }
                                }
                                if (d_n.phoneStandardSpecies === 'other') {
                                    phoneTable.style.display = 'none';
                                    phoneTableFlag = false;
                                }
                                break;
                            default:
                                break;
                        }
                    }
                    l.form.val("addQZSetting", d_n);
                    flag_ = false;
                } else {
                    l.common.showFailMsg('数据获取失败');
                }
            }
        });
    }

    window.initRenewalStatus = function (s) {
        let siteStatus = document.getElementById('siteStatus');
        siteStatus.value = s;
        let siteStatusDiv = document.getElementById('siteStatusDiv');
        siteStatusDiv.classList.add('my-text');
        switch (s) {
            case '1':
                siteStatusDiv.style.color = 'green';
                siteStatusDiv.innerHTML = '续费中';
                break;
            case '0':
                siteStatusDiv.style.color = 'palevioletred';
                siteStatusDiv.innerHTML = '暂停续费';
                break;
            case '2':
                siteStatusDiv.style.color = 'mediumseagreen';
                siteStatusDiv.innerHTML = '首次收费';
                break;
            case '3':
                siteStatusDiv.style.color = 'red';
                siteStatusDiv.innerHTML = '下架';
                break;
            case '4':
                siteStatusDiv.style.color = 'mediumseagreen';
                siteStatusDiv.innerHTML = '其他';
                computerTable.innerHTML = '';
                phoneTable.innerHTML = '';
                break;
            default:
                break;
        }
    };

    function exist(s, v) {
        if (s) {
            return s.indexOf(v) >= 0;
        }
        return false;
    }

    function listToStr(l) {
        let str = '';
        for (let i = 0; i < l.length; i++) {
            str += l[i].tagName;
            if (i !== l.length - 1) {
                str += ','
            }
        }
        return str;
    }

    function listToHtml(l) {
        let html = '';
        if (l) {
            for (let j = 0; j < l.length; j++) {
                html += '<tr>\n                                    <td>\n                                        <div class="my-label my-left my-padding">';
                html += (j + 1);
                html += '</div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input" value="';
                html += l[j].startKeywordCount;
                html += '">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input" value="';
                html += l[j].endKeywordCount === null ? '' : l[j].endKeywordCount;
                html += '">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left">\n                                            <input type="text" onkeyup="value=value.replace(/^(0+)|[^\\d]+/g,\'\')" class="layui-input my-input" value="';
                html += l[j].amount;
                html += '">\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-btn my-left my-bottom">\n                                            <button type="button" onclick="removeElement(this)"\n                                                    class="layui-btn layui-btn-xs layui-btn-danger">\n                                                删除\n                                            </button>\n                                        </div>\n                                    </td>\n                                </tr>';
            }
        }
        return html;
    }

    function getHeader(v, f) {
        let header_ = '<tr class="my-bg">\n                                    <td colspan="3">';
        if (f) {
            header_ += '<div id="computerTitle"\n                                             class="my-header-title my-label my-padding">';
        } else {
            header_ += '<div id="phoneTitle"\n                                             class="my-header-title my-label my-padding">';
        }
        switch (v) {
            case 'aiZhan':
                header_ += '爱站收费规则';
                break;
            case '5118':
                header_ += '5118收费规则';
                break;
            case 'designationWord':
                header_ += '指定词收费规则';
                break;
            case 'other':
                header_ += '其他收费规则';
                break;
            default:
                break;
        }
        header_ += '</div>\n                                    </td>\n                                    <td colspan="2">\n                                        <div class="my-header-btn my-label">';
        if (f) {
            header_ += '<button onclick="appendTable(true)" type="button"\n                                                    class="layui-btn layui-btn-sm">\n                                                增加收费规则\n                                            </button>';
        } else {
            header_ += '<button onclick="appendTable(false)" type="button"\n                                                    class="layui-btn layui-btn-sm">\n                                                增加收费规则\n                                            </button>';
        }
        header_ += '</div>\n                                    </td>\n                                </tr>\n                                <tr class="my-bg">\n                                    <td>\n                                        <div class="my-label my-left my-padding">\n                                            达标阶段\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left my-padding">\n                                            起始达标词数\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left my-padding">\n                                            终止达标词数\n                                        </div>\n                                    </td>\n                                    <td>\n                                        <div class="my-label my-left my-padding">';
        if (f) {
            header_ += '电脑端价格';
        } else {
            header_ += '手机端价格';
        }
        header_ += '</div>\n                                    </td>\n                                    <td>\n                                        <div\n                                            class="my-label my-left my-padding my-bottom">\n                                            操作\n                                        </div>\n                                    </td>\n                                </tr>';
        return header_;
    }

    let tbody_com = null;
    let tbody_phone = null;
    // 初始时是否需要隐藏收费表
    let computerTableFlag = true;
    let phoneTableFlag = true;

    let comQzsettingBoxSelect = document.getElementById('comQzsettingBoxSelect');
    let comQzsettingBox = document.getElementById('comQzsettingBox');
    let comStandardSpecies = document.getElementById('comStandardSpecies');
    let computerTable = document.getElementById('computerTable');

    function selectPhone(f) {
        if (f) {
            comStandardSpecies.style.display = 'none';
            if (computerTableFlag) {
                computerTable.style.display = 'none';
            }
        } else {
            comQzsettingBox.style.display = 'none';
            comQzsettingBoxSelect.style.display = 'none';
        }
    }

    function deselectPhone(f) {
        if (f) {
            comStandardSpecies.style.display = 'block';
            if (computerTableFlag) {
                computerTable.style.display = 'block';
            }
        } else {
            comQzsettingBox.style.display = 'block';
            comQzsettingBoxSelect.style.display = 'block';
        }
    }

    let phoneQzsettingBoxSelect = document.getElementById('phoneQzsettingBoxSelect');
    let phoneQzsettingBox = document.getElementById('phoneQzsettingBox');
    let phoneStandardSpecies = document.getElementById('phoneStandardSpecies');
    let phoneTable = document.getElementById('phoneTable');

    function selectComputer(f) {
        if (f) {
            phoneStandardSpecies.style.display = 'none';
            if (phoneTableFlag) {
                phoneTable.style.display = 'none';
            }
        } else {
            phoneQzsettingBox.style.display = 'none';
            phoneQzsettingBoxSelect.style.display = 'none';
        }
    }

    function deselectComputer(f) {
        if (f) {
            phoneStandardSpecies.style.display = 'block';
            if (phoneTableFlag) {
                phoneTable.style.display = 'block';
            }
        } else {
            phoneQzsettingBox.style.display = 'block';
            phoneQzsettingBoxSelect.style.display = 'block';
        }
    }

    layui.use(["form", "jquery", "common"], function () {
        let form = layui.form;
        let $ = layui.jquery;
        let common = layui.common;

        if (uuid_ != null) {
            setForm(layui, uuid_);
        } else {
            layui_ = layui;
        }

        window.getInitData = function (a, b) {
            b = b === undefined ? '百度' : b;
            if (flag_) {
                $.ajax({
                    url: '/internal/qzsetting/getSaveQZSettingsMsg',
                    type: 'get',
                    dataType: 'json',
                    success: function (res) {
                        if (res.code === 200) {
                            let customerList = document.getElementById('customerList');
                            let searchList = document.getElementById('searchList');
                            let html_c = '<option value="">请选择</option>';
                            if (a) {
                                html_c += '<option value="';
                                html_c += a.uuid;
                                html_c += '" selected>';
                                html_c += a.contactPerson;
                                html_c += '</option>';
                                customerList.setAttribute('disabled', '');
                            } else {
                                let customers = res.data.customers;
                                let l = customers.length;
                                for (let i = 0; i < l; i++) {
                                    html_c += '<option value="';
                                    html_c += customers[i].uuid;
                                    html_c += '">';
                                    html_c += customers[i].contactPerson;
                                    html_c += '</option>';
                                }
                            }
                            let html_s = '';
                            let search = res.data.search;
                            for (let item in res.data.search) {
                                html_s += '<option value="';
                                html_s += item + '"';
                                if (item === b) {
                                    html_s += 'selected';
                                }
                                html_s += '>';
                                html_s += search[item];
                                html_s += '</option>';
                            }
                            customerList.innerHTML = html_c;
                            searchList.innerHTML = html_s;
                            form.render('select');
                            if (a) {
                                let customerInput = customerList.nextElementSibling.children[0].children[0];
                                customerInput.classList.remove('layui-disabled');
                                customerInput.setAttribute('disabled', '');
                            }
                        } else {
                            common.showFailMsg('数据获取失败');
                        }
                    }
                });
            }
        };

        tbody_com = $('#computerTbody');
        tbody_phone = $('#phoneTbody');

        //监听指定开关
        form.on('switch(computer)', function (data) {
            if (this.checked) {
                deselectPhone(false);
            } else {
                selectPhone(false);
            }
            // layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
        });

        //监听指定开关
        form.on('switch(phone)', function (data) {
            if (this.checked) {
                deselectComputer(false);
            } else {
                selectComputer(false);
            }
        });

        //监听指定radio
        form.on('radio(optimizationComType)', function (data) {
            switch (data.value) {
                case '1':
                    deselectPhone(true);
                    break;
                case '2':
                    deselectPhone(true);
                    break;
                case '0':
                    selectPhone(true);
                    break;
                default:
                    selectPhone(true);
                    break;
            }
        });

        //监听指定radio
        form.on('radio(optimizationPhoneType)', function (data) {
            switch (data.value) {
                case '1':
                    deselectComputer(true);
                    break;
                case '2':
                    deselectComputer(true);
                    break;
                case '0':
                    selectComputer(true);
                    break;
                default:
                    selectComputer(true);
                    break;
            }
        });

        form.on('radio(autoCrawlKeywordFlag)', function (data) {
            if (data.value === "false") {
                $("div.ok-body").find("input[name='terminalType[PC]']")[0].checked = false;
                $("div.ok-body").find("input[name='terminalType[Phone]']")[0].checked = false;
                form.render('checkbox');
            }
        });

        let name = '收费规则';

        //监听指定radio
        form.on('radio(comStandardSpecies)', function (data) {
            let computerTitle = document.getElementById('computerTitle');
            if (computerTitle) {
                computerTableFlag = true;
                switch (data.value) {
                    case 'aiZhan':
                        computerTitle.innerHTML = '爱站' + name;
                        computerTable.style.display = 'block';
                        break;
                    case '5118':
                        computerTitle.innerHTML = '5118' + name;
                        computerTable.style.display = 'block';
                        break;
                    case 'designationWord':
                        computerTitle.innerHTML = '指定词' + name;
                        computerTable.style.display = 'block';
                        break;
                    case 'other':
                        computerTableFlag = false;
                        computerTable.style.display = 'none';
                        break;
                    default:
                        break;
                }
            }
        });

        //监听指定radio
        form.on('radio(phoneStandardSpecies)', function (data) {
            let phoneTitle = document.getElementById('phoneTitle');
            if (phoneTitle) {
                phoneTableFlag = true;
                switch (data.value) {
                    case 'aiZhan':
                        phoneTitle.innerHTML = '爱站' + name;
                        phoneTable.style.display = 'block';
                        break;
                    case '5118':
                        phoneTitle.innerHTML = '5118' + name;
                        phoneTable.style.display = 'block';
                        break;
                    case 'designationWord':
                        phoneTitle.innerHTML = '指定词' + name;
                        phoneTable.style.display = 'block';
                        break;
                    case 'other':
                        // phoneTitle.innerHTML = '其他' + name;
                        phoneTableFlag = false;
                        phoneTable.style.display = 'none';
                        break;
                    default:
                        break;
                }
            }
        });

        form.on("submit(commitQZSetting)", function (data) {
            let d = common.jsonObjectTrim(data.field), p_d = {};
            if (!((d.computer === 'on' && d.optimizationComType === '1') || (d.phone === 'on'
                && d.optimizationPhoneType === '1'))) {
                common.showFailMsg('必须选择电脑或手机中至少一个且至少拥有一个主优化');
                return false;
            }
            p_d.autoCrawlKeywordFlag = d.autoCrawlKeywordFlag;
            if (d.bearPawNumber.trim() !== '') {
                p_d.bearPawNumber = d.bearPawNumber;
            }
            p_d.customerUuid = d.customerUuid;
            p_d.renewalStatus = d.siteStatus;
            p_d.domain = d.domain;
            p_d.ignoreNoIndex = d['filterRule[ignoreNoIndex]'] === 'on';
            p_d.ignoreNoOrder = d['filterRule[ignoreNoOrder]'] === 'on';
            let captureTerminalType = '';
            if (d['terminalType[PC]']) {
                captureTerminalType += d['terminalType[PC]'];
            }
            if (d['terminalType[Phone]']) {
                if (captureTerminalType === '') {
                    captureTerminalType += d['terminalType[Phone]'];
                } else {
                    captureTerminalType += ',';
                    captureTerminalType += d['terminalType[Phone]'];
                }
            }
            if (p_d.autoCrawlKeywordFlag === "true" && captureTerminalType === "") {
                common.showFailMsg('请选择要自动采词的终端');
                return false;
            }
            if (captureTerminalType !== '') {
                p_d.captureTerminalType = captureTerminalType;
            }
            p_d.pcGroup = d.pcGroup;
            p_d.phoneGroup = d.phoneGroup;
            p_d.searchEngine = d.searchEngine;
            p_d.updateInterval = d.updateInterval;
            p_d.type = 'qz';
            p_d.uuid = d.uuid;

            let qzCategoryTags = [];
            if (d.tagNames.trim() !== '') {
                let tagNames = d.tagNames.split(',');
                for (let item in tagNames) {
                    let a = {};
                    a.tagName = tagNames[item];
                    qzCategoryTags.push(a);
                }
            }
            p_d.qzCategoryTags = qzCategoryTags;

            let qzOperationTypes = [];
            if (d.computer === 'on') {
                if (d.pcGroup === '' || d.comMaxKeywordCount === '' || d.comSubDomainName === '') {
                    common.showFailMsg('电脑端基本信息中信息未填写完全');
                    return false;
                }
                let b = {};
                b.currentKeywordCount = d.comCurrentKeywordCount;
                b.group = d.pcGroup;
                b.maxKeywordCount = d.comMaxKeywordCount;
                b.monitorRemark = d.comMonitorRemark;
                b.operationType = 'PC';
                b.optimizationType = d.optimizationComType;
                b.standardType = 'satisfyAll';
                b.subDomainName = d.comSubDomainName;
                let qzChargeRules = [], comTr = tbody_com.children('tr');
                if (d.optimizationComType !== '0' && d.comStandardSpecies !== 'other') {
                    if (d.siteStatus === '4') {
                        let c = {};
                        c.standardSpecies = d.comStandardSpecies;
                        c.startKeywordCount = '1';
                        c.endKeywordCount = '2';
                        c.amount = '3';
                        qzChargeRules.push(c);
                    } else {
                        let last_standard_value = 0;
                        for (let i = 2; i < comTr.length; i++) {
                            let comTd = comTr[i].children, c = {};
                            c.standardSpecies = d.comStandardSpecies;
                            if (last_standard_value >= parseInt(comTd[1].children[0].children[0].value)) {
                                common.showFailMsg('电脑达标规则填写错误');
                                return false;
                            }
                            if (parseInt(comTd[1].children[0].children[0].value) >= parseInt(comTd[2].children[0].children[0].value)) {
                                common.showFailMsg('电脑达标规则终止达标词数要大于起始达标词数');
                                return false;
                            }
                            for (let j = 1; j < 4; j++) {
                                if (comTd[j].children[0].children[0].value === '') {
                                    if (!(i === comTr.length - 1 && j === 2)) {
                                        common.showFailMsg('电脑端基本信息表必须填写完整');
                                        return false;
                                    }
                                }
                                switch (j) {
                                    case 1:
                                        c.startKeywordCount = comTd[j].children[0].children[0].value;
                                        break;
                                    case 2:
                                        c.endKeywordCount = comTd[j].children[0].children[0].value;
                                        last_standard_value = parseInt(c.endKeywordCount);
                                        break;
                                    case 3:
                                        c.amount = comTd[j].children[0].children[0].value;
                                        break;
                                    default:
                                        break;
                                }
                            }
                            qzChargeRules.push(c);
                        }
                    }
                } else {
                    let c = {};
                    c.standardSpecies = 'other';
                    c.startKeywordCount = '1';
                    c.endKeywordCount = '2';
                    c.amount = '3';
                    qzChargeRules.push(c);
                }
                b.qzChargeRules = qzChargeRules;
                qzOperationTypes.push(b);
            }else {
                p_d.pcGroup = null;
            }
            if (d.phone === 'on') {
                if (d.phoneGroup === '' || d.phoneMaxKeywordCount === '' || d.phoneSubDomainName
                    === '') {
                    common.showFailMsg('手机端基本信息中信息未填写完全');
                    return false;
                }
                let b = {};
                b.currentKeywordCount = d.phoneCurrentKeywordCount;
                b.group = d.phoneGroup;
                b.maxKeywordCount = d.phoneMaxKeywordCount;
                b.monitorRemark = d.phoneMonitorRemark;
                b.operationType = 'Phone';
                b.optimizationType = d.optimizationPhoneType;
                b.standardType = 'satisfyAll';
                b.subDomainName = d.phoneSubDomainName;
                let qzChargeRules = [], phoneTr = tbody_phone.children('tr');
                if (d.optimizationPhoneType !== '0' && d.phoneStandardSpecies !== 'other') {
                    if (d.siteStatus === '4') {
                        let c = {};
                        c.standardSpecies = d.phoneStandardSpecies;
                        c.startKeywordCount = '1';
                        c.endKeywordCount = '2';
                        c.amount = '3';
                        qzChargeRules.push(c);
                    } else {
                        let last_standard_value = 0;
                        for (let i = 2; i < phoneTr.length; i++) {
                            let phoneTd = phoneTr[i].children, c = {};
                            c.standardSpecies = d.phoneStandardSpecies;
                            if (last_standard_value >= parseInt(phoneTd[1].children[0].children[0].value)) {
                                common.showFailMsg('手机达标规则填写错误');
                                return false;
                            }
                            if (parseInt(phoneTd[1].children[0].children[0].value) >= parseInt(phoneTd[2].children[0].children[0].value)) {
                                common.showFailMsg('手机达标规则终止达标词数要大于起始达标词数');
                                return false;
                            }
                            for (let j = 1; j < 4; j++) {
                                if (phoneTd[j].children[0].children[0].value === '') {
                                    if (!(i === phoneTr.length - 1 && j === 2)) {
                                        common.showFailMsg('手机端基本信息表必须填写完整');
                                        return false;
                                    }
                                }
                                switch (j) {
                                    case 1:
                                        c.startKeywordCount = phoneTd[j].children[0].children[0].value;
                                        break;
                                    case 2:
                                        c.endKeywordCount = phoneTd[j].children[0].children[0].value;
                                        last_standard_value = parseInt(c.endKeywordCount);
                                        break;
                                    case 3:
                                        c.amount = phoneTd[j].children[0].children[0].value;
                                        break;
                                    default:
                                        break;
                                }
                            }
                            qzChargeRules.push(c);
                        }
                    }
                } else {
                    let c = {};
                    c.standardSpecies = 'other';
                    c.startKeywordCount = '1';
                    c.endKeywordCount = '2';
                    c.amount = '3';
                    qzChargeRules.push(c);
                }
                b.qzChargeRules = qzChargeRules;
                qzOperationTypes.push(b);
            }else {
                p_d.phoneGroup = null;
            }
            p_d.qzOperationTypes = qzOperationTypes;
            commit(p_d, function (init) {});
            return false;
        });

        function commit(p_d, call) {
            if (!common.waitMoment()) {
                return false;
            }
            $.ajax({
                url: '/internal/qzsetting/saveQZSetting',
                type: 'post',
                data: JSON.stringify(p_d),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                success: function (res) {
                    if (res.code === 200) {
                        if (res.data) {
                            call(res.data);
                        }
                        common.showSuccessMsg("保存成功", function () {
                            parent.window.sign = true;
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        });
                    } else {
                        common.showFailMsg('保存失败');
                    }
                },
                error: function () {
                    common.showFailMsg('网络异常请稍后再试');
                }
            });
        }

        window.removeElement = function (e) {
            let m = e.parentElement.parentElement.parentElement;
            let p = m.parentElement;
            if (p.children.length <= 3) {
                common.showFailMsg("收费规则必须拥有一条记录");
                return;
            }
            p.removeChild(m);
        }

        $('#close').click(function () {
            parent.layer.close(parent.layer.getFrameIndex(window.name));
        });

        form.verify({
            domain: [
                /^([a-z0-9]*)\.*([\u4e00-\u9fa50-9]+|[a-z0-9]+)\.([\u4e00-\u9fa5]+|[a-z]+|ac.cn|bj.cn|sh.cn|tj.cn|cq.cn|he.cn|sn.cn|sx.cn|nm.cn|ln.cn|jl.cn|hl.cn|js.cn|zj.cn|ah.cn|fj.cn|jx.cn|sd.cn|ha.cn|hb.cn|hn.cn|gd.cn|gx.cn|hi.cn|sc.cn|gz.cn|yn.cn|gs.cn|qh.cn|nx.cn|xj.cn|tw.cn|hk.cn|mo.cn|xz.cn|com.cn|net.cn|org.cn|gov.cn|.com.hk)$/,
                "请正确输入域名"
            ],
            tagNames: [
                /(^$)|(^[\u4e00-\u9fa50-9a-zA-Z,]+$)/,
                "请正确输入标签,例如：阿卡索,MBA,算法"
            ]
        });
    });
</script>
</body>
</html>
