<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.UserDao">
	<sql id="colID">
		u.fUserID AS 'userID',
		  u.fUserName AS 'userName',
		  u.fPassword AS 'password',
		  u.fGender AS 'gender',
		  u.fQQ AS 'qq',
		  u.fUserLevel AS 'userLevel',
		  u.fSalt AS 'salt',
		  u.fVipType AS 'vipType',
		  u.fClientIp AS 'clientIp',
		  u.fStatus AS 'status',
		  u.fUpdateTime AS 'updateTime',
		  u.fCreateTime AS 'createTime'
	</sql>

	<select id="getUser" resultType="com.keymanager.monitoring.entity.User">
		SELECT
		  <include refid="colID"/>
		FROM t_user u
		WHERE
			u.fUserID = #{userID}
		AND u.fStatus = 1
	</select>

	<select id="findActiveUsers" resultType="com.keymanager.monitoring.entity.User">
		SELECT
		<include refid="colID"/>
		FROM
		t_user u
		WHERE u.fStatus = 1
	</select>

	<!--shiro-->
	<resultMap id="userVoResultMap" type="com.keymanager.monitoring.vo.UserVO">
		<id column="userUuid" property="userUuid" jdbcType="BIGINT"/>
		<result column="login_name" property="loginName" jdbcType="VARCHAR"/>
		<result column="userName" property="userName" jdbcType="VARCHAR"/>
		<result column="password" property="password" jdbcType="VARCHAR"/>
		<result column="sex" property="sex" jdbcType="TINYINT"/>
		<result column="age" property="age" jdbcType="TINYINT"/>
		<result column="user_type" property="userType" jdbcType="TINYINT"/>
		<result column="status" property="status" jdbcType="TINYINT"/>
		<result column="organization_id" property="organizationID" jdbcType="INTEGER"/>
		<result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
		<result column="phone" property="phone" jdbcType="VARCHAR"/>

		<result column="organizationName" property="organizationName" jdbcType="VARCHAR"/>

		<collection property="rolesList" ofType="Role">
			<id column="fUuid" property="roleId"/>
			<result column="roleName" property="roleName"/>
		</collection>
	</resultMap>

	<select id="selectUserVoById" resultMap="userVoResultMap" parameterType="java.lang.Long">
		SELECT
		u.fUuid AS `userUuid`,
		u.fLoginName AS `loginName`,
		u.fUserName AS `userName`,
		u.fPassword AS `password`,
		u.fGender AS `sex`,
		u.fPercentage AS `age`,
		u.fVipType AS `userType`,
		u.fStatus AS `status`,
		u.fOrganizationID AS `organizationID`,
		u.fPhone AS `phone`,
		u.fcreateTime AS `createTime`,
		og.fOrganizationName AS `organizationName`,
		r.fUuid AS `roleId`,
		r.fRoleName AS `roleName`
		FROM
		t_user u
		LEFT JOIN t_user_role ur ON u.fUuid = ur.fUserID
		LEFT JOIN t_role r ON ur.fRoleID = r.fUuid
		LEFT JOIN t_organization og ON og.fuuid = u.fOrganizationID
		where
		u.fUuid = #{id}
	</select>

	<select id="selectUserPage" resultType="Map">
		SELECT
		u.fUuid AS `uuid`,
		u.fLoginName AS `loginName`,
		u.fUserName AS `userName`,
		u.fPassword AS `password`,
		u.fGender AS `sex`,
		u.fPercentage AS `age`,
		u.fVipType AS `userType`,
		u.fStatus AS `status`,
		u.fOrganizationID AS `organizationID`,
		u.fPhone AS `phone`,
		u.fcreateTime AS `createTime`,
		og.fOrganizationName AS `organizationName`,
		group_concat(o.`userName`) AS rolesList
		FROM t_user u
		LEFT JOIN t_user_role ur ON u.fUuid = ur.fUserID
		LEFT JOIN t_role r ON ur.fRoleID = r.fUuid
		LEFT JOIN t_organization og ON og.fUuid= t.fOrganizationID
		<where>
			<if test=" userName != null and userName != '' ">
				u.fUserName = #{userName}
			</if>
			<if test=" organizationID != null ">
				u.fOrganizationID = #{organizationID}
			</if>
			<if test=" createTime != null ">
			<![CDATA[ and u.fCreateTime >= #{createTime} ]]>
			</if>
		</where>
		GROUP BY u.fUuid
	</select>

	<select id="searchUsers" resultType="com.keymanager.monitoring.entity.User">
		SELECT
		<include refid="colID"/>
		FROM t_user u
	</select>
</mapper>