<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.CustomerKeywordRefreshStatInfoDao">
    <select id="searchCustomerKeywordStatInfos" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordRefreshStatInfoCriteria" resultType="com.keymanager.monitoring.entity.CustomerKeywordTerminalRefreshStatRecord">
        SELECT
            ck.fOptimizeGroupName AS "group",
            ck.fType AS "type",
            ck.fTerminalType AS "terminalType",
            g.fMaxInvalidCount  AS "maxInvalidCount",
            COUNT(1) AS "totalKeywordCount",
            SUM(IF(ck.fOptimizeRemainingCount > 0, 1, 0)) AS "needOptimizeKeywordCount",
            SUM(IF(ck.fInvalidRefreshCount >= g.fMaxInvalidCount, 1, 0)) AS "invalidKeywordCount",
            SUM(IF(ck.fOptimizedCount = 0, 1, 0)) AS "zeroOptimizedCount",
            SUM(IF(ck.fLastReachStandardDate = CURRENT_DATE(), 1, 0)) AS "reachStandardKeywordCount",
            SUM(IF(ck.fLastReachStandardDate = CURRENT_DATE(),ck.fTodayFee, 0)) as "todaySubTotal",
            SUM(ck.fOptimizePlanCount) AS "totalOptimizeCount",
            SUM(ck.fOptimizedCount) AS "totalOptimizedCount",
            SUM(ck.fOptimizeRemainingCount) AS "needOptimizeCount",
            SUM(ck.fQueryCount) AS "queryCount"
        FROM t_customer_keyword ck
        LEFT JOIN t_group g
        ON ck.fOptimizeGroupName like concat(g.fGroupName, '%') AND ck.fTerminalType = g.fTerminalType
        <if test="customerKeywordRefreshStatInfoCriteria.userName!=null and customerKeywordRefreshStatInfoCriteria.userName!=''">
            JOIN t_customer c
            ON ck.fCustomerUuid = c.fUuid
        </if>
        <if test="customerKeywordRefreshStatInfoCriteria.categoryTag != null and customerKeywordRefreshStatInfoCriteria.categoryTag != ''">
            JOIN t_qz_operation_type ot
            ON ot.fGroup = ck.fOptimizeGroupName
            JOIN t_qz_category_tag qc
            ON ot.fQZSettingUuid = qc.fQZSettingUuid
        </if>
        WHERE ck.fStatus = 1
        <if test="customerKeywordRefreshStatInfoCriteria.entryType!=null and customerKeywordRefreshStatInfoCriteria.entryType!=''">AND ck.fType = #{customerKeywordRefreshStatInfoCriteria.entryType}</if>
        <if test="customerKeywordRefreshStatInfoCriteria.terminalType!=null and customerKeywordRefreshStatInfoCriteria.terminalType!=''">AND ck.fTerminalType = #{customerKeywordRefreshStatInfoCriteria.terminalType}</if>
        <if test="customerKeywordRefreshStatInfoCriteria.groupName!=null and customerKeywordRefreshStatInfoCriteria.groupName!=''">AND ck.fOptimizeGroupName like concat('%', #{customerKeywordRefreshStatInfoCriteria.groupName}, "%")</if>
        <if test="customerKeywordRefreshStatInfoCriteria.customerName!=null and customerKeywordRefreshStatInfoCriteria.customerName!=''">AND c.fContactPerson like concat('%', #{customerKeywordRefreshStatInfoCriteria.customerName}, "%")</if>
        <if test="customerKeywordRefreshStatInfoCriteria.userName!=null and customerKeywordRefreshStatInfoCriteria.userName!=''">AND c.fUserID = #{customerKeywordRefreshStatInfoCriteria.userName}</if>
        <if test="customerKeywordRefreshStatInfoCriteria.categoryTag != null and customerKeywordRefreshStatInfoCriteria.categoryTag != ''">AND qc.fTagName = #{customerKeywordRefreshStatInfoCriteria.categoryTag} </if>
        GROUP BY ck.fOptimizeGroupName, ck.fType, ck.fTerminalType
        ORDER BY ck.fOptimizeGroupName
    </select>

</mapper>