<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.QZChargeRuleDao">

    <!--查询一条操作类型信息-->
    <select id="searchQZChargeRuleByqzOperationTypeUuids" resultType="com.keymanager.monitoring.entity.QZChargeRule">
        SELECT
        qchru.fUuid            AS 'uuid',
        qchru.fQZOperationTypeUuid    AS 'qzOperationTypeUuid',
        qchru.fStandardSpecies    AS 'standardSpecies',
        qchru.fStartKeywordCount          AS 'startKeywordCount',
        qchru.fEndKeywordCount         AS 'endKeywordCount',
        qchru.fAmount      AS 'amount',
        qchru.fCreatetime            AS 'createTime',
        qchru.fUpdatetime   AS 'updateTime'
        FROM t_qz_charge_rule  qchru
        WHERE  qchru.fQZOperationTypeUuid  = #{qzOperationTypeUuid}
        order by qchru.fStartKeywordCount
    </select>

    <!--返回上一级插入的主键-->
    <select id="selectLastId" resultType="int">
        select LAST_INSERT_ID()
    </select>

    <delete id="deleteByQZOperationTypeUuid" >
        DELETE  FROM  t_qz_charge_rule WHERE  fQZOperationTypeUuid  = #{qzOperationTypeUuid}
    </delete>

    <select id="searchQZChargeRules" parameterType="com.keymanager.monitoring.criteria.QZSettingSearchChargeRuleCriteria" resultType="com.keymanager.monitoring.entity.QZChargeRule">
        SELECT
            qc.fStartKeywordCount AS "startKeywordCount",
            qc.fEndKeywordCount AS "endKeywordCount",
            qc.fAmount AS "amount"
        FROM t_qz_charge_rule qc
        JOIN t_qz_operation_type qo
        ON qo.fUuid = qc.fQZOperationTypeUuid
        WHERE qo.fQZSettingUuid = #{qzSettingSearchChargeRuleCriteria.qzSettingUuid}
        AND qo.fOperationtype = #{qzSettingSearchChargeRuleCriteria.terminalType}
        ORDER BY qc.fUuid
    </select>

    <select id="getAllStandardSpecies" resultType="java.lang.String">
        SELECT
            CONCAT(qot.fOperationtype, '_', qcr.fStandardSpecies)
        FROM t_qz_charge_rule qcr
        LEFT JOIN t_qz_operation_type qot
        ON qot.fUuid = qcr.fQZOperationTypeUuid
        WHERE qcr.fStandardSpecies <![CDATA[<>]]]> 'designationWord'
        AND EXISTS(
            SELECT 1 FROM t_qz_setting qs
            WHERE qs.fUuid = qot.fQZSettingUuid
            AND qs.fUuid = #{qzSettingUuid}
        )
        GROUP BY qot.fOperationtype, qcr.fStandardSpecies
    </select>

    <select id="findQZChargeRules" resultType="com.keymanager.monitoring.vo.QZChargeRuleVO">
        SELECT
            cr.fStartKeywordCount AS 'startKeywordCount',
            cr.fAmount AS 'amount'
        FROM t_qz_charge_rule cr
        WHERE EXISTS(
            SELECT 1
            FROM t_qz_operation_type op
            WHERE op.fUuid = cr.fQZOperationTypeUuid
            AND op.fQZSettingUuid = #{qzSettingUuid}
            AND op.fOperationtype = #{operationType}
        )
        AND cr.fStandardSpecies = #{websiteType}
        ORDER BY cr.fStandardSpecies
    </select>
</mapper>