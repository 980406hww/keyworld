<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.CustomerKeywordDao">
    <sql id="colID">
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fType	AS	'type',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fTitle	AS	'title',
        ck.fSequence	AS	'sequence',
        ck.fCaptureTitleQueryTime	AS	'captureTitleQueryTime',
        ck.fCapturedTitle	AS	'capturedTitle',
        ck.fAutoUpdateNegativeDateTime	AS	'autoUpdateNegativeDateTime',
        ck.fBigKeyword	AS	'bigKeyword',
        ck.fSnapshotDateTime	AS	'snapshotDateTime',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fInitialIndexCount	AS	'initialIndexCount',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fQueryDate	AS	'queryDate',
        ck.fQueryCount	AS	'queryCount',
        ck.fInvalidRefreshCount	AS	'invalidRefreshCount',
        ck.fQueryTime	AS	'queryTime',
        ck.fQueryInterval	AS	'queryInterval',
        ck.fServiceProvider	AS	'serviceProvider',
        ck.fOptimizeGroupName	AS	'optimizeGroupName',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fOptimizedCount	AS	'optimizedCount',
        ck.fOptimizedPercentage	AS	'optimizedPercentage',
        ck.fOptimizeDate	AS	'optimizeDate',
        ck.fLastOptimizeDateTime	AS	'lastOptimizeDateTime',
        ck.fOptimizePositionFirstPercentage	AS	'optimizePositionFirstPercentage',
        ck.fOptimizePositionSecondPercentage	AS	'optimizePositionSecondPercentage',
        ck.fOptimizePositionThirdPercentage	AS	'optimizePositionThirdPercentage',
        ck.fPositionFirstCost	AS	'positionFirstCost',
        ck.fPositionSecondCost	AS	'positionSecondCost',
        ck.fPositionThirdCost	AS	'positionThirdCost',
        ck.fPositionForthCost	AS	'positionForthCost',
        ck.fPositionFifthCost	AS	'positionFifthCost',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee',
        ck.fCapturePositionQueryTime	AS	'capturePositionQueryTime',
        ck.fCaptureIndexQueryTime	AS	'captureIndexQueryTime',
        ck.fCollectMethod	AS	'collectMethod',
        ck.fStartOptimizedTime	AS	'startOptimizedTime',
        ck.fEffectiveFromTime	AS	'effectiveFromTime',
        ck.fEffectiveToTime	AS	'effectiveToTime',
        ck.fPaymentEffectiveFromTime	AS	'paymentEffectiveFromTime',
        ck.fPaymentEffectiveToTime	AS	'paymentEffectiveToTime',
        ck.fRelatedKeywords	AS	'relatedKeywords',
        ck.fPaymentStatus	AS	'paymentStatus',
        ck.fOrderNumber	AS	'orderNumber',
        ck.fRemarks	AS	'remarks',
        ck.fStatus	AS	'status',
        ck.fUpdateTime	AS	'updateTime',
        ck.fCreateTime	AS	'createTime'
    </sql>

    <update id="cleanSelectedCustomerKeywordTitle">
        UPDATE t_customer_keyword set fTitle = null where fUuid in
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
          #{item}
        </foreach>
    </update>

    <update id="cleanCustomerTitle">
        UPDATE t_customer_keyword set fTitle = null where fTerminalType = #{terminalType} and fType = #{entryType} and fCustomerUuid = #{customerUuid}
    </update>

    <update id="cleanCaptureTitleFlag">
        UPDATE t_customer_keyword SET fTitle = NULL, fCaptureTitleQueryTime = NULL, fCapturedTitle = 0
        where fTerminalType = #{terminalType} and fCustomerUuid = #{customerUuid}  and fType = #{entryType}
    </update>

    <select id="getCustomerKeywordCount" resultType="int">
        SELECT COUNT(1) FROM t_customer_keyword ck WHERE ck.fCustomerUuid = #{customerUuid}
    </select>

    <select id="getCustomerKeywordsCount" resultType="java.util.Map">
        SELECT ck.fCustomerUuid, COUNT(1) as subCount FROM t_customer_keyword ck WHERE ck.fTerminalType = #{terminalType}
        and ck.fType = #{entryType} and ck.fCustomerUuid IN
        <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
         GROUP BY ck.fCustomerUuid
    </select>

    <select id="getSimilarCustomerKeywordCount" resultType="int">
        select Count(1) from t_customer_keyword where fKeyword = #{keyword} and fTerminalType = #{terminalType} and fCustomerUuid = #{customerUuid}
        and fOriginalUrl <![CDATA[ <> ]]> '' and fOriginalUrl like concat('%', #{originalUrl});
    </select>

    <select id="getMaxSequence" resultType="int">
        select max(fSequence) from t_customer_keyword where fTerminalType = #{terminalType} and fType = #{entryType} and fCustomerUuid =
        #{customerUuid};
    </select>

    <select id="searchSameCustomerKeywords" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="colID"/>
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword} and ck.fTerminalType = #{terminalType} and ck.fCustomerUuid = #{customerUuid}
        order by ck.fCreateTime ASC
    </select>

    <select id="getCustomerKeywordsForCaptureIndex" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="colID"/>
        FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName IN ('pc_pm_xiaowu', 'm_pm_tiantian') AND ck.fCurrentIndexCount IS NULL AND ck.fPositionFirstFee IS NULL
        ORDER BY ck.fCaptureIndexQueryTime, ck.fCreateTime LIMIT 1
    </select>

    <select id="searchCustomerKeywordsForUpdateIndex" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="colID"/>
        FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName IN ('pc_pm_xiaowu', 'm_pm_tiantian') AND ck.fCurrentIndexCount IS NULL AND ck.fPositionFirstFee IS NULL
        AND ck.fKeyword = #{keyword}
        ORDER BY ck.fCaptureIndexQueryTime, ck.fCreateTime
    </select>

    <select id="updateCaptureIndexQueryTime">
        UPDATE t_customer_keyword SET fCaptureIndexQueryTime = NOW() WHERE fKeyword = #{keyword} and fCurrentIndexCount IS NULL and fOptimizeGroupName IN ('pc_pm_xiaowu', 'm_pm_xiaowu')
    </select>

    <!--重构部分-->
    <select id="searchCustomerKeywords" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
          <include refid="colID"/>
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        <if test="customerKeywordCrilteria.customerUuid != null and customerKeywordCrilteria.customerUuid != ''">AND ck.fCustomerUuid = #{customerKeywordCrilteria.customerUuid}</if>
        <if test="customerKeywordCrilteria.keyword != null and customerKeywordCrilteria.keyword != ''">AND ck.fKeyword like '${customerKeywordCrilteria.keyword}%'</if>
        <if test="customerKeywordCrilteria.url != null and customerKeywordCrilteria.url != ''">AND ck.fUrl like '%${customerKeywordCrilteria.url}%'</if>
        <if test="customerKeywordCrilteria.status != null and customerKeywordCrilteria.status != ''">AND ck.fStatus = #{customerKeywordCrilteria.status}</if>
        <if test="customerKeywordCrilteria.invalidRefreshCount != null and customerKeywordCrilteria.invalidRefreshCount != ''">AND ck.fInvalidRefreshCount &gt;= #{customerKeywordCrilteria.invalidRefreshCount}</if>
        <if test="customerKeywordCrilteria.creationFromTime != null and customerKeywordCrilteria.creationFromTime != ''">AND ck.fCreateTime >= #{customerKeywordCrilteria.creationFromTime}</if>
        <if test="customerKeywordCrilteria.creationToTime != null and customerKeywordCrilteria.creationToTime != ''">AND ck.fCreateTime &lt;= #{customerKeywordCrilteria.creationToTime}</if>
        <if test="customerKeywordCrilteria.entryType != null and customerKeywordCrilteria.entryType != ''">AND ck.fType = #{customerKeywordCrilteria.entryType}</if>
        <if test="customerKeywordCrilteria.position != null and customerKeywordCrilteria.position != '' and customerKeywordCrilteria.noPosition == null "><![CDATA[AND fCurrentPosition > 0 and fCurrentPosition <= #{customerKeywordCrilteria.position}  ]]>   </if>
        <if test="customerKeywordCrilteria.noPosition == 1 ">AND ck.fCurrentPosition =  0    </if>
        <if test="customerKeywordCrilteria.orderNumber != null and customerKeywordCrilteria.orderNumber != ''">AND ck.fOrderNumber  like '%${customerKeywordCrilteria.orderNumber}%'</if>
        <if test="customerKeywordCrilteria.pushPay != null and customerKeywordCrilteria.pushPay != ''">AND ((ck.fCollectMethod = 'PerDay' AND ck.fEffectiveToTime is not null) OR (ck.fEffectiveToTime &lt;= DATE_ADD(CURDATE(),INTERVAL 3 DAY))) </if>
        <if test="customerKeywordCrilteria.terminalType != null and customerKeywordCrilteria.terminalType != ''">AND fTerminalType =  #{customerKeywordCrilteria.terminalType} </if>
        <if test="customerKeywordCrilteria.qq != null and customerKeywordCrilteria.qq != ''">
            AND ck.fCustomerUuid in (
            SELECT fUuid FROM t_customer WHERE fQQ LIKE '${customerKeywordCrilteria.qq}%' )
        </if>
        <if test="customerKeywordCrilteria.userName != null and customerKeywordCrilteria.userName != ''">
            AND ck.fCustomerUuid IN ( SELECT fUuid FROM t_customer c WHERE c.fUserID = (
            SELECT fUserID FROM t_user WHERE fUserID = #{customerKeywordCrilteria.userName}))
        </if>
        <choose>
            <when test="customerKeywordCrilteria.optimizeGroupName != null and customerKeywordCrilteria.optimizeGroupName != ''">
                AND ck.fOptimizeGroupName  like '%${customerKeywordCrilteria.optimizeGroupName}%'
            </when>
            <otherwise>
                <if test="customerKeywordCrilteria.displayStop == null or customerKeywordCrilteria.displayStop == ''">
                    AND ck.fOptimizeGroupName != 'stop'
                </if>
            </otherwise>
        </choose>
        <choose>
          <when test="customerKeywordCrilteria.orderElement != null and customerKeywordCrilteria.orderElement != ''">
              ORDER BY ck.${customerKeywordCrilteria.orderElement}  DESC
          </when>
          <otherwise>
              ORDER BY ck.fKeyword
          </otherwise>
        </choose>
    </select>

    <update id="updateCustomerKeywordGroupName">
        UPDATE t_customer_keyword SET fOptimizeGroupName = #{customerKeywordUpdateGroupCriteria.targetGroupName},fUpdateTime = CURRENT_TIMESTAMP WHERE
        fTerminalType = #{customerKeywordUpdateGroupCriteria.terminalType}  AND fType = #{customerKeywordUpdateGroupCriteria.entryType}
        <if test="customerKeywordUpdateGroupCriteria.customerUuid !=null and customerKeywordUpdateGroupCriteria.customerUuid != ''">
            AND fCustomerUuid = #{customerKeywordUpdateGroupCriteria.customerUuid}
        </if>
         <if test="customerKeywordUpdateGroupCriteria.customerKeywordUuids != null"> AND fUuid IN
             <foreach item="item" index="index" collection="customerKeywordUpdateGroupCriteria.customerKeywordUuids" open="(" separator="," close=")">
                 #{item}
             </foreach>
         </if>
    </update>

    <delete id="deleteCustomerKeywordsByUuid">
        delete from t_customer_keyword where fUuid IN
        <foreach item="item" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitleAndUrl">
        delete from t_customer_keyword where fTerminalType = #{terminalType} AND fType = #{entryType} AND fCustomerUuid = #{customerUuid} AND (fTitle = '' or fTitle IS null) AND (fUrl = '' or fUrl IS NULL)
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitle">
        delete from t_customer_keyword where fTerminalType = #{terminalType} AND fType = #{entryType} AND fCustomerUuid = #{customerUuid} AND (fTitle = '' or fTitle IS null)
    </delete>

    <select id="getGroups" resultType="String">
        SELECT DISTINCT ck.fOptimizeGroupName as 'group' FROM t_customer_keyword ck WHERE ck.fStatus = 1 AND ck.fOptimizeGroupName IS NOT NULL
        AND ck.fOptimizeGroupName <![CDATA[<>]]>'' ORDER BY ck.fOptimizeGroupName
    </select>

    <update id="cleanBigKeywordIndicator">
        UPDATE t_customer_keyword SET fBigKeyword = 0 WHERE fOptimizeGroupName = #{groupName}
    </update>

    <update id="setBigKeywordIndicator">
        UPDATE t_customer_keyword SET fBigKeyword = 1 WHERE fUuid IN
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="getEntryTypes" resultType="String">
        SELECT distinct ck.fType as typeName FROM t_customer_keyword ck WHERE ck.fOptimizeGroupName = #{groupName} AND ck.fStatus = 1
    </select>

    <update id="resetOptimizationInfo">
        UPDATE t_customer_keyword SET fOptimizedCount = 0, fInvalidRefreshCount = 0, fOptimizeDate = CURRENT_DATE(), fQueryCount = 0, fQueryDate = CURRENT_DATE()  WHERE fOptimizeDate != CURRENT_DATE()
    </update>

    <select id="searchRemainingOptimizationCount" resultType="java.util.Map">
        SELECT ck.fUuid as 'uuid', (ck.fOptimizePlanCount - ck.fOptimizedCount) AS 'remainingCount' FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName = #{groupName} AND ck.fOptimizePlanCount > ck.fOptimizedCount and ck.fInvalidRefreshCount <![CDATA[<]]> #{maxInvalidCount}
        ORDER BY (ck.fOptimizePlanCount - ck.fOptimizedCount) DESC
    </select>

    <select id="getCustomerKeywordForOptimization" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="colID"/>
        FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName = #{groupName} and ck.fStatus = 1 and ck.fTerminalType = #{terminalType}
        and (ck.fQueryTime is NULL or DATE_SUB(NOW(), INTERVAL ck.fQueryInterval MINUTE) > ck.fQueryTime) and ck.fUrl <![CDATA[<>]]> ''
        and ((ck.fCurrentPosition = 0 and ck.fInvalidRefreshCount <![CDATA[<]]> 2) or (ck.fCurrentPosition > 0 and ck.fInvalidRefreshCount <![CDATA[<]]> #{maxInvalidCount}))
        and ck.fBigKeyword = #{bigKeyowrd} and ((ck.fOptimizedCount <![CDATA[<]]> ck.fOptimizePlanCount) or (ck.fOptimizeDate is null) or (ck.fOptimizeDate <![CDATA[<]]> current_date()))
        order by ck.fQueryTime limit 1
    </select>

    <update id="updateOptimizationQueryTime">
        UPDATE t_customer_keyword set fQueryDate = CURRENT_DATE(), fInvalidRefreshCount = fInvalidRefreshCount + 1, fQueryTime = now()
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="updateOptimizationResult">
        UPDATE t_customer_keyword
        SET fLastOptimizeDateTime = now(), fOptimizedCount = fOptimizedCount + #{count},
        <if test="count == 0">fInvalidRefreshCount = 0, </if>
        fOptimizedPercentage = fOptimizedCount/fOptimizePlanCount, fOptimizeDate = CURRENT_DATE(),fUpdateTime = NOW()
		WHERE fUuid = #{customerKeywordUuid}
    </update>

    <select id="searchCustomerKeywordsForAdjustingOptimizationCount" resultType="java.util.Map">
        SELECT ck.fUuid AS 'uuid', ck.fKeyword as 'keyword', ck.fUrl as 'url', ck.fCurrentIndexCount as 'currentIndexCount',
        GROUP_CONCAT(CAST(ps.fPosition AS CHAR) ORDER BY ps.fCreateDate) AS 'positions'
        FROM t_customer_keyword ck JOIN t_ck_position_summary ps ON ck.fUuid = ps.fCustomerKeywordUuid
		WHERE ps.fCreateDate >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY)
		AND ck.fStatus = 1 AND ck.fOptimizeGroupName = #{groupName}
		GROUP BY ck.fUuid, ck.fKeyword
    </select>

    <update id="adjustOptimizePlanCount">
        UPDATE t_customer_keyword
        SET fOptimizePlanCount = #{optimizationPlanCount}, fQueryInterval = #{queryInterval}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <select id="getCustomerKeywordForCapturePosition" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="colID"/>
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType} and ck.fUrl is not null and ck.fStatus = 1
        AND (ck.fCapturePositionQueryTime is null or ck.fCapturePositionQueryTime <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL #{minutes} MINUTE ))
        <if test="customerUuid != null">
            AND ck.fCustomerUuid = #{customerUuid}
        </if>

        <choose>
            <when test="groupNames != null">
                AND ck.fOptimizeGroupName IN
                <foreach item="item" index="index" collection="groupNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                AND ck.fOptimizeGroupName <![CDATA[<>]]> 'stop'
            </otherwise>
        </choose>
        ORDER BY ck.fCapturePositionQueryTime, fUpdateTime DESC
        LIMIT 1
    </select>

    <update id="resetInvalidRefreshCount" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordRefreshStatInfoCriteria">
        UPDATE t_customer_keyword SET fInvalidRefreshCount = 0 WHERE fType = #{customerKeywordRefreshStatInfoCriteria.entryType} and fTerminalType = #{customerKeywordRefreshStatInfoCriteria.terminalType}
        <if test="customerKeywordRefreshStatInfoCriteria.customerName!=null and customerKeywordRefreshStatInfoCriteria.customerName!=''">AND EXISTS (SELECT 1 FROM t_customer c WHERE c.fUuid = fCustomerUuid AND c.fContactPerson LIKE concat('%', #{customerKeywordRefreshStatInfoCriteria.customerName}, '%'))</if>
        <if test="customerKeywordRefreshStatInfoCriteria.groupName!=null and customerKeywordRefreshStatInfoCriteria.groupName!=''">AND fOptimizeGroupName LIKE concat('%', #{customerKeywordRefreshStatInfoCriteria.groupName}, '%')</if>

    </update>
</mapper>