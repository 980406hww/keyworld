<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.CustomerKeywordDao">
    <sql id="dailyReportColID">
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fTitle	AS	'title',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fTodayFee  AS 'todayFee',
        ck.fSequence	AS	'sequence',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fInitialIndexCount	AS	'initialIndexCount',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee'
    </sql>

    <sql id="searchCustomerKeywordsCriteria">
        <if test="customerKeywordCriteria.customerUuid != null and customerKeywordCriteria.customerUuid != ''">AND ck.fCustomerUuid = #{customerKeywordCriteria.customerUuid}</if>
        <if test="customerKeywordCriteria.keyword != null and customerKeywordCriteria.keyword != ''">AND ck.fKeyword like '${customerKeywordCriteria.keyword}%'</if>
        <if test="customerKeywordCriteria.url != null and customerKeywordCriteria.url != ''">AND ck.fUrl like '%${customerKeywordCriteria.url}%'</if>
        <if test="customerKeywordCriteria.excludeUrl != null and customerKeywordCriteria.excludeUrl != ''">AND ck.fUrl not like '%${customerKeywordCriteria.excludeUrl}%'</if>
        <if test="customerKeywordCriteria.bearPawNumber != null and customerKeywordCriteria.bearPawNumber != ''">AND ck.fBearPawNumber like '${customerKeywordCriteria.bearPawNumber}%'</if>
        <if test="customerKeywordCriteria.status != null and customerKeywordCriteria.status != ''">AND ck.fStatus = #{customerKeywordCriteria.status}</if>
        <if test="customerKeywordCriteria.invalidRefreshCount != null and customerKeywordCriteria.invalidRefreshCount != ''">AND ck.fInvalidRefreshCount &gt;= #{customerKeywordCriteria.invalidRefreshCount}</if>
        <if test="customerKeywordCriteria.creationFromTime != null and customerKeywordCriteria.creationFromTime != ''">AND ck.fCreateTime &gt;= #{customerKeywordCriteria.creationFromTime}</if>
        <if test="customerKeywordCriteria.creationToTime != null and customerKeywordCriteria.creationToTime != ''">AND ck.fCreateTime &lt;= #{customerKeywordCriteria.creationToTime}</if>
        <if test="customerKeywordCriteria.entryType != null and customerKeywordCriteria.entryType != ''">AND ck.fType = #{customerKeywordCriteria.entryType}</if>
        <if test="customerKeywordCriteria.gtPosition != null and (customerKeywordCriteria.noPosition == null or customerKeywordCriteria.noPosition == '') "> AND ck.fCurrentPosition &gt;= #{customerKeywordCriteria.gtPosition}</if>
        <if test="customerKeywordCriteria.ltPosition != null and (customerKeywordCriteria.noPosition == null or customerKeywordCriteria.noPosition == '') "> AND ck.fCurrentPosition &lt;= #{customerKeywordCriteria.ltPosition}</if>
        <if test="customerKeywordCriteria.noPosition == 1 ">AND ck.fCurrentPosition = 0 </if>
        <if test="customerKeywordCriteria.orderNumber != null and customerKeywordCriteria.orderNumber != ''">AND ck.fOrderNumber  like '%${customerKeywordCriteria.orderNumber}%'</if>
        <if test="customerKeywordCriteria.pushPay != null and customerKeywordCriteria.pushPay != ''">AND ((ck.fCollectMethod = 'PerDay' AND ck.fEffectiveToTime is not null) OR (ck.fEffectiveToTime &lt;= DATE_ADD(CURDATE(),INTERVAL 3 DAY))) </if>
        <if test="customerKeywordCriteria.terminalType != null and customerKeywordCriteria.terminalType != ''">AND fTerminalType =  #{customerKeywordCriteria.terminalType} </if>
        <if test="customerKeywordCriteria.gtOptimizedCount != null">AND ck.fOptimizedCount &gt;= #{customerKeywordCriteria.gtOptimizedCount} </if>
        <if test="customerKeywordCriteria.ltOptimizedCount != null">AND ck.fOptimizedCount &lt;= #{customerKeywordCriteria.ltOptimizedCount} </if>
        <if test="customerKeywordCriteria.gtOptimizePlanCount != null">AND ck.fOptimizePlanCount &gt;= #{customerKeywordCriteria.gtOptimizePlanCount} </if>
        <if test="customerKeywordCriteria.ltOptimizePlanCount != null">AND ck.fOptimizePlanCount &lt;= #{customerKeywordCriteria.ltOptimizePlanCount} </if>
        <if test="customerKeywordCriteria.remarks != null and customerKeywordCriteria.remarks != ''">AND ck.fRemarks like '%${customerKeywordCriteria.remarks}%' </if>
        <if test="customerKeywordCriteria.failedCause != null and customerKeywordCriteria.failedCause != ''">AND ck.fFailedCause = #{customerKeywordCriteria.failedCause} </if>
        <if test="customerKeywordCriteria.keywordEffect != null and customerKeywordCriteria.keywordEffect != ''">AND ck.fKeywordEffect = #{customerKeywordCriteria.keywordEffect} </if>
        <if test="customerKeywordCriteria.gtCurrentIndexCount != null">AND ck.fCurrentIndexCount &gt;= #{customerKeywordCriteria.gtCurrentIndexCount} </if>
        <if test="customerKeywordCriteria.ltCurrentIndexCount != null">AND ck.fCurrentIndexCount &lt;= #{customerKeywordCriteria.ltCurrentIndexCount} </if>
        <if test="customerKeywordCriteria.qq != null and customerKeywordCriteria.qq != ''">
            AND c.fQQ LIKE '${customerKeywordCriteria.qq}%'
        </if>
        <if test="customerKeywordCriteria.searchEngine != null and customerKeywordCriteria.searchEngine != ''">AND ck.fSearchEngine = #{customerKeywordCriteria.searchEngine} </if>
        <if test="customerKeywordCriteria.userName != null and customerKeywordCriteria.userName != ''">
            AND c.fUserID = #{customerKeywordCriteria.userName}
        </if>
        <if test="customerKeywordCriteria.customerKeywordSource != null and customerKeywordCriteria.customerKeywordSource != ''">AND ck.fCustomerKeywordSource = #{customerKeywordCriteria.customerKeywordSource}</if>
        <if test="customerKeywordCriteria.noReachStandardDays != null and customerKeywordCriteria.noReachStandardDays > 0">
            AND ck.fLastReachStandardDate &lt;= DATE_SUB(CURRENT_DATE(), INTERVAL #{customerKeywordCriteria.noReachStandardDays} DAY)
        </if>
        <if test="customerKeywordCriteria.noReachStandardDays != null and customerKeywordCriteria.noReachStandardDays == -1">
            AND ck.fLastReachStandardDate = CURRENT_DATE()
        </if>
        <if test="customerKeywordCriteria.requireDelete == true">
            AND ck.fRequireDelete = 1
        </if>
        <if test="customerKeywordCriteria.titleFlag == 1">
            AND (ck.fTitle = '' OR ck.fTitle IS NULL)
        </if>
        <if test="customerKeywordCriteria.titleFlag == 2">
            AND ck.fTitle > ''
        </if>
        <if test="customerKeywordCriteria.optimizeGroupName != null and customerKeywordCriteria.optimizeGroupName != ''">
            <if test="customerKeywordCriteria.groupNameFuzzyQuery == null or customerKeywordCriteria.groupNameFuzzyQuery == ''">
                AND ck.fOptimizeGroupName = #{customerKeywordCriteria.optimizeGroupName}
            </if>
            <if test="customerKeywordCriteria.groupNameFuzzyQuery == 1">
                AND ck.fOptimizeGroupName like '${customerKeywordCriteria.optimizeGroupName}%'
            </if>
        </if>
        <if test="customerKeywordCriteria.machineGroup != null and customerKeywordCriteria.machineGroup != ''">
            <if test="customerKeywordCriteria.machineGroupFuzzyQuery == null or customerKeywordCriteria.machineGroupFuzzyQuery == ''">
                AND ck.fMachineGroup = #{customerKeywordCriteria.machineGroup}
            </if>
            <if test="customerKeywordCriteria.machineGroupFuzzyQuery == 1">
                AND ck.fMachineGroup like '${customerKeywordCriteria.machineGroup}%'
            </if>
        </if>
        <choose>
            <when test="customerKeywordCriteria.orderingElement != null and customerKeywordCriteria.orderingElement != ''">
                ORDER BY ck.${customerKeywordCriteria.orderingElement}  DESC
            </when>
            <otherwise>
                ORDER BY ck.fKeyword
            </otherwise>
        </choose>
    </sql>

    <sql id="updateCustomerKeywordsCriteria">
        <if test="customerKeywordCriteria.uuids != null"> AND ck.fUuid IN
            <foreach item = "item" collection = "customerKeywordCriteria.uuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="customerKeywordCriteria.customerUuid != null and customerKeywordCriteria.customerUuid != ''">AND ck.fCustomerUuid = #{customerKeywordCriteria.customerUuid}</if>
        <if test="customerKeywordCriteria.keyword != null and customerKeywordCriteria.keyword != ''">AND ck.fKeyword like '${customerKeywordCriteria.keyword}%'</if>
        <if test="customerKeywordCriteria.url != null and customerKeywordCriteria.url != ''">AND ck.fUrl like '%${customerKeywordCriteria.url}%'</if>
        <if test="customerKeywordCriteria.bearPawNumber != null and customerKeywordCriteria.bearPawNumber != ''">AND ck.fBearPawNumber like '${customerKeywordCriteria.bearPawNumber}%'</if>
        <if test="customerKeywordCriteria.status != null and customerKeywordCriteria.status != ''">AND ck.fStatus = #{customerKeywordCriteria.status}</if>
        <if test="customerKeywordCriteria.invalidRefreshCount != null and customerKeywordCriteria.invalidRefreshCount != ''">AND ck.fInvalidRefreshCount &gt;= #{customerKeywordCriteria.invalidRefreshCount}</if>
        <if test="customerKeywordCriteria.creationFromTime != null and customerKeywordCriteria.creationFromTime != ''">AND ck.fCreateTime &gt;= #{customerKeywordCriteria.creationFromTime}</if>
        <if test="customerKeywordCriteria.creationToTime != null and customerKeywordCriteria.creationToTime != ''">AND ck.fCreateTime &lt;= #{customerKeywordCriteria.creationToTime}</if>
        <if test="customerKeywordCriteria.entryType != null and customerKeywordCriteria.entryType != ''">AND ck.fType = #{customerKeywordCriteria.entryType}</if>
        <if test="customerKeywordCriteria.gtPosition != null and customerKeywordCriteria.noPosition == null "> AND ck.fCurrentPosition &gt;= #{customerKeywordCriteria.gtPosition}</if>
        <if test="customerKeywordCriteria.ltPosition != null and customerKeywordCriteria.noPosition == null "> AND ck.fCurrentPosition &lt;= #{customerKeywordCriteria.ltPosition}</if>
        <if test="customerKeywordCriteria.noPosition == 1 ">AND ck.fCurrentPosition =  0    </if>
        <if test="customerKeywordCriteria.orderNumber != null and customerKeywordCriteria.orderNumber != ''">AND ck.fOrderNumber  like '%${customerKeywordCriteria.orderNumber}%'</if>
        <if test="customerKeywordCriteria.pushPay != null and customerKeywordCriteria.pushPay != ''">AND ((ck.fCollectMethod = 'PerDay' AND ck.fEffectiveToTime is not null) OR (ck.fEffectiveToTime &lt;= DATE_ADD(CURDATE(),INTERVAL 3 DAY))) </if>
        <if test="customerKeywordCriteria.terminalType != null and customerKeywordCriteria.terminalType != ''">AND fTerminalType =  #{customerKeywordCriteria.terminalType} </if>
        <if test="customerKeywordCriteria.gtOptimizedCount != null">AND ck.fOptimizedCount &gt;= #{customerKeywordCriteria.gtOptimizedCount} </if>
        <if test="customerKeywordCriteria.ltOptimizedCount != null">AND ck.fOptimizedCount &lt;= #{customerKeywordCriteria.ltOptimizedCount} </if>
        <if test="customerKeywordCriteria.gtOptimizePlanCount != null">AND ck.fOptimizePlanCount &gt;= #{customerKeywordCriteria.gtOptimizePlanCount} </if>
        <if test="customerKeywordCriteria.ltOptimizePlanCount != null">AND ck.fOptimizePlanCount &lt;= #{customerKeywordCriteria.ltOptimizePlanCount} </if>
        <if test="customerKeywordCriteria.remarks != null and customerKeywordCriteria.remarks != ''">AND ck.fRemarks like '%${customerKeywordCriteria.remarks}%' </if>
        <if test="customerKeywordCriteria.gtCurrentIndexCount != null">AND ck.fCurrentIndexCount &gt;= #{customerKeywordCriteria.gtCurrentIndexCount} </if>
        <if test="customerKeywordCriteria.ltCurrentIndexCount != null">AND ck.fCurrentIndexCount &lt;= #{customerKeywordCriteria.ltCurrentIndexCount} </if>
        <if test="customerKeywordCriteria.qq != null and customerKeywordCriteria.qq != ''">
            AND c.fQQ LIKE '${customerKeywordCriteria.qq}%'
        </if>
        <if test="customerKeywordCriteria.searchEngine != null and customerKeywordCriteria.searchEngine != ''">AND ck.fSearchEngine = #{customerKeywordCriteria.searchEngine} </if>
        <if test="customerKeywordCriteria.userName != null and customerKeywordCriteria.userName != ''">
            AND c.fUserID = #{customerKeywordCriteria.userName}
        </if>
        <if test="customerKeywordCriteria.noReachStandardDays != null and customerKeywordCriteria.noReachStandardDays > 0">
            AND ck.fLastReachStandardDate &lt;= DATE_SUB(CURRENT_DATE(), INTERVAL #{customerKeywordCriteria.noReachStandardDays} DAY)
        </if>
        <if test="customerKeywordCriteria.noReachStandardDays != null and customerKeywordCriteria.noReachStandardDays == -1">
            AND ck.fLastReachStandardDate = CURRENT_DATE()
        </if>
        <if test="customerKeywordCriteria.requireDelete == true">
            AND ck.fRequireDelete = 1
        </if>
        <if test="customerKeywordCriteria.titleFlag == 1">
            AND (ck.fTitle = '' OR ck.fTitle IS NULL)
        </if>
        <if test="customerKeywordCriteria.titleFlag == 2">
            AND ck.fTitle > ''
        </if>
        <if test="customerKeywordCriteria.optimizeGroupName != null and customerKeywordCriteria.optimizeGroupName != ''">
            AND ck.fOptimizeGroupName  like '${customerKeywordCriteria.optimizeGroupName}%'
        </if>
        <if test="customerKeywordCriteria.machineGroup != null and customerKeywordCriteria.machineGroup != ''">
            <if test="customerKeywordCriteria.machineGroupFuzzyQuery == null or customerKeywordCriteria.machineGroupFuzzyQuery == ''">
                AND ck.fMachineGroup = #{customerKeywordCriteria.machineGroup}
            </if>
            <if test="customerKeywordCriteria.machineGroupFuzzyQuery == 1">
                AND ck.fMachineGroup like '${customerKeywordCriteria.machineGroup}%'
            </if>
        </if>
    </sql>

    <update id="cleanSelectedCustomerKeywordTitle">
        UPDATE t_customer_keyword set fTitle = null , fManualCleanTitle = 1 where fUuid in
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
          #{item}
        </foreach>
    </update>

    <update id="cleanCustomerTitle">
        UPDATE t_customer_keyword set fTitle = null , fManualCleanTitle = 1 where fTerminalType = #{terminalType} and fType = #{entryType} and fCustomerUuid = #{customerUuid}
    </update>

    <update id="cleanCaptureTitleFlag">
        UPDATE t_customer_keyword SET fTitle = NULL, fCaptureTitleQueryTime = NULL, fCapturedTitle = 0
        where fTerminalType = #{terminalType} and fCustomerUuid = #{customerUuid}  and fType = #{entryType} and  fManualCleanTitle = 0
    </update>

    <update id="cleanCaptureTitleBySelected">
        UPDATE
            t_customer_keyword
        SET
            fTitle = NULL,
            fCaptureTitleQueryTime = NULL,
            fCapturedTitle = 0
        WHERE fUuid IN
        <foreach item="item" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="updateCustomerKeywordIndex" parameterType="com.keymanager.monitoring.entity.CustomerKeyword">
        UPDATE t_customer_keyword
        SET
        fInitialIndexCount =#{customerKeyword.initialIndexCount},
        fCurrentIndexCount =#{customerKeyword.currentIndexCount},
        fOptimizePlanCount =#{customerKeyword.optimizePlanCount},
        fOptimizeRemainingCount =#{customerKeyword.optimizePlanCount},
        fPositionFirstFee =#{customerKeyword.positionFirstFee},
        fPositionSecondFee =#{customerKeyword.positionSecondFee},
        fPositionThirdFee =#{customerKeyword.positionThirdFee},
        fPositionForthFee =#{customerKeyword.positionForthFee},
        fPositionFifthFee =#{customerKeyword.positionFifthFee},
        fPositionFirstPageFee =#{customerKeyword.positionFirstPageFee},
        fUpdateTime =#{customerKeyword.updateTime}
        WHERE fUuid = #{customerKeyword.uuid}
    </update>

    <select id="getCustomerKeywordCount" resultType="int">
        SELECT COUNT(1) FROM t_customer_keyword ck WHERE ck.fType = #{entryType} and ck.fTerminalType = #{terminalType} and ck.fCustomerUuid = #{customerUuid}
    </select>

    <select id="getCustomerKeywordsCount" resultType="java.util.Map">
        SELECT ck.fCustomerUuid as 'customerUuid', COUNT(1) as 'totalCount', SUM(IF(ck.fStatus = 1, 1, 0)) AS 'activeCount'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType}
        AND ck.fType = #{entryType}
        AND ck.fCustomerUuid IN
        <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
         GROUP BY ck.fCustomerUuid
    </select>

    <select id="getSimilarCustomerKeywordCount" resultType="int">
        SELECT Count(1) FROM t_customer_keyword
        WHERE fKeyword = #{keyword}
        AND fTerminalType = #{terminalType}
        AND fCustomerUuid = #{customerUuid}
        <choose>
            <when test="originalUrl == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fOriginalUrl <![CDATA[ > ]]> ''
                AND fOriginalUrl like concat('%', #{originalUrl});
            </otherwise>
        </choose>
    </select>

    <select id="getSameCustomerKeywordCount" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM t_customer_keyword
        WHERE fKeyword = #{keyword}
        AND fTerminalType = #{terminalType}
        AND fCustomerUuid = #{customerUuid}
        <choose>
            <when test="url == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fUrl = #{url}
            </otherwise>
        </choose>
    </select>

    <select id="getMaxSequence" resultType="int">
        select max(fSequence) from t_customer_keyword where fTerminalType = #{terminalType} and fType = #{entryType} and fCustomerUuid =
        #{customerUuid};
    </select>

    <select id="searchSameCustomerKeywords" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fInitialIndexCount	AS	'initialIndexCount',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee'
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword} and ck.fTerminalType = #{terminalType} and ck.fCustomerUuid = #{customerUuid} and ck.fSearchEngine = #{searchEngine}
        order by ck.fCreateTime ASC
    </select>

    <select id="getCustomerKeywordsForCaptureIndex" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fKeyword	AS	'keyword',
        ck.fCollectMethod   AS  'collectMethod'
        FROM t_customer_keyword ck
        WHERE ck.fCurrentIndexCount = -1 AND ck.fPositionFirstFee = -1
        ORDER BY ck.fCaptureIndexQueryTime, ck.fCreateTime LIMIT 1
    </select>

    <select id="searchCustomerKeywordsForUpdateIndex" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid AS 'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fType            AS  'type',
        ck.fSearchEngine    AS  'searchEngine',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee'
        FROM t_customer_keyword ck
        WHERE ck.fCurrentIndexCount = -1 AND ck.fPositionFirstFee = -1
        AND ck.fKeyword = #{keyword}
        ORDER BY ck.fCaptureIndexQueryTime, ck.fCreateTime
    </select>

    <select id="updateCaptureIndexQueryTime">
        UPDATE t_customer_keyword SET fCaptureIndexQueryTime = NOW() WHERE fKeyword = #{keyword} AND fCurrentIndexCount = -1 AND fPositionFirstFee = -1
    </select>

    <!--重构部分-->
    <select id="searchCustomerKeywordsPage" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        c.fUserID AS 'userID',
        c.fContactPerson AS 'contactPerson',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle	AS	'title',
        ck.fStatus	AS	'status',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fCity            AS 'city',
        ck.fCollectMethod	AS	'collectMethod',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fInvalidRefreshCount	AS	'invalidRefreshCount',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fOptimizedCount	AS	'optimizedCount',
        ck.fOptimizedPercentage	AS	'optimizedPercentage',
        ck.fOptimizeDate	AS	'optimizeDate',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee',
        ck.fPaymentStatus	AS	'paymentStatus',
        ck.fOrderNumber	AS	'orderNumber',
        ck.fRemarks	AS	'remarks',
        ck.fFailedCause AS 'failedCause',
        ck.fCapturePositionQueryTime AS 'capturePositionQueryTime'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
          <include refid="searchCustomerKeywordsCriteria"/>
    </select>


    <select id="searchCustomerKeywordsCount"  resultType="int">
        SELECT
            Count(1)
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
          <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <select id="searchCustomerKeywordsForDailyReport" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        <include refid="dailyReportColID"/>
        FROM
        t_customer_keyword ck
        WHERE ck.fCustomerUuid = #{customerKeywordCriteria.customerUuid}
        AND ck.fStatus = 1
        AND fTerminalType =  #{customerKeywordCriteria.terminalType}
        ORDER BY ck.fSequence
    </select>

    <select id="searchCustomerKeywordsPageForCustomer" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle	AS	'title',
        ck.fStatus	AS	'status',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fCity            AS  'city',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fInvalidRefreshCount	AS	'invalidRefreshCount',
        ck.fOptimizeGroupName	AS	'optimizeGroupName',
        ck.fMachineGroup AS 'machineGroup',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fOptimizedCount	AS	'optimizedCount',
        ck.fOptimizeDate	AS	'optimizeDate',
        ck.fStartOptimizedTime	AS	'startOptimizedTime',
        ck.fLastOptimizeDateTime	AS	'lastOptimizeDateTime',
        ck.fLastReachStandardDate AS 'lastReachStandardDate',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee',
        ck.fCollectMethod	AS	'collectMethod',
        ck.fOrderNumber	AS	'orderNumber',
        ck.fRemarks	AS	'remarks',
        ck.fFailedCause AS 'failedCause',
        ck.fCapturePositionQueryTime AS 'capturePositionQueryTime'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
          <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <select id="searchCustomerKeywordInfo" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fTitle	AS	'title',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fOptimizedCount	AS	'optimizedCount',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fBearPawNumber       AS 'bearPawNumber',
        ck.fRemarks	AS	'remarks'
        FROM
        t_customer_keyword ck
        WHERE 1 = 1
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <update id="updateCustomerKeywordGroupName" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordUpdateCriteria">
        UPDATE t_customer_keyword SET fOptimizeGroupName = #{customerKeywordUpdateCriteria.targetGroupName},fUpdateTime = CURRENT_TIMESTAMP WHERE
        fTerminalType = #{customerKeywordUpdateCriteria.terminalType}  AND fType = #{customerKeywordUpdateCriteria.entryType}
        <if test="customerKeywordUpdateCriteria.customerUuid !=null and customerKeywordUpdateCriteria.customerUuid != ''">
            AND fCustomerUuid = #{customerKeywordUpdateCriteria.customerUuid}
        </if>
        <if test="customerKeywordUpdateCriteria.customerKeywordUuids != null"> AND fUuid IN
            <foreach item="item" index="index" collection="customerKeywordUpdateCriteria.customerKeywordUuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </update>

    <update id="updateCustomerKeywordSearchEngine" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordUpdateCriteria">
        UPDATE t_customer_keyword SET fSearchEngine = #{customerKeywordUpdateCriteria.targetSearchEngine},fUpdateTime = CURRENT_TIMESTAMP WHERE
        fTerminalType = #{customerKeywordUpdateCriteria.terminalType}  AND fType = #{customerKeywordUpdateCriteria.entryType}
        <if test="customerKeywordUpdateCriteria.customerUuid !=null and customerKeywordUpdateCriteria.customerUuid != ''">
            AND fCustomerUuid = #{customerKeywordUpdateCriteria.customerUuid}
        </if>
        <if test="customerKeywordUpdateCriteria.customerKeywordUuids != null"> AND fUuid IN
            <foreach item="item" index="index" collection="customerKeywordUpdateCriteria.customerKeywordUuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </update>

    <select id="searchCustomerKeywordUuidByRank" resultType="java.lang.Long">
       select
          ps.fCustomerKeywordUuid
        from t_ck_position_summary ps,
          t_customer_keyword ck
        where ck.fUuid = ps.fCustomerKeywordUuid
            AND ck.fCustomerUuid = #{resultMap.customerUuid}
            and ck.fTerminalType = #{resultMap.terminalType}
            and ck.fType = #{resultMap.entryType}
            and (ps.fPosition = 0 or ps.fPosition > #{resultMap.position})
            and ps.fCreateDate >= DATE_SUB(CURRENT_DATE(), INTERVAL #{resultMap.day} DAY)
        GROUP BY ps.fCustomerKeywordUuid
        HAVING count(1) >=#{resultMap.day}
    </select>

    <update id="updateCustomerKeywordGroupNameByRank">
        UPDATE t_customer_keyword SET fOptimizeGroupName = #{targetGroupName} WHERE fUuid IN
        <foreach item="item" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <delete id="deleteCustomerKeywordsByUuid">
        delete from t_customer_keyword where fUuid IN
        <foreach item="item" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="selectAllKeywordAndUrl" resultType="java.util.Map">
        SELECT
        fKeyword AS 'keyword',
        fUrl AS 'url'
        FROM
        t_customer_keyword
        WHERE fCustomerUuid = #{customerUuid}
        AND fTerminalType = #{terminalType}
        AND fStatus = 1
    </select>

    <delete id="deleteCustomerKeywordsByCustomerUuid">
        delete from t_customer_keyword where fCustomerUuid = #{customerUuid}
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitleAndUrl">
        delete from t_customer_keyword where fTerminalType = #{terminalType} AND fType = #{entryType} AND fCustomerUuid = #{customerUuid} AND (fTitle = '' or fTitle IS null) AND (fUrl = '' or fUrl IS NULL)
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitle">
        delete from t_customer_keyword where fTerminalType = #{terminalType} AND fType = #{entryType} AND fCustomerUuid = #{customerUuid} AND (fTitle = '' or fTitle IS null)
    </delete>

    <delete id="deleteCustomerKeywords">
        delete from t_customer_keyword where fTerminalType = #{terminalType} AND fOptimizeGroupName = #{groupName} AND fKeyword = #{keyword}
    </delete>

    <select id="getGroups" resultType="String">
        SELECT ck.fOptimizeGroupName as 'group' FROM t_customer_keyword ck WHERE ck.fStatus = 1
        <if test="customerUuids != null">
            AND ck.fCustomerUuid IN
            <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND ck.fOptimizeGroupName &gt; '' GROUP BY ck.fOptimizeGroupName
    </select>

    <update id="cleanBigKeywordIndicator">
        UPDATE t_customer_keyword SET fBigKeyword = 0 WHERE fOptimizeGroupName = #{groupName}
    </update>

    <update id="setBigKeywordIndicator">
        UPDATE t_customer_keyword SET fBigKeyword = 1 WHERE fUuid IN
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="getEntryTypes" resultType="String">
        SELECT ck.fType as typeName FROM t_customer_keyword ck WHERE ck.fOptimizeGroupName = #{groupName} AND ck.fStatus = 1 limit 1
    </select>

    <select id="fetchOptimizationCompletedGroupNames" resultType="String">
        SELECT
        ck.fOptimizeGroupName AS 'groupName'
        FROM t_customer_keyword ck
        WHERE ck.fOptimizeRemainingCount > 1
        AND ck.fStatus = 1
        AND ck.fType IN (#{typesStr})
        AND ck.fInvalidRefreshCount &lt; #{maxInvalidCount}
        GROUP BY ck.fOptimizeGroupName
        HAVING count(1) = 0
    </select>

    <update id="resetOptimizationInfoForNoOptimizeDate" timeout="200000">
        UPDATE t_customer_keyword SET fOptimizedCount = 0, fOptimizeTodayCount = fOptimizePlanCount * ROUND((RAND()*0.7+0.5),1), fQueryInterval = (24*60*60)/fOptimizeTodayCount, fOptimizeRemainingCount = fOptimizePlanCount, fInvalidRefreshCount = 0, fInvalidFlag = 0, fOptimizeDate = CURRENT_DATE(), fQueryCount = 0, fQueryDate = CURRENT_DATE(), fQueryTime = DATE_ADD(NOW(), INTERVAL ROUND(RAND(1000)*1000) SECOND) WHERE fOptimizeDate IS NULL
    </update>

    <update id="resetOptimizationInfo">
        UPDATE t_customer_keyword SET fOptimizedCount = 0, fOptimizeTodayCount = fOptimizePlanCount * ROUND((RAND()*0.7+0.5),1), fQueryInterval = (24*60*60)/fOptimizeTodayCount, fOptimizeRemainingCount = fOptimizePlanCount, fInvalidRefreshCount = 0, fInvalidFlag = 0, fOptimizeDate = CURRENT_DATE(), fQueryCount = 0, fQueryDate = CURRENT_DATE(), fQueryTime = DATE_ADD(NOW(), INTERVAL ROUND(RAND(1000)*1000) SECOND) WHERE fOptimizeDate <![CDATA[<]]> CURRENT_DATE() LIMIT 200000
    </update>

    <select id="searchRemainingOptimizationCount" resultType="java.util.Map">
        SELECT ck.fUuid as 'uuid', fOptimizeRemainingCount AS 'remainingCount' FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName = #{groupName} AND ck.fOptimizeRemainingCount > 1 and ck.fStatus = 1
        and ck.fInvalidRefreshCount <![CDATA[<]]> #{maxInvalidCount}
        ORDER BY ck.fOptimizeRemainingCount DESC
    </select>

    <select id="fetchCustomerKeywordsForCache" resultType="com.keymanager.monitoring.vo.OptimizationKeywordVO">
        SELECT
            ck.fUuid              AS 'uuid',
            ck.fTerminalType      AS 'terminalType',
            ck.fKeyword           AS 'keyword',
            ck.fUrl               AS 'url',
            ck.fBearPawNumber     AS 'bearPawNumber',
            ck.fType              AS 'entryType',
            ck.fTitle             AS 'title',
            ck.fSearchEngine      AS 'searchEngine',
            ck.fOptimizeGroupName AS 'optimizeGroup',
            ck.fOptimizedCount	  AS 'optimizedCount',
            ck.fQueryInterval	  AS 'queryInterval'
        FROM t_customer_keyword ck
        WHERE ck.fMachineGroup = #{machineGroup}
        AND ck.fStatus = 1
        AND ck.fTerminalType = #{terminalType}
        AND ck.fQueryTime <![CDATA[<]]> NOW()
        AND ck.fInvalidFlag = 0
        ORDER BY ck.fQueryTime
        LIMIT #{batchCount}
    </select>

    <select id="getCustomerKeywordUuidForOptimization" resultType="Long">
        SELECT
        ck.fUuid	AS	'uuid'
        FROM t_customer_keyword ck
        WHERE ck.fOptimizeGroupName = #{groupName} and ck.fStatus = 1 and ck.fTerminalType = #{terminalType}
        and ck.fQueryTime <![CDATA[<]]> NOW()
        and ck.fInvalidFlag = 0
        and ck.fBigKeyword = #{bigKeyword}
        order by ck.fQueryTime limit 1
    </select>

    <select id="getCustomerKeywordForOptimization" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fCustomerUuid AS 'customerUuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fType	AS	'type',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fTitle	AS	'title',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fOptimizeGroupName	AS	'optimizeGroupName',
        ck.fRecommendKeywords AS 'recommendKeywords',
        ck.fNegativeKeywords AS 'negativeKeywords',
        ck.fExcludeKeywords AS 'excludeKeywords',
        ck.fOperateSelectKeyword AS 'operateSelectKeyword',
        ck.fOperateRelatedKeyword AS 'operateRelatedKeyword',
        ck.fOperateRecommendKeyword AS 'operateRecommendKeyword',
        ck.fOperateSearchAfterSelectKeyword AS 'operateSearchAfterSelectKeyword',
        ck.fClickUrl AS 'clickUrl',
        ck.fShowPage AS 'showPage',
        ck.fRelatedKeywordPercentage AS 'relatedKeywordPercentage',
        ck.fRemarks AS 'remarks',
        ck.fCt as 'ct',
        ck.fFromSource as 'fromSource'
        FROM t_customer_keyword ck
        WHERE ck.fUuid = #{uuid}
    </select>

    <select id="getCustomerKeywordFee" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
          ck.fUuid                 AS 'uuid',
          ck.fPositionFirstFee     AS 'positionFirstFee',
          ck.fPositionSecondFee    AS 'positionSecondFee',
          ck.fPositionThirdFee     AS 'positionThirdFee',
          ck.fPositionForthFee     AS 'positionForthFee',
          ck.fPositionFifthFee     AS 'positionFifthFee',
          ck.fPositionFirstPageFee AS 'positionFirstPageFee'
        FROM t_customer_keyword ck
        WHERE ck.fUuid = #{uuid}
    </select>

    <update id="updateOptimizationQueryTime">
        UPDATE t_customer_keyword
        SET fQueryDate = CURRENT_DATE(),
        fQueryCount = fQueryCount + 1,
        fInvalidRefreshCount = fInvalidRefreshCount + 1,
        fQueryTime = DATE_ADD(fQueryTime, INTERVAL (IF ((ROUND(RAND(),1) &lt; 0.5), ROUND(fQueryInterval * ROUND(RAND() + 1)), ROUND(fQueryInterval * ROUND(RAND() * 0.4 + 0.1)))) SECOND ),
        fInvalidFlag = if(fInvalidRefreshCount > 8, 1, 0)
        WHERE fUuid IN
        <foreach item="uuid" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateOptimizationQueryTimeSingle">
        UPDATE t_customer_keyword set fQueryDate = CURRENT_DATE(), fQueryCount = fQueryCount + 1, fInvalidRefreshCount = fInvalidRefreshCount + 1, fQueryTime = DATE_ADD(fQueryTime, INTERVAL (fQueryInterval + ROUND(RAND(10)*10))  SECOND ),
        fInvalidFlag = if(fInvalidRefreshCount > #{maxInvalidCount}, 1, 0)
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="updateOptimizationResult">
        UPDATE t_customer_keyword
        SET fLastOptimizeDateTime = now(), fOptimizedCount = fOptimizedCount + #{count}, fQueryTime = if(fOptimizePlanCount > fOptimizedCount, fQueryTime, DATE_ADD(NOW(), INTERVAL 1 DAY)),
        <if test="count > 0">fInvalidRefreshCount = 0, fInvalidFlag = 0, fOptimizeRemainingCount = fOptimizeRemainingCount - 1, </if>
        fUpdateTime = NOW()
		WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="batchUpdateOptimizedCount">
        UPDATE t_customer_keyword
        SET fLastOptimizeDateTime = now(), fOptimizedCount = fOptimizedCount + 1,fOptimizeTodayCount = fOptimizePlanCount * ROUND(rand()*0.7+0.5,1), fOptimizeRemainingCount = fOptimizeRemainingCount - 1, fInvalidRefreshCount = 0, fInvalidFlag = 0,
        fUpdateTime = NOW(), fQueryTime = if(fOptimizePlanCount > fOptimizedCount, fQueryTime, DATE_ADD(NOW(), INTERVAL 1 DAY))
        WHERE fUuid IN
        <foreach item="uuid" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="searchCustomerKeywordsForAdjustingOptimizationCount" resultType="java.util.Map">
        SELECT
            ck.fUuid AS 'uuid',
            ck.fKeyword AS 'keyword',
            ck.fUrl AS 'url',
            ck.fCurrentIndexCount AS 'currentIndexCount',
            ck.fPositionFirstFee AS 'positionFirstFee',
            GROUP_CONCAT(CAST(ps.fPosition AS CHAR) ORDER BY ps.fCreateDate) AS 'positions'
        FROM t_customer_keyword ck JOIN t_ck_position_summary ps ON ck.fUuid = ps.fCustomerKeywordUuid
		WHERE ps.fCreateDate >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY) and ck.fCurrentIndexCount >= 0
		AND ck.fStatus = 1 AND ck.fOptimizeGroupName
        IN
        <foreach item="item" index="index" collection="groupNames" open="(" separator="," close=")">
            #{item}
        </foreach>
		GROUP BY ck.fUuid, ck.fKeyword
    </select>

    <select id="searchKeywordsForAdjustingOptimizationCount" resultType="java.util.Map">
        SELECT ck.fUuid AS 'uuid', ck.fKeyword as 'keyword', ck.fUrl as 'url', ck.fCurrentIndexCount as 'currentIndexCount',
        GROUP_CONCAT(CAST(ps.fPosition AS CHAR) ORDER BY ps.fCreateDate) AS 'positions'
        FROM t_customer_keyword ck JOIN t_ck_position_summary ps ON ck.fUuid = ps.fCustomerKeywordUuid
        WHERE ps.fCreateDate >= DATE_SUB(CURRENT_DATE(), INTERVAL 3 DAY) and ck.fCurrentIndexCount is not NULL
        AND ck.fStatus = 1 AND ck.fType =  #{type}
        GROUP BY ck.fUuid, ck.fKeyword
    </select>

    <update id="adjustOptimizePlanCount">
        UPDATE t_customer_keyword
        SET fOptimizePlanCount = #{optimizationPlanCount}, fOptimizeRemainingCount = #{optimizationPlanCount}, fQueryInterval = #{queryInterval}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <select id="getCustomerKeywordUuidForCapturePosition" resultType="Long">
        SELECT
        ck.fUuid	AS	'uuid'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType} and ck.fStatus = 1
        AND fCaptureStatus = #{captureStatus}
        <if test="startTime != null and captureStatus == 0">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> #{startTime}
            AND !(ck.fCapturePositionQueryTime > CURRENT_DATE() AND ck.fCurrentPosition &lt; 4 AND ck.fCurrentPosition &gt; 0)
        </if>
        <if test="startTime != null and captureStatus == 1">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> DATE_SUB( NOW(), INTERVAL 3 MINUTE )
        </if>
        <if test="customerUuid != null">
            AND ck.fCustomerUuid = #{customerUuid}
        </if>
        <choose>
            <when test="groupNames != null">
                AND ck.fOptimizeGroupName IN
                <foreach item="item" index="index" collection="groupNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                AND ck.fOptimizeGroupName IS NULL
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <select id="getCustomerKeywordUuidForCapturePositionTemp" resultType="Long">
        SELECT
        ck.fUuid AS 'uuid'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType}
        AND ck.fStatus = 1
        AND fCaptureStatus = #{captureStatus}
        <if test="startTime != null and captureStatus == 0">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> #{startTime}
            AND !(ck.fCapturePositionQueryTime > CURRENT_DATE() AND ck.fCurrentPosition &lt; 4 AND ck.fCurrentPosition &gt; 0)
        </if>
        <if test="startTime != null and captureStatus == 1">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> DATE_SUB( NOW(), INTERVAL 3 MINUTE )
        </if>
        <if test="customerUuid != null">
            AND ck.fCustomerUuid = #{customerUuid}
        </if>
        <if test="groupName != null">
            AND ck.fOptimizeGroupName = #{groupName}
        </if>
        LIMIT 10
    </select>

    <select id="getCustomerKeywordForCapturePosition" resultType="com.keymanager.monitoring.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fTitle	AS	'title',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword ck
        WHERE ck.fUuid = #{uuid}
    </select>

    <select id="getCustomerKeywordForCapturePositionTemp" resultType="com.keymanager.value.CustomerKeywordForCapturePosition">
        SELECT
            ck.fUuid AS 'uuid',
            ck.fTerminalType AS	'terminalType',
            ck.fKeyword	AS 'keyword',
            ck.fUrl	AS 'url',
            ck.fTitle AS 'title',
            ck.fSearchEngine AS	'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
        FROM
            t_customer_keyword ck
        WHERE
            ck.fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </select>

    <update id="resetInvalidRefreshCount" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordRefreshStatInfoCriteria">
        UPDATE t_customer_keyword SET fInvalidRefreshCount = 0, fInvalidFlag = 0, fQueryTime = CURRENT_DATE() WHERE fType = #{customerKeywordRefreshStatInfoCriteria.entryType} and fTerminalType = #{customerKeywordRefreshStatInfoCriteria.terminalType}
        <if test="customerKeywordRefreshStatInfoCriteria.customerName!=null and customerKeywordRefreshStatInfoCriteria.customerName!=''">AND EXISTS (SELECT 1 FROM t_customer c WHERE c.fUuid = fCustomerUuid AND c.fContactPerson LIKE concat('%', #{customerKeywordRefreshStatInfoCriteria.customerName}, '%'))</if>
        <if test="customerKeywordRefreshStatInfoCriteria.groupName!=null and customerKeywordRefreshStatInfoCriteria.groupName!=''">
            <choose>
                <when test="customerKeywordRefreshStatInfoCriteria.fullMatchGroup == true">
                    AND fOptimizeGroupName = #{customerKeywordRefreshStatInfoCriteria.groupName}
                </when>
                <otherwise>
                    AND fOptimizeGroupName LIKE concat(#{customerKeywordRefreshStatInfoCriteria.groupName}, '%')
                </otherwise>
            </choose>
        </if>
        <if test="customerKeywordRefreshStatInfoCriteria.machineGroup!=null and customerKeywordRefreshStatInfoCriteria.machineGroup!=''">
            <choose>
                <when test="customerKeywordRefreshStatInfoCriteria.fullMatchGroup == true">
                    AND fMachineGroup = #{customerKeywordRefreshStatInfoCriteria.machineGroup}
                </when>
                <otherwise>
                    AND fMachineGroup LIKE concat(#{customerKeywordRefreshStatInfoCriteria.machineGroup}, '%')
                </otherwise>
            </choose>
        </if>
    </update>

    <update id="updateCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fUuid IN
        <foreach item="uuid"  collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateCapturePositionQueryTimeAndCaptureStatus">
        UPDATE t_customer_keyword SET fCaptureStatus = 1,
        fCapturePositionQueryTime = NOW()
        WHERE fUuid = #{uuid}
    </update>

    <update id="updateCapturePositionQueryTimeAndCaptureStatusTemp">
        UPDATE
            t_customer_keyword
        SET
            fCaptureStatus = 1,
            fCapturePositionQueryTime = NOW()
        WHERE
            fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="getCustomerKeywordForAutoUpdateNegative" resultType="com.keymanager.monitoring.vo.SearchEngineResultVO">
        SELECT DISTINCT
          ck.fKeyword as 'keyword',
          ck.fCustomerUuid as 'customerUuid',
          ck.fOptimizeGroupName as 'group'
        FROM t_customer_keyword ck
        WHERE ck.fType = 'fm'
            <if test="groupName != null and groupName != ''">AND ck.fOptimizeGroupName = #{groupName}</if>
            AND ck.fTerminalType = #{terminalType}
            AND ck.fStatus = 1
            AND (ck.fAutoUpdateNegativeDateTime is null or DATE_ADD(ck.fAutoUpdateNegativeDateTime, INTERVAL 3 MINUTE) &lt; NOW())
        ORDER BY ck.fAutoUpdateNegativeDateTime LIMIT 1
    </select>

    <update id="updateAutoUpdateNegativeTimeAs4MinutesAgo">
        UPDATE t_customer_keyword
        SET fAutoUpdateNegativeDateTime = DATE_ADD(now(), INTERVAL -4 MINUTE)
        WHERE fType = 'fm'
            AND fStatus = 1
            AND fTerminalType = #{terminalType}
            AND fOptimizeGroupName = #{groupName}
    </update>

    <update id="updateAutoUpdateNegativeTime">
        UPDATE t_customer_keyword
        SET fAutoUpdateNegativeDateTime = NOW()
        WHERE fType = 'fm'
        AND fStatus = 1
        AND fKeyword = #{keyword}
        AND fTerminalType = #{terminalType}
        AND fOptimizeGroupName = #{groupName}
    </update>

    <select id="searchGroups" resultType="com.keymanager.monitoring.vo.CodeNameVo">
        select
        fOptimizeGroupName	as 'name'
        from t_customer_keyword
        where
            fOptimizeGroupName is not null
            and fOptimizeGroupName != ''
            GROUP BY fOptimizeGroupName
    </select>

    <select id="searchGroupsByTerminalType" resultType="com.keymanager.monitoring.vo.CodeNameVo">
        SELECT
            fOptimizeGroupName as 'name'
        FROM
            t_customer_keyword
        WHERE
            fTerminalType = #{terminalType}
        AND
            fOptimizeGroupName IS NOT NULL
        AND
            fOptimizeGroupName &gt; ''
        GROUP BY
            fOptimizeGroupName
    </select>

    <select id="searchCustomerKeywordsUuidForCaptureTitle" resultType="Long">
        SELECT
        ck.fUuid  AS `uuid`
        FROM
        t_customer_keyword ck
        WHERE ck.fCapturedTitle = 0
        AND ck.fSearchEngine = #{searchEngine}
        AND ck.fCaptureTitleQueryTime IS NULL
        <if test="qzCaptureTitleLog.terminalType != null and qzCaptureTitleLog.terminalType != ''">
            AND ck.fTerminalType = #{qzCaptureTitleLog.terminalType}
        </if>
        <if test="qzCaptureTitleLog.group != null and qzCaptureTitleLog.group != ''">
            AND ck.fOptimizeGroupName = #{qzCaptureTitleLog.group}
        </if>
        <if test="qzCaptureTitleLog.customerUuid != null and qzCaptureTitleLog.customerUuid != ''">
            AND ck.fCustomerUuid = #{qzCaptureTitleLog.customerUuid}
        </if>
        AND (ck.fTitle IS NULL OR ck.fTitle = '')
        /*LIMIT 1*/

        <if test="batchCount != null and batchCount != 0">
            limit #{batchCount}
        </if>
    </select>

    <select id="searchCustomerKeywordForCaptureTitle" resultType="com.keymanager.value.CustomerKeywordForCaptureTitle">
            SELECT
                ck.fKeyword  AS `keyword`,
                ck.fUrl  AS `url`,
                ck.fUuid  AS `uuid`,
                ck.fBearPawNumber AS 'bearPawNumber',
                ck.fOriginalUrl  AS `wholeUrl`
            FROM
                t_customer_keyword ck
            WHERE ck.fUuid = #{uuid}
    </select>

    <delete id="deleteEmptyTitleCustomerKeyword">
        DELETE
        FROM
            t_customer_keyword
        WHERE
            fCustomerUuid = #{qzCaptureTitleLog.customerUuid}
        AND fTerminalType = #{qzCaptureTitleLog.terminalType}
        AND fType =  #{qzCaptureTitleLog.type}
        AND fSearchEngine =  #{searchEngine}
        AND fOptimizeGroupName =  #{qzCaptureTitleLog.group}
        AND ( fTitle = '' OR  fTitle IS NULL )
        AND fCapturedTitle = 1
        AND fManualCleanTitle  = 0
    </delete>

    <select id="searchCustomerKeywordSummaryInfo" resultType="com.keymanager.monitoring.vo.CustomerKeywordSummaryInfoVO">
        SELECT fKeyword AS keyword, fTerminalType AS terminalType, fStatus AS status
        FROM t_customer_keyword
        WHERE fCustomerUuid = #{customerUuid}
        AND fType = #{entryType}
        GROUP BY fKeyword,fTerminalType
    </select>

    <select id="searchCustomerNegativeKeywords" resultType="java.lang.String">
        SELECT DISTINCT ck.fKeyword
        FROM t_customer_keyword ck
        WHERE fCustomerUuid = #{customerUuid}
        AND fType = 'fm'
        AND fStatus = 1
    </select>

    <update id="updateOptimizePlanCountForBaiduMap">
        UPDATE
            t_customer_keyword
        SET
            fOptimizePlanCount = (SELECT FLOOR(3 + (RAND() * 8))), fOptimizeRemainingCount = fOptimizePlanCount
        WHERE
            fOptimizeGroupName = 'pc_baidumap'
        AND fCurrentPosition BETWEEN 1 AND 3
    </update>

    <update id="updatePosition">
        UPDATE
            t_customer_keyword
        SET
            fCurrentPosition = IF(fLastReachStandardDate = CURRENT_DATE(),IF(#{position} > 0 AND #{position} &lt; fCurrentPosition, #{position}, fCurrentPosition), #{position}),
            fInitialPosition = IFNULL(fInitialPosition, #{position}),
            fCapturePositionQueryTime = IFNULL(#{capturePositionQueryTime}, fCapturePositionQueryTime),
            fTodayFee = if(fLastReachStandardDate = CURRENT_DATE(), if(fTodayFee > #{todayFee} OR #{todayFee} is null, fTodayFee, #{todayFee}), #{todayFee}),
            fCapturePositionIP = #{ip}, fCapturePositionCity = #{city},
            <if test="todayFee != null">
                fLastReachStandardDate = CURRENT_DATE(),
            </if>
            fCaptureStatus = 0,
            fUpdateTime = NOW()
        WHERE fUuid = #{uuid}
    </update>

    <select id="takeOptimizationCountExceptionUsers" resultType="com.keymanager.monitoring.vo.OptimizationCountVO">
        SELECT
            u.fLoginName AS 'loginName',
            u.fEmail AS 'email'
        FROM
            t_userinfo u,
            t_customer c,
            t_customer_keyword ck
        WHERE c.fUuid = ck.fCustomerUuid
        AND c.fUserID = u.fLoginName
        AND u.fEmail > ''
        AND ck.fStatus = 1
        AND ck.fCurrentPosition &gt; 0
        AND (ck.fOptimizedCount = 0 OR ck.fInvalidRefreshCount &gt;= 8)
        GROUP BY u.fLoginName
    </select>

    <select id="observeGroupOptimizationCount" resultType="com.keymanager.monitoring.vo.OptimizationCountVO">
        SELECT
            ck.fOptimizeGroupName AS 'optimizeGroupName',
            COUNT(fOptimizeGroupName) AS 'keywordCount'
        FROM
            t_customer c,
            t_customer_keyword ck
        WHERE c.fUuid = ck.fCustomerUuid
        AND ck.fStatus = 1
        AND ck.fCurrentPosition &gt; 0
        AND ck.fType = 'qz'
        AND c.fUserID = #{userID}
        AND (ck.fOptimizedCount = 0 OR ck.fInvalidRefreshCount &gt;= 8)
        GROUP BY fOptimizeGroupName
    </select>

    <select id="observeKeywordOptimizationCount" resultType="com.keymanager.monitoring.vo.OptimizationCountVO">
        SELECT
            ck.fKeyword AS 'keyword',
            ck.fUrl AS 'url',
            ck.fOptimizedCount AS 'optimizedCount',
            ck.fInvalidRefreshCount AS 'invalidRefreshCount'
        FROM
            t_customer c,
            t_customer_keyword ck
        WHERE c.fUuid = ck.fCustomerUuid
        AND ck.fStatus = 1
        AND ck.fCurrentPosition &gt; 0
        AND ck.fType IN ('fm', 'pt', 'bc')
        AND c.fUserID = #{userID}
        AND (ck.fOptimizedCount = 0 OR ck.fInvalidRefreshCount &gt;= 8)
    </select>

    <update id="editCustomerOptimizePlanCount">
        UPDATE t_customer_keyword
        <if test="settingType == 'setCurrentCount'">
            SET fOptimizePlanCount = IF((fOptimizePlanCount + (#{optimizePlanCount})) > 0, (fOptimizePlanCount + (#{optimizePlanCount})), 0)
        </if>
        <if test="settingType == 'setSpecificCount'">
            SET fOptimizePlanCount = #{optimizePlanCount}
        </if>
        , fOptimizeRemainingCount = IF(#{optimizePlanCount} - fOptimizedCount > 0, #{optimizePlanCount} - fOptimizedCount, 0)
        , fQueryInterval = IF(fOptimizePlanCount > 0, (24 * 60 * 60 / fOptimizePlanCount), 24 * 60 * 60)
        WHERE fUuid IN
        <foreach item="uuid"  collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="editOptimizePlanCountByCustomerUuid">
        UPDATE t_customer_keyword
        <if test="settingType == 'setCurrentCount'">
            SET fOptimizePlanCount = IF((fOptimizePlanCount + (#{optimizePlanCount})) > 0, (fOptimizePlanCount + (#{optimizePlanCount})), 0)
        </if>
        <if test="settingType == 'setSpecificCount'">
            SET fOptimizePlanCount = #{optimizePlanCount}
        </if>
        , fOptimizeRemainingCount = IF(#{optimizePlanCount} - fOptimizedCount > 0, #{optimizePlanCount} - fOptimizedCount, 0)
        , fQueryInterval = IF(fOptimizePlanCount > 0, (24 * 60 * 60 / fOptimizePlanCount), 24 * 60 * 60)
        WHERE fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fCustomerUuid = #{customerUuid}
    </update>

    <update id="changeCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fCustomerUuid = #{customerUuid}
    </update>

    <update id="batchChangeCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fType = #{entryType}
        AND fCustomerUuid IN
        <foreach item="customerUuid"  collection="customerUuids" open="(" separator="," close=")">
            #{customerUuid}
        </foreach>
    </update>

    <update id="updateOptimizeGroupName" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria">
        UPDATE
            t_customer_keyword ck,t_customer c
        SET
            ck.fOptimizeGroupName = #{customerKeywordCriteria.targetOptimizeGroupName},
            ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <update id="updateBearPawNumber" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria">
        UPDATE
        t_customer_keyword ck,t_customer c
        SET
        ck.fBearPawNumber = #{customerKeywordCriteria.targetBearPawNumber},
        ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <select id="searchCustomerKeywordForNoReachStandard" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="int">
        SELECT
            COUNT(1)
        FROM
            t_customer_keyword ck,
            t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <select id="getCustomerKeywordSummaryInfos" parameterType="java.lang.String" resultType="com.keymanager.monitoring.entity.NegativeList">
        SELECT
            fUuid AS 'uuid',
			fTitle AS 'title',
			fUrl AS 'url'
		FROM t_customer_keyword
		WHERE fType = 'fm'
		AND fKeyword = #{keyword}
		AND fTerminalType = #{terminalType}
		AND fOptimizeRemainingCount &gt; 0
		AND fStatus = 1
    </select>

    <select id="getQZCustomerKeywordSummaryInfos" resultType="com.keymanager.monitoring.vo.KeywordSimpleVO">
        SELECT
            fUuid AS 'uuid',
            fKeyword AS 'keyword',
            fTitle AS 'title',
            fUrl AS 'url'
        FROM t_customer_keyword
        WHERE fType = 'qz'
        AND fTerminalType = #{terminalType}
        AND fOptimizeGroupName = #{optimizeGroupName}
        AND fOptimizeRemainingCount &gt; 0
        AND fStatus = 1
        ORDER BY fQueryTime
        LIMIT 4
    </select>

    <select id="searchKeywordUrlByGroup" resultType="java.lang.String">
        SELECT CONCAT(fUrl, ',', fKeyword) AS 'urlKeyword'
        FROM t_customer_keyword
        WHERE fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fOptimizeGroupName = #{optimizeGroupName}
        AND fKeyword > ''
        AND fUrl > ''
        AND fStatus = 1
    </select>

    <update id="batchUpdatePosition">
        <foreach item="item" index="index" collection="positionVOs" open="" separator=";" close="">
            UPDATE t_customer_keyword
            SET fCurrentPosition = #{item.position}, fCapturePositionQueryTime = NOW()
            <if test="reachStandardPosition &gt; 0 and item.position &gt; 0 and item.position &lt;= reachStandardPosition">
            ,fLastReachStandardDate = CURRENT_DATE()
            </if>
            WHERE fTerminalType = #{terminalType}
            AND fType = #{entryType}
            AND fSearchEngine = #{searchEngine}
            AND fKeyword = #{item.keyword}
            AND fUrl = #{item.url}
        </foreach>
    </update>

    <select id="getBearPawNumberByCustomerUuid" resultType="java.lang.String">
        SELECT fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword
        WHERE fCustomerUuid = #{customerUuid}
        AND fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fBearPawNumber &gt; ''
        LIMIT 1
    </select>

    <update id="batchUpdateRequireDalete">
        <foreach item="item" index="index" collection="requireDeleteKeywordVOs" open="" separator=";" close="">
            UPDATE t_customer_keyword
            SET fRequireDelete = 1
            WHERE fCustomerUuid = #{item.customerUuid}
            AND fType = #{item.entryType}
            AND fTerminalType = #{item.terminalType}
            AND fSearchEngine = #{item.searchEngine}
            AND fKeyword = #{item.keyword}
            AND fUrl = #{item.url}
        </foreach>
    </update>

    <update id="updateCustomerKeywordQueryTime">
        UPDATE t_customer_keyword
        SET fCaptureStatus = 0,
        fCapturePositionQueryTime = #{capturePositionQueryTime}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="updateKeywordCustomerUuid">
        UPDATE t_customer_keyword
        SET  fCustomerUuid = #{customerUuid}
        WHERE
        fTerminalType = #{terminalType}
        AND fUuid IN
        <foreach item = "item" index = "index" collection = "keywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="getCustomerKeywordInfo"  parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria" resultType="java.lang.String">
        SELECT
        DISTINCT
        ck.fKeyword	AS	'keyword'
        FROM
        t_customer_keyword ck
        WHERE 1 = 1
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>
    <update id="moveOutNoRankingCustomerKeyword">
        UPDATE t_customer_keyword
        SET fOptimizeGroupName = (
            SELECT c.fValue FROM t_config c
            WHERE c.fConfigType = #{noRankOptimizeGroupNameConfigType}
            AND c.fKey = CONCAT(fSearchEngine, '_', fTerminalType)
        ), fMachineGroup = 'no'
        WHERE fOptimizedCount = 0
        AND (fCurrentPosition = 0 OR fCurrentPosition > 900)
        AND fQueryCount > 0
        AND fOptimizeGroupName IN
        <foreach item = "item" collection = "monitorConfigs" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="setNoRankingCustomerKeyword">
        UPDATE t_customer_keyword
        SET fOptimizeGroupName = (
            SELECT c.fValue FROM t_config c
            WHERE c.fConfigType = #{noRankOptimizeGroupNameConfigType}
            AND c.fKey = CONCAT(fSearchEngine, '_', fTerminalType)
        ), fMachineGroup = 'no'
        WHERE fUuid IN
        <foreach item = "item" collection = "needMoveUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="moveOutDefaultCustomerKeyword">
        UPDATE t_customer_keyword ck
        SET ck.fOptimizeGroupName = (
            SELECT c.fValue
            FROM t_config c
            WHERE c.fConfigType = #{defaultOptimizeGroupNameConfigType}
            AND c.fKey = CONCAT(ck.fSearchEngine, '_', ck.fTerminalType)
        ), ck.fMachineGroup = ck.fType
        WHERE (ck.fOptimizedCount &gt; 0 OR ck.fCurrentPosition &gt; 0)
        AND ck.fOptimizeGroupName IN
        <foreach item = "item" collection = "noRankConfigs" open="(" separator="," close=")">
            #{item.value}
        </foreach>
    </update>

    <update id="updateCustomerKeywordsTitle">
        <foreach collection="searchEngineResultItemVOs" item="item" open="" separator=";" close="">
        UPDATE t_customer_keyword SET
            fUrl = #{item.url},
            fTitle = #{item.title},
            fInitialPosition = #{item.order},
            fCurrentPosition = #{item.order},
            fCapturedTitle = 1
            WHERE fUuid = #{item.uuid}
        </foreach>
    </update>

    <select id="sortCustomerKeywordForOptimize" resultType="com.keymanager.monitoring.vo.CustomerKeywordSortVO">
        SELECT
            fKeyword AS 'keyword',
            fTerminalType AS 'terminalType',
            fSearchEngine AS 'searchEngine',
            GROUP_CONCAT(CONCAT(fCurrentPosition, '_', fUuid) ORDER BY fCurrentPosition,fPositionFirstFee DESC SEPARATOR ',') AS 'uuids'
        FROM t_customer_keyword
        WHERE fOptimizeGroupName IN
        <foreach item = "item" collection = "monitorConfigs" open="(" separator="," close=")">
            #{item}
        </foreach>
        and fStatus = 1
        GROUP BY fKeyword,fTerminalType,fSearchEngine
        HAVING count(1) &gt; 10
    </select>

    <update id="updateCustomerKeywordCt">
        UPDATE t_customer_keyword SET fCt = #{ct}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="updateCustomerKeywordFromSource">
        UPDATE t_customer_keyword SET fFromSource = #{fromSource}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <select id="searchDuplicateKeywords" resultType="java.lang.String">
        SELECT
            GROUP_CONCAT(CAST(fUuid AS CHAR) ORDER BY fUuid) AS 'uuids'
        FROM
            t_customer_keyword
        WHERE
            fType = #{customerKeywordCriteria.entryType}
            AND fTerminalType =  #{customerKeywordCriteria.terminalType}
        <if test="customerKeywordCriteria.customerUuid != null and customerKeywordCriteria.customerUuid != ''">
            AND fCustomerUuid = #{customerKeywordCriteria.customerUuid}
        </if>
        GROUP BY fKeyword,fUrl, fCustomerUuid
        HAVING COUNT(1) > 1
    </select>
    
    <update id="batchUpdateKeywordStatus">
        UPDATE t_customer_keyword
        SET fTerminalType = fTerminalType
        <if test="keywordChecks.keyword==1">,fKeyword = #{keywordStatus.keyword}</if>
        <if test="keywordChecks.title==1"> ,fTitle = #{keywordStatus.title}</if>
        <if test="keywordChecks.bearPawNumber==1"> ,fBearPawNumber = #{keywordStatus.bearPawNumber}</if>
        <if test="keywordChecks.url==1"> ,fUrl = #{keywordStatus.url}</if>
        <if test="keywordChecks.originalUrl==1"> ,fOriginalUrl = #{keywordStatus.originalUrl}</if>
        <if test="keywordChecks.optimizePlanCount==1">
            , fOptimizePlanCount = #{keywordStatus.optimizePlanCount}
            , fOptimizeRemainingCount = IF(#{keywordStatus.optimizePlanCount} - fOptimizedCount > 0, #{keywordStatus.optimizePlanCount} - fOptimizedCount, 0)
            , fQueryInterval = IF(fOptimizePlanCount > 0, (24 * 60 * 60 / fOptimizePlanCount), 24 * 60 * 60)
        </if>
        <if test="keywordChecks.optimizeGroupName==1"> ,fOptimizeGroupName = #{keywordStatus.optimizeGroupName}</if>
        <if test="keywordChecks.machineGroup==1"> ,fMachineGroup = #{keywordStatus.machineGroup}</if>
        <if test="keywordChecks.initialIndexCount==1"> ,fInitialIndexCount = #{keywordStatus.initialIndexCount}</if>
        <if test="keywordChecks.initialPosition==1"> ,fInitialPosition = #{keywordStatus.initialPosition}</if>
        <if test="keywordChecks.positionFirstFee==1"> ,fPositionFirstFee = #{keywordStatus.positionFirstFee}</if>
        <if test="keywordChecks.positionSecondFee==1"> ,fPositionSecondFee = #{keywordStatus.positionSecondFee}</if>
        <if test="keywordChecks.positionThirdFee==1"> ,fPositionThirdFee = #{keywordStatus.positionThirdFee}</if>
        <if test="keywordChecks.positionForthFee==1"> ,fPositionForthFee = #{keywordStatus.positionForthFee}</if>
        <if test="keywordChecks.positionFifthFee==1"> ,fPositionFifthFee = #{keywordStatus.positionFifthFee}</if>
        <if test="keywordChecks.positionFirstPageFee==1"> ,fPositionFirstPageFee = #{keywordStatus.positionFirstPageFee}</if>
        <if test="keywordChecks.serviceProvider==1"> ,fServiceProvider = #{keywordStatus.serviceProvider}</if>
        <if test="keywordChecks.keywordEffect==1"> ,fKeywordEffect = #{keywordStatus.keywordEffect}</if>
        <if test="keywordChecks.collectMethod==1"> ,fCollectMethod = #{keywordStatus.collectMethod}</if>
        <if test="keywordChecks.searchEngine==1"> ,fSearchEngine = #{keywordStatus.searchEngine}</if>
        <if test="keywordChecks.city==1"> ,fCity = #{keywordStatus.city}</if>
        <if test="keywordChecks.sequence==1"> ,fSequence = #{keywordStatus.sequence}</if>
        <if test="keywordChecks.orderNumber==1"> ,fOrderNumber = #{keywordStatus.orderNumber}</if>
        <if test="keywordChecks.paymentStatus==1"> ,fPaymentStatus = #{keywordStatus.paymentStatus}</if>
        <if test="keywordChecks.recommendKeywords==1"> ,fRecommendKeywords = #{keywordStatus.recommendKeywords}</if>
        <if test="keywordChecks.negativeKeywords==1"> ,fNegativeKeywords = #{keywordStatus.negativeKeywords}</if>
        <if test="keywordChecks.excludeKeywords==1"> ,fExcludeKeywords = #{keywordStatus.excludeKeywords}</if>
        <if test="keywordChecks.showPage==1"> ,fShowPage = #{keywordStatus.showPage}</if>
        <if test="keywordChecks.relatedKeywordPercentage==1"> ,frelatedKeywordPercentage = #{keywordStatus.relatedKeywordPercentage}</if>
        <if test="keywordChecks.remarks==1"> ,fRemarks = #{keywordStatus.remarks}</if>
        <if test="keywordChecks.positionFirstCost==1"> ,fPositionFirstCost = #{keywordStatus.positionFirstCost}</if>
        <if test="keywordChecks.positionSecondCost==1"> ,fPositionSecondCost = #{keywordStatus.positionSecondCost}</if>
        <if test="keywordChecks.positionThirdCost==1"> ,fPositionThirdCost = #{keywordStatus.positionThirdCost}</if>
        <if test="keywordChecks.positionForthCost==1"> ,fPositionForthCost = #{keywordStatus.positionForthCost}</if>
        <if test="keywordChecks.positionFifthCost==1"> ,fPositionFifthCost = #{keywordStatus.positionFifthCost}</if>
        <if test="keywordChecks.operateSelectKeyword==1"> ,fOperateSelectKeyword = #{keywordStatus.operateSelectKeyword}</if>
        <if test="keywordChecks.operateRelatedKeyword==1"> ,fOperateRelatedKeyword = #{keywordStatus.operateRelatedKeyword}</if>
        <if test="keywordChecks.operateRecommendKeyword==1"> ,fOperateRecommendKeyword = #{keywordStatus.operateRecommendKeyword}</if>
        <if test="keywordChecks.operateSearchAfterSelectKeyword==1"> ,fOperateSearchAfterSelectKeyword = #{keywordStatus.operateSearchAfterSelectKeyword}</if>
        <if test="keywordChecks.clickUrl==1"> ,fClickUrl = #{keywordStatus.clickUrl}</if>
        <if test="keywordChecks.failedCause == 1"> ,fFailedCause = NULL</if>
        WHERE fUuid IN
        <foreach item="keywordID" collection="keywordIDs" open="(" separator="," close=")">
            #{keywordID}
        </foreach>
    </update>

    <select id="getCustomerUuids" resultType="java.lang.Long">
        SELECT DISTINCT ck.fCustomerUuid
        FROM t_customer_keyword ck
        WHERE ck.fType =  #{entryType}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fStatus = 1
    </select>

    <update id="excludeCustomerKeyword" parameterType="com.keymanager.monitoring.entity.CustomerKeyword">
        UPDATE  t_customer_keyword ck
        SET ck.fStatus = 3
        WHERE 1=1
        <if test="qzSettingExcludeCustomerKeywordsCriteria.customerUuid != null and qzSettingExcludeCustomerKeywordsCriteria.customerUuid != ''">
          AND ck.fCustomerUuid = #{qzSettingExcludeCustomerKeywordsCriteria.customerUuid}
        </if>
        AND ck.fType = #{qzSettingExcludeCustomerKeywordsCriteria.type}
        AND ck.fTerminalType = #{qzSettingExcludeCustomerKeywordsCriteria.terminalType}
        AND ck.fKeyword IN
        <foreach item = "keyword" collection = "qzSettingExcludeCustomerKeywordsCriteria.keywords" open="(" separator="," close=")">
            #{keyword}
        </foreach>
        AND ck.fUrl like '%${qzSettingExcludeCustomerKeywordsCriteria.domain}%'
    </update>

    <select id="getCheckEnteredKeywords" resultType="com.keymanager.monitoring.vo.CustomerKeywordEnteredVO">
        SELECT
            ck.fUuid          AS 'uuid',
            ck.fTerminalType  AS 'terminalType',
            ck.fTitle         AS 'title',
            ck.fKeyword	      AS 'keyword',
            ck.fUrl	          AS 'url',
            ck.fSearchEngine  AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword ck
        WHERE ck.fOptimizedCount = 0
        AND ck.fInvalidRefreshCount &gt;= 4
        AND ck.fStatus = 1
        AND (ck.fVerifyEnteredKeywordTime IS NULL OR (ck.fVerifyEnteredKeywordTime &lt; CURRENT_DATE()) OR (ck.fFailedCause = '爬取中' AND ck.fVerifyEnteredKeywordTime &lt;= DATE_SUB(NOW(), INTERVAL 20 MINUTE)))
        LIMIT 500
    </select>

    <update id="updateVerifyEnteredKeywordTimeByUuids">
        UPDATE t_customer_keyword
        SET fVerifyEnteredKeywordTime = NOW(), fFailedCause = '爬取中'
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateCheckingEnteredKeywords">
        <foreach collection="customerKeywords" item="customerKeyword" separator=";">
            UPDATE t_customer_keyword
            SET fFailedCause = #{customerKeyword.failedCause}
            WHERE fUuid = #{customerKeyword.uuid}
        </foreach>
    </update>

    <insert id="addCustomerKeywords">
        INSERT INTO t_customer_keyword (
            fTerminalType,
            fCustomerUuid,
            fQZSettingUuid,
            fKeyword,
            fUrl,
            fType,
            fBearPawNumber,
            fOriginalUrl,
            fTitle,
            fSequence,
            fAutoUpdateNegativeDateTime,
            fSearchEngine,
            fInitialIndexCount,
            fCurrentIndexCount,
            fCurrentPosition,
            fQueryDate,
            fQueryTime,
            fServiceProvider,
            fOptimizeGroupName,
            fMachineGroup,
            fOptimizePlanCount,
            fOptimizeRemainingCount,
            fLastReachStandardDate,
            fPositionFirstFee,
            fPositionSecondFee,
            fPositionThirdFee,
            fPositionForthFee,
            fPositionFifthFee,
            fPositionFirstPageFee,
            fCapturePositionQueryTime,
            fCollectMethod,
            fStartOptimizedTime,
            fOrderNumber,
            fStatus,
            fManualCleanTitle,
            fKeywordEffect,
            fCustomerKeywordSource,
            fRemarks,
            fUpdateTime,
            fCreateTime
        )
        VALUES
        <foreach collection="customerKeywords" item="customerKeyword" separator=",">
            (
                #{customerKeyword.terminalType},
                #{customerKeyword.customerUuid},
                #{customerKeyword.qzSettingUuid},
                #{customerKeyword.keyword},
                #{customerKeyword.url},
                #{customerKeyword.type},
                #{customerKeyword.bearPawNumber},
                #{customerKeyword.originalUrl},
                #{customerKeyword.title},
                #{customerKeyword.sequence},
                #{customerKeyword.autoUpdateNegativeDateTime},
                #{customerKeyword.searchEngine},
                #{customerKeyword.initialIndexCount},
                #{customerKeyword.currentIndexCount},
                #{customerKeyword.currentPosition},
                #{customerKeyword.queryDate},
                #{customerKeyword.queryTime},
                #{customerKeyword.serviceProvider},
                #{customerKeyword.optimizeGroupName},
                #{customerKeyword.machineGroup},
                <choose>
                    <when test="customerKeyword.optimizePlanCount != null">#{customerKeyword.optimizePlanCount},</when>
                    <when test="customerKeyword.optimizePlanCount == null">0,</when>
                </choose>
                #{customerKeyword.optimizeRemainingCount},
                #{customerKeyword.lastReachStandardDate},
                <choose>
                    <when test="customerKeyword.positionFirstFee != null">#{customerKeyword.positionFirstFee},</when>
                    <when test="customerKeyword.positionFirstFee == null">0.00,</when>
                </choose>
                <choose>
                    <when test="customerKeyword.positionSecondFee != null">#{customerKeyword.positionSecondFee},</when>
                    <when test="customerKeyword.positionSecondFee == null">0.00,</when>
                </choose>
                <choose>
                    <when test="customerKeyword.positionThirdFee != null">#{customerKeyword.positionThirdFee},</when>
                    <when test="customerKeyword.positionThirdFee == null">0.00,</when>
                </choose>
                <choose>
                    <when test="customerKeyword.positionForthFee != null">#{customerKeyword.positionForthFee},</when>
                    <when test="customerKeyword.positionForthFee == null">0.00,</when>
                </choose>
                <choose>
                    <when test="customerKeyword.positionFifthFee != null">#{customerKeyword.positionFifthFee},</when>
                    <when test="customerKeyword.positionFifthFee == null">0.00,</when>
                </choose>
                <choose>
                    <when test="customerKeyword.positionFirstPageFee != null">#{customerKeyword.positionFirstPageFee},</when>
                    <when test="customerKeyword.positionFirstPageFee == null">0.00,</when>
                </choose>
                #{customerKeyword.capturePositionQueryTime},
                #{customerKeyword.collectMethod},
                #{customerKeyword.startOptimizedTime},
                #{customerKeyword.orderNumber},
                #{customerKeyword.status},
                <choose>
                    <when test="customerKeyword.manualCleanTitle != null">#{customerKeyword.manualCleanTitle},</when>
                    <when test="customerKeyword.manualCleanTitle == null">0,</when>
                </choose>
                #{customerKeyword.keywordEffect},
                #{customerKeyword.customerKeywordSource},
                #{customerKeyword.remarks},
                #{customerKeyword.updateTime},
                #{customerKeyword.createTime}
            )
        </foreach>
    </insert>

    <select id="getAvailableOptimizationGroups" resultType="java.lang.String">
        SELECT
            ck.fOptimizeGroupName AS 'groupName'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{groupSettingCriteria.terminalType}
        <if test="groupSettingCriteria.optimizedGroupName != null and groupSettingCriteria.optimizedGroupName != ''">
            AND ck.fOptimizeGroupName LIKE '${groupSettingCriteria.optimizedGroupName}%'
        </if>
        AND ck.fOptimizeGroupName > ''
        AND ck.fStatus = 1
        GROUP BY ck.fOptimizeGroupName
    </select>

    <select id="getMachineGroups" resultType="java.lang.String">
        SELECT
          CONCAT(fTerminalType, '####', fMachineGroup, '####', COUNT(1))
        FROM t_machine_info mi
        WHERE fMachineGroup > ''
        GROUP BY fTerminalType, fMachineGroup
    </select>

    <update id="updateSameCustomerKeywordSource">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeywordSource}
        WHERE fKeyword = #{keyword}
        AND fTerminalType = #{terminalType}
        AND fCustomerUuid = #{customerUuid}
        <choose>
            <when test="url == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fUrl = #{url}
            </otherwise>
        </choose>
    </update>

    <update id="updateSimilarCustomerKeywordSource">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeywordSource}
        WHERE fKeyword = #{keyword}
        AND fTerminalType = #{terminalType}
        AND fCustomerUuid = #{customerUuid}
        <choose>
            <when test="originalUrl == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fOriginalUrl <![CDATA[ > ]]> ''
                AND fOriginalUrl like concat('%', #{originalUrl});
            </otherwise>
        </choose>
    </update>

    <update id="updateCustomerKeywordEffect">
        UPDATE t_customer_keyword
        SET fKeywordEffect = 'Appointment'
        WHERE fCustomerUuid = #{customerUuid}
        AND fOptimizeGroupName = #{optimizeGroupName}
        AND fTerminalType = #{terminalType}
        AND fStatus = 1
        AND fKeywordEffect <![CDATA[<>]]> 'Appointment'
    </update>

    <update id="updateMachineGroup" parameterType="com.keymanager.monitoring.criteria.CustomerKeywordCriteria">
            UPDATE t_customer_keyword ck
            SET ck.fMachineGroup = #{customerKeywordCriteria.targetMachineGroup},
            ck.fUpdateTime = NOW()
            WHERE 1=1
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <select id="getCustomerKeywordRankingCount" resultType="com.keymanager.monitoring.vo.CustomerKeywordRankingCountVO">
        SELECT
            COUNT((ck.fCurrentPosition BETWEEN 1 AND 10) OR NULL)  AS 'topTenNum',
            COUNT((ck.fCurrentPosition BETWEEN 1 AND 20) OR NULL)  AS 'topTwentyNum',
            COUNT((ck.fCurrentPosition BETWEEN 1 AND 30) OR NULL)  AS 'topThirtyNum',
            COUNT((ck.fCurrentPosition BETWEEN 1 AND 40) OR NULL)  AS 'topFortyNum',
            COUNT((ck.fCurrentPosition BETWEEN 1 AND 50) OR NULL)  AS 'topFiftyNum'
        FROM t_customer_keyword ck
        WHERE ck.fCustomerUuid = #{customerUuid}
        AND ck.fStatus = 1
        AND ck.fOptimizeGroupName LIKE '${groupName}%'
    </select>

    <select id="getCrawlRankKeywords" resultType="com.keymanager.monitoring.vo.CustomerKeyWordCrawlRankVO">
        SELECT
            ck.fUuid          AS 'uuid',
            ck.fTerminalType  AS 'terminalType',
            ck.fType          AS 'type',
            ck.fCity          AS 'city',
            ck.fTitle         AS 'title',
            ck.fKeyword       AS 'keyword',
            ck.fUrl           AS 'url',
            ck.fSearchEngine  AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword ck
        WHERE ck.fType = #{type}
        AND ck.fSearchEngine = '百度'
        AND ck.fCaptureStatus = 0
        AND ck.fCapturePositionQueryTime &lt; CURRENT_DATE()
        <choose>
            <when test="city != null">AND ck.fCity = #{city}</when>
            <when test="city == null and type == 'pt'">AND ck.fCity IS NULL </when>
        </choose>
        UNION ALL
        SELECT
            ck.fUuid          AS 'uuid',
            ck.fTerminalType  AS 'terminalType',
            ck.fType          AS 'type',
            ck.fCity          AS 'city',
            ck.fTitle         AS 'title',
            ck.fKeyword       AS 'keyword',
            ck.fUrl           AS 'url',
            ck.fSearchEngine  AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword ck
        WHERE ck.fType = #{type}
        AND ck.fSearchEngine = '百度'
        AND ck.fCaptureStatus = 1
        AND ck.fCapturePositionQueryTime &lt;= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
        <choose>
            <when test="city != null">AND ck.fCity = #{city}</when>
            <when test="city == null and type == 'pt'">AND ck.fCity IS NULL </when>
        </choose>
        LIMIT 3000
    </select>

    <update id="updateCrawlRankKeywordTimeByUuids">
        UPDATE t_customer_keyword
        SET
        fCapturePositionQueryTime = NOW(),
        fCaptureStatus = 1
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="getQZSettingKeywordCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM t_customer_keyword ck
        WHERE ck.fCustomerUuid = #{customerUuid}
        AND ck.fStatus = 1
        AND ck.fOptimizeGroupName LIKE '${groupName}%'
    </select>

    <select id="searchKeywordAmountCountList" parameterType="com.keymanager.monitoring.criteria.KeywordAmountCountCriteria" resultType="com.keymanager.monitoring.vo.keywordAmountCountVo">
        SELECT
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fSearchEngine	AS	'searchEngine',
        COUNT(1) AS 'keywordCount',
        SUM(IF(ck.fCurrentPosition BETWEEN 1 AND 3, 1, 0)) AS 'topThree',
        SUM(IF(ck.fCurrentPosition BETWEEN 1 AND 10, 1, 0)) AS 'topTen',
        COUNT( DISTINCT ck.fCustomerUuid) AS 'customerCount',
        COUNT(DISTINCT c.fUserID) AS 'userCount'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        AND ck.fType = 'pt'
        AND ck.fTerminalType = #{keywordAmountCountCriteria.terminalType}
        <if test="keywordAmountCountCriteria.keyword != null and keywordAmountCountCriteria.keyword != ''">
            AND ck.fKeyword like concat(#{keywordAmountCountCriteria.keyword}, '%')
        </if>
        <if test="keywordAmountCountCriteria.searchEngine != null and keywordAmountCountCriteria.searchEngine != ''">
            AND ck.fSearchEngine = #{keywordAmountCountCriteria.searchEngine}
        </if>
        <if test="keywordAmountCountCriteria.userName != null and keywordAmountCountCriteria.userName != ''">
            AND c.fUserID = #{keywordAmountCountCriteria.userName}
        </if>
        GROUP BY ck.fKeyword, ck.fSearchEngine
        ORDER BY keywordCount DESC
    </select>

    <select id="getCities" resultType="java.lang.String">
        SELECT fCity
        FROM t_customer_keyword ck
        WHERE ck.fType = 'pt'
        AND ck.fStatus = 1
        GROUP BY ck.fCity
    </select>

    <select id="getTenCustomerKeywordsForCaptureIndex" resultType="com.keymanager.monitoring.vo.ExternalCustomerKeywordVO">
        SELECT
        ck.fUuid AS 'uuid',
        ck.fKeyword	AS	'keyword',
        ck.fTerminalType AS 'terminalType'
        FROM t_customer_keyword ck
        WHERE ck.fCurrentIndexCount = -1
        AND ck.fType = 'qz'
        AND ck.fCaptureIndexQueryTime IS NULL
        ORDER BY ck.fCreateTime
        LIMIT 10
    </select>

    <select id="updateCaptureIndexQueryTimeByKeywords">
        UPDATE t_customer_keyword
        SET fCaptureIndexQueryTime = NOW()
        WHERE fUuid IN
        <foreach item="customerKeyword" collection="customerKeywords" open="(" separator="," close=")">
            #{customerKeyword.uuid}
        </foreach>
    </select>

    <update id="batchUpdateIndexAndOptimizePlanCount">
        <foreach collection="customerKeywords" item="customerKeyword" index="index" open="" close="" separator=";">
            UPDATE t_customer_keyword ck
            SET ck.fCurrentIndexCount = #{customerKeyword.currentIndexCount},
            <if test="customerKeyword.currentIndexCount == -1">
                SET ck.fCaptureIndexQueryTime = NULL,
            </if>
            ck.fOptimizePlanCount = #{customerKeyword.optimizePlanCount}
            WHERE ck.fUuid = #{customerKeyword.uuid}
        </foreach>
    </update>
</mapper>