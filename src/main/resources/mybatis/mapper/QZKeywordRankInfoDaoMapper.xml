<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.QZKeywordRankInfoDao">

    <select id="searchExistingQZKeywordRankInfo" resultType="com.keymanager.monitoring.entity.QZKeywordRankInfo">
        SELECT
            qzkri.fUuid AS "uuid",
            qzkri.fQZSettingUuid AS "qzSettingUuid",
            qzkri.fTerminalType AS "terminalType",
            qzkri.fWebSiteType AS "websiteType",
            qzkri.fTopTen AS "topTen",
            qzkri.fTopTwenty AS "topTwenty",
            qzkri.fTopThirty AS "topThirty",
            qzkri.fTopForty AS "topForty",
            qzkri.fTopFifty AS "topFifty",
            qzkri.fTopHundred AS "topHundred",
            qzkri.fCreateTopTenNum AS "createTopTenNum",
            qzkri.fCreateTopFiftyNum AS "createTopFiftyNum",
            qzkri.fDate AS "date",
            qzkri.fFullDate AS "fullDate",
            qzkri.fIncrease AS "increase",
            qzkri.fIpRoute AS "ipRoute",
            qzkri.fRecord AS "baiduRecord",
            qzkri.fAchieveLevel AS "achieveLevel",
            qzkri.fSumSeries AS "sumSeries",
            qzkri.fDifferenceValue AS "differenceValue",
            qzkri.fCurrentPrice AS "currentPrice",
            qzkri.fBaiduRecordFullDate AS "baiduRecordFullDate"
        FROM t_qz_keyword_rank_info qzkri
        WHERE qzkri.fQZSettingUuid = #{qzSettingUuid}
        AND EXISTS(SELECT 1 FROM t_qz_setting qs WHERE qs.fUuid = qzkri.fQZSettingUuid AND qs.fIsMonitor = 1)
        <if test="qzSettingSearchCriteria.checkStatus != null">
            <choose>
                <when test="qzSettingSearchCriteria.checkStatus == 2">
                    AND qzkri.fIncrease &gt;= #{qzSettingSearchCriteria.upperValue}
                </when>
                <when test="qzSettingSearchCriteria.checkStatus == 1">
                    AND qzkri.fIncrease &lt;= #{qzSettingSearchCriteria.lowerValue}
                </when>
            </choose>
        </if>
        <if test="qzSettingSearchCriteria.terminalType != null">
            AND qzkri.fTerminalType = #{qzSettingSearchCriteria.terminalType}
        </if>
    </select>

    <delete id="deleteByQZSettingUuid" parameterType="java.lang.Long">
        DELETE FROM t_qz_keyword_rank_info
        WHERE fQZSettingUuid = #{qzSettingUuid}
    </delete>

    <select id="getQZKeywordRankInfo" resultType="com.keymanager.monitoring.entity.QZKeywordRankInfo">
        SELECT
            tqkri.fUuid AS 'uuid',
            tqkri.fCreateTopTenNum AS 'createTopTenNum',
            tqkri.fCreateTopFiftyNum AS 'createTopFiftyNum'
        FROM t_qz_keyword_rank_info tqkri
        WHERE 1 = 1
        <if test="qzSettingUuid != null"> AND tqkri.fQZSettingUuid = #{qzSettingUuid} </if>
        <if test="terminalType != null and terminalType != ''"> AND tqkri.fTerminalType = #{terminalType} </if>
        <if test="websiteType != null and websiteType != ''"> AND tqkri.fWebsiteType = #{websiteType} </if>
    </select>

    <select id="getCountNumOfRankInfo" resultType="com.keymanager.monitoring.criteria.QZSettingSearchCriteria">
        SELECT
            COUNT(qk.fIncrease = 0 OR NULL) AS unchangedNum,
            COUNT(qk.fIncrease &lt;= #{lower} OR NULL) AS downNum,
            COUNT(qk.fIncrease &gt;= #{upper} OR NULL) AS upNum,
            COUNT(qk.fAchieveLevel &gt; 0 OR NULL) AS atLeastStandardNum,
            COUNT(qk.fAchieveLevel = 0 OR NULL) AS neverStandardNum,
            COUNT(qk.fDifferenceValue &lt;= #{differenceValue} OR NULL) AS closeStandardNum,
            COUNT(qk.fTodayDifference =0 OR NULL) AS unchangedDifferenceNum,
            COUNT(qk.fTodayDifference &gt;0 OR NULL) AS upDifferenceNum,
            COUNT(qk.fTodayDifference &lt;0 OR NULL) AS downDifferenceNum
        FROM t_qz_keyword_rank_info qk
        JOIN t_qz_setting qs
        ON qs.fUuid = qk.fQZSettingUuid
        WHERE qk.fTerminalType = #{terminalType}
        AND EXISTS (
            SELECT 1 FROM t_customer c WHERE qs.fCustomerUuid = c.fUuid
            <if test="loginName != null and loginName != ''">
                AND c.fUserID = #{loginName}
            </if>
        )
    </select>

    <select id="getQZKeywordRankInfoTypes" resultType="java.lang.String">
        SELECT
        CONCAT(qk.fTerminalType, '_', qk.fWebsiteType)
        FROM t_qz_keyword_rank_info qk
        WHERE qk.fQZSettingUuid = #{qzSettingUuid}
        AND qk.fWebsiteType <![CDATA[<>]]> 'designationWord'
    </select>
</mapper>