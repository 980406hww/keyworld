<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.QZSettingDao">
    <select id="getAvailableQZSettings" resultType="com.keymanager.monitoring.entity.QZSetting">
       SELECT
              qs.fUuid            AS 'uuid',
              qs.fCustomerUuid    AS 'customerUuid',
              qs.fDomain          AS 'domain',
              qs.fPcGroup         AS 'pcGroup',
              qs.fPhoneGroup      AS 'phoneGroup',
              qs.fType            AS 'type',
              qs.fIgnoreNoIndex   AS 'ignoreNoIndex',
              qs.fIgnoreNoOrder   AS 'ignoreNoOrder',
              qs.fUpdateInterval  AS 'updateInterval',
              qs.fUpdateStatus    AS 'updateStatus',
              qs.fUpdateStartTime AS 'updateStartTime',
              qs.fUpdateEndTime   AS 'updateEndTime',
              qs.fUpdateTime      AS 'updateTime',
              qs.fCreateTime      AS 'createTime',
              qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
              qs.fCaptureCurrentKeywordStatus    AS 'captureCurrentKeywordStatus'
        FROM t_qz_setting qs
        WHERE qs.fUpdateStatus IS NULL
        OR (qs.fUpdateStatus = 'Completed'
        AND DATE_SUB(NOW(), INTERVAL qs.fUpdateInterval DAY) > qs.fUpdateEndTime)
        OR (qs.fUpdateStatus = 'Processing'
        AND DATE_SUB(NOW(), INTERVAL 10 MINUTE) > qs.fUpdateStartTime)
        ORDER BY qs.fUpdateEndTime
    </select>

    <select id="captureCurrentKeyword" resultType="com.keymanager.monitoring.entity.QZSetting">
       SELECT
            DISTINCT qs.fUuid AS 'uuid',
            qs.fCustomerUuid AS 'customerUuid',
            qs.fDomain AS 'domain',
            qs.fPcGroup AS 'pcGroup',
            qs.fPhoneGroup AS 'phoneGroup',
            qs.fType AS 'type',
            qs.fIgnoreNoIndex AS 'ignoreNoIndex',
            qs.fIgnoreNoOrder AS 'ignoreNoOrder',
            qs.fUpdateInterval AS 'updateInterval',
            qs.fUpdateStatus AS 'updateStatus',
            qs.fUpdateStartTime AS 'updateStartTime',
            qs.fUpdateEndTime AS 'updateEndTime',
            qs.fUpdateTime AS 'updateTime',
            qs.fCreateTime AS 'createTime',
            qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
            qs.fCaptureCurrentKeywordStatus AS 'captureCurrentKeywordStatus'
        FROM
            t_qz_setting qs
        JOIN t_qz_operation_type qt ON qs.fUuid = qt.fQZSettingUuid
        WHERE
            qt.fUuid IN(
                SELECT
                    qr.fQZOperationTypeUuid
                FROM
                    t_qz_charge_rule qr
            )
        AND qs.fCaptureCurrentKeywordStatus IS NULL
        OR (
            qs.fCaptureCurrentKeywordStatus = 'Completed'
            AND DATE_SUB(NOW(), INTERVAL 12 HOUR) > qs.fCaptureCurrentKeywordCountTime
        )
        OR (
            qs.fCaptureCurrentKeywordStatus = 'Processing'
            AND DATE_SUB(NOW(), INTERVAL 10 MINUTE) > qs.fCaptureCurrentKeywordCountTime
        )
        ORDER BY qs.fCaptureCurrentKeywordCountTime
    </select>

    <select id="getChargeRemindData" resultType="com.keymanager.monitoring.vo.DateRangeTypeVO">
        SELECT DISTINCT
          qs.fUuid AS "uuid",
          ot.fNextChargeDate AS "nextChargeDate"
        FROM
        t_qz_setting qs,
        t_qz_operation_type ot
        WHERE
        qs.fUuid = ot.fQZSettingUuid
        AND ot.fNextChargeDate &lt;= date_add(CURDATE(), INTERVAL 7 DAY)
        AND ot.fIsDeleted = 0
    </select>

    <select id="searchQZSettings" parameterType="com.keymanager.monitoring.criteria.QZSettingSearchCriteria"
            resultType="com.keymanager.monitoring.vo.QZSettingVO">
        SELECT
        qs.fUuid AS 'uuid',
        qs.fCustomerUuid AS 'customerUuid',
        c.fContactPerson AS 'contactPerson',
        qs.fDomain AS 'domain',
        qs.fPcGroup AS 'pcGroup',
        qs.fPhoneGroup AS 'phoneGroup',
        qs.fType AS 'type',
        qs.fIgnoreNoIndex AS 'ignoreNoIndex',
        qs.fIgnoreNoOrder AS 'ignoreNoOrder',
        qs.fUpdateInterval AS 'updateInterval',
        qs.fUpdateStatus AS 'updateStatus',
        qs.fUpdateStartTime AS 'updateStartTime',
        qs.fUpdateEndTime AS 'updateEndTime',
        qs.fUpdateTime AS 'updateTime',
        qs.fCreateTime AS 'createTime',
        qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
        qs.fCaptureCurrentKeywordStatus AS 'captureCurrentKeywordStatus'
        FROM t_qz_setting qs
        JOIN t_customer c
        ON qs.fCustomerUuid = c.fUuid
        WHERE 1 = 1
        <if test="qzSettingSearchCriteria.contactPerson != null and qzSettingSearchCriteria.contactPerson != ''">AND c.fContactPerson = #{qzSettingSearchCriteria.contactPerson}</if>
        <if test="qzSettingSearchCriteria.domain != null and qzSettingSearchCriteria.domain != ''">AND qs.fDomain = #{qzSettingSearchCriteria.domain}</if>
        <if test="qzSettingSearchCriteria.group != null and qzSettingSearchCriteria.group != ''">AND (qs.fPcGroup = #{qzSettingSearchCriteria.group} or qs.fPhoneGroup = #{qzSettingSearchCriteria.group})</if>
        <if test="qzSettingSearchCriteria.updateStatus != null and qzSettingSearchCriteria.updateStatus != ''">AND qs.fUpdateStatus = #{qzSettingSearchCriteria.updateStatus}</if>
        <if test="qzSettingSearchCriteria.dateRangeType == '-1'">
            AND EXISTS (select qs.fUuid from t_qz_operation_type ot where qs.fUuid = ot.fQZSettingUuid and ot.fNextChargeDate &lt; CURDATE())
        </if>
        <if test="qzSettingSearchCriteria.dateRangeType == '0'">
            AND EXISTS (select qs.fUuid from t_qz_operation_type ot where qs.fUuid = ot.fQZSettingUuid and ot.fNextChargeDate = CURDATE())
        </if>
        <if test="qzSettingSearchCriteria.dateRangeType == '3'">
            AND EXISTS (select qs.fUuid from t_qz_operation_type ot where qs.fUuid = ot.fQZSettingUuid and ot.fNextChargeDate BETWEEN CURDATE() AND date_add(CURDATE(), INTERVAL 3 DAY))
        </if>
        <if test="qzSettingSearchCriteria.dateRangeType == '7'">
            AND EXISTS (select qs.fUuid from t_qz_operation_type ot where qs.fUuid = ot.fQZSettingUuid and ot.fNextChargeDate BETWEEN CURDATE() AND date_add(CURDATE(), INTERVAL 7 DAY))
        </if>
        order by qs.fUpdateEndTime
    </select>

    <select id="searchQZSettingsByUuids" resultType="com.keymanager.monitoring.entity.QZSetting">
        SELECT
          qs.fUuid            AS 'uuid',
          qs.fCustomerUuid    AS 'customerUuid',
          qs.fDomain          AS 'domain',
          qs.fPcGroup         AS 'pcGroup',
          qs.fPhoneGroup      AS 'phoneGroup',
          qs.fType            AS 'type',
          qs.fIgnoreNoIndex   AS 'ignoreNoIndex',
          qs.fIgnoreNoOrder   AS 'ignoreNoOrder',
          qs.fUpdateInterval  AS 'updateInterval',
          qs.fUpdateStatus    AS 'updateStatus',
          qs.fUpdateStartTime AS 'updateStartTime',
          qs.fUpdateEndTime   AS 'updateEndTime',
          qs.fUpdateTime      AS 'updateTime',
          qs.fCreateTime      AS 'createTime',
          qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
        qs.fCaptureCurrentKeywordStatus      AS 'captureCurrentKeywordStatus'
        FROM t_qz_setting qs
        WHERE qs.fUuid IN (#{uuids})
    </select>

    <select id="selectLastId" resultType="int">
        select LAST_INSERT_ID()
    </select>
</mapper>