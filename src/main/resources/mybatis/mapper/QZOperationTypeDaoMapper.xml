<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.monitoring.dao.QZOperationTypeDao">

    <!--查询多条操作类型信息-->
    <select id="searchQZOperationTypesByQZSettingUuid" resultType="com.keymanager.monitoring.entity.QZOperationType">
      SELECT
       qopty.fUuid             AS 'uuid',
       qopty.fQZSettingUuid    AS 'qzsettingUuid',
       qopty.fOperationtype          AS 'operationType',
       qopty.fInitialKeywordCount    AS 'initialKeywordCount',
       qopty.fCurrentKeywordCount    AS 'currentkeywordcount',
       qopty.fGroup            AS 'group',
       qopty.fReachTargetDate  AS 'reachTargetDate',
       qopty.fNextChargeDate   AS 'nextChargeDate',
       qopty.fUpdateTime       AS 'updateTime',
       qopty.fCreateTime       AS 'createTime',
       qopty.fIsDeleted        AS 'isDeleted'
      FROM t_qz_operation_type  qopty
      WHERE  qopty.fQZSettingUuid  = #{qzSettingUuid}  AND qopty.fIsDeleted = 0
    </select>
    <!--查询判断对应的操作类型表中是否存在IsDelete为0-->
    <select id="searchQZOperationTypesIsDelete" resultType="com.keymanager.monitoring.entity.QZOperationType">
      SELECT
       qopty.fUuid            AS 'uuid',
       qopty.fQZSettingUuid    AS 'qzsettingUuid',
       qopty.fOperationtype          AS 'operationType',
       qopty.fInitialKeywordCount    AS 'initialKeywordCount',
       qopty.fCurrentKeywordCount    AS 'currentkeywordcount',
       qopty.fGroup            AS 'group',
       qopty.fReachTargetDate  AS 'reachTargetDate',
       qopty.fNextChargeDate   AS 'nextChargeDate',
       qopty.fUpdateTime       AS 'updateTime',
       qopty.fCreateTime       AS 'createTime',
       qopty.fIsDeleted        AS 'isDeleted'
      FROM t_qz_operation_type  qopty
      WHERE  qopty.fQZSettingUuid  = #{qzSettingUuid}
    </select>
    <!--返回上一级插入的主键-->
    <select id="selectLastId" resultType="int">
        select LAST_INSERT_ID()
    </select>
    <!--删除 -->
    <delete id="deleteByQZSettingUuid">
        DELETE FROM t_qz_operation_type WHERE   fQZSettingUuid = #{qzSettingUuid}
    </delete>
    <!--过期缴费-->
    <select id="expiredCharge" resultType="com.keymanager.monitoring.entity.QZSetting">
        SELECT
            DISTINCT qs.fUuid AS 'uuid',
            qs.fCustomerUuid AS 'customerUuid',
            c.fContactPerson AS 'contactPerson',
            qs.fDomain AS 'domain',
            qs.fPcGroup AS 'pcGroup',
            qs.fPhoneGroup AS 'phoneGroup',
            qs.fType AS 'type',
            qs.fIgnoreNoIndex AS 'ignoreNoIndex',
            qs.fIgnoreNoOrder AS 'ignoreNoOrder',
            qs.fUpdateInterval AS 'updateInterval',
            qs.fUpdateStatus AS 'updateStatus',
            qs.fUpdateStartTime AS 'updateStartTime',
            qs.fUpdateEndTime AS 'updateEndTime',
            qs.fUpdateTime AS 'updateTime',
            qs.fCreateTime AS 'createTime',
            qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
            qs.fCaptureCurrentKeywordStatus    AS 'captureCurrentKeywordStatus'
        FROM
            t_qz_setting qs
        JOIN t_qz_operation_type qztype ON qs.fUuid = qztype.fQZSettingUuid
        JOIN t_customer c ON qs.fCustomerUuid = c.fUuid
        WHERE
            EXISTS (
                SELECT
                DISTINCT   qzset.fUuid
                FROM
                    t_qz_setting qzset
                JOIN t_qz_operation_type qztype ON qzset.fUuid = qztype.fQZSettingUuid
                WHERE
                    qztype.fNextChargeDate   &lt; CURDATE() AND qztype.fIsDeleted = 0
                AND  qzset.fUuid =  qs.fUuid
            )
    </select>
    <!--当天缴费-->
    <select id="nowCharge" resultType="com.keymanager.monitoring.entity.QZSetting">
        SELECT
            DISTINCT qs.fUuid AS 'uuid',
            qs.fCustomerUuid AS 'customerUuid',
            c.fContactPerson AS 'contactPerson',
            qs.fDomain AS 'domain',
            qs.fPcGroup AS 'pcGroup',
            qs.fPhoneGroup AS 'phoneGroup',
            qs.fType AS 'type',
            qs.fIgnoreNoIndex AS 'ignoreNoIndex',
            qs.fIgnoreNoOrder AS 'ignoreNoOrder',
            qs.fUpdateInterval AS 'updateInterval',
            qs.fUpdateStatus AS 'updateStatus',
            qs.fUpdateStartTime AS 'updateStartTime',
            qs.fUpdateEndTime AS 'updateEndTime',
            qs.fUpdateTime AS 'updateTime',
            qs.fCreateTime AS 'createTime',
            qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
            qs.fCaptureCurrentKeywordStatus    AS 'captureCurrentKeywordStatus'
        FROM
            t_qz_setting qs
        JOIN t_qz_operation_type qztype ON qs.fUuid = qztype.fQZSettingUuid
        JOIN t_customer c ON qs.fCustomerUuid = c.fUuid
        WHERE
        qztype.fNextChargeDate   = CURDATE()   AND qztype.fIsDeleted = 0
    </select>
    <!--三天缴费-->
    <select id="threeCharge" resultType="com.keymanager.monitoring.entity.QZSetting">
    SELECT
            DISTINCT qs.fUuid AS 'uuid',
            qs.fCustomerUuid AS 'customerUuid',
            c.fContactPerson AS 'contactPerson',
            qs.fDomain AS 'domain',
            qs.fPcGroup AS 'pcGroup',
            qs.fPhoneGroup AS 'phoneGroup',
            qs.fType AS 'type',
            qs.fIgnoreNoIndex AS 'ignoreNoIndex',
            qs.fIgnoreNoOrder AS 'ignoreNoOrder',
            qs.fUpdateInterval AS 'updateInterval',
            qs.fUpdateStatus AS 'updateStatus',
            qs.fUpdateStartTime AS 'updateStartTime',
            qs.fUpdateEndTime AS 'updateEndTime',
            qs.fUpdateTime AS 'updateTime',
            qs.fCreateTime AS 'createTime',
            qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
            qs.fCaptureCurrentKeywordStatus    AS 'captureCurrentKeywordStatus'
        FROM
            t_qz_setting qs
        JOIN t_qz_operation_type qztype ON qs.fUuid = qztype.fQZSettingUuid
        JOIN t_customer c ON qs.fCustomerUuid = c.fUuid
    WHERE
        EXISTS (
            SELECT
            DISTINCT   qzset.fUuid
            FROM
                t_qz_setting qzset
            JOIN t_qz_operation_type qztype ON qzset.fUuid = qztype.fQZSettingUuid
            WHERE
                qztype.fNextChargeDate BETWEEN CURDATE()
            AND date_add(CURDATE(), INTERVAL 3 DAY)   AND qztype.fIsDeleted = 0
            AND  qzset.fUuid =  qs.fUuid
        )
    </select>
    <!--七天缴费-->
    <select id="sevenCharge" resultType="com.keymanager.monitoring.entity.QZSetting">
     SELECT
            DISTINCT qs.fUuid AS 'uuid',
            qs.fCustomerUuid AS 'customerUuid',
            c.fContactPerson AS 'contactPerson',
            qs.fDomain AS 'domain',
            qs.fPcGroup AS 'pcGroup',
            qs.fPhoneGroup AS 'phoneGroup',
            qs.fType AS 'type',
            qs.fIgnoreNoIndex AS 'ignoreNoIndex',
            qs.fIgnoreNoOrder AS 'ignoreNoOrder',
            qs.fUpdateInterval AS 'updateInterval',
            qs.fUpdateStatus AS 'updateStatus',
            qs.fUpdateStartTime AS 'updateStartTime',
            qs.fUpdateEndTime AS 'updateEndTime',
            qs.fUpdateTime AS 'updateTime',
            qs.fCreateTime AS 'createTime',
            qs.fCaptureCurrentKeywordCountTime AS 'captureCurrentKeywordCountTime',
            qs.fCaptureCurrentKeywordStatus    AS 'captureCurrentKeywordStatus'
        FROM
            t_qz_setting qs
        JOIN t_qz_operation_type qztype ON qs.fUuid = qztype.fQZSettingUuid
        JOIN t_customer c ON qs.fCustomerUuid = c.fUuid
    WHERE
        EXISTS (
            SELECT
            DISTINCT    qzset.fUuid
            FROM
                t_qz_setting qzset
            JOIN t_qz_operation_type qztype ON qzset.fUuid = qztype.fQZSettingUuid
            WHERE
                qztype.fNextChargeDate BETWEEN CURDATE()
            AND date_add(CURDATE(), INTERVAL 7 DAY)  AND qztype.fIsDeleted = 0
            AND  qzset.fUuid =  qs.fUuid
        )
    </select>
</mapper>