<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.ckadmin.dao.CaptureRankJobDao">
    <sql id="colID">
        c.fUuid AS `uuid`,
        c.fGroupNames AS `groupNames`,
        c.fCustomerUuid AS `customerUuid`,
        c.fQZSettingUuid AS `qzSettingUuid`,
        c.fOperationType AS `operationType`,
        c.fExectionType AS `exectionType`,
        c.fExectionTime AS `exectionTime`,
        c.fExectionStatus  AS `exectionStatus`,
        c.fRankJobType AS `rankJobType`,
        c.fRankJobArea AS `rankJobArea`,
        c.fRankJobCity AS `rankJobCity`,
        c.fCaptureRankJobStatus  AS `captureRankJobStatus`,
        c.fStartTime AS `startTime`,
        c.fEndTime AS `endTime`,
        c.fCreateBy AS `createBy`,
        c.fUpdateBy AS `updateBy`,
        c.fCreateTime AS `createTime`,
        c.fUpdateTime AS `updateTime`,
        c.fLastExecutionDate AS `lastExecutionDate`,
        c.fRowNumber AS `rowNumber`,
        c.fExecutionCycle AS `executionCycle`,
        c.fCaptureInterval AS `captureInterval`,
        c.fCaptureDaysInterval AS `captureDaysInterval`,
        c.fPageSize AS `pageSize`
    </sql>

    <delete id="deleteCaptureRankJob">
        DELETE FROM t_capture_rank_job
        WHERE fQZSettingUuid = #{qzSettingUuid}
        <if test="operationType != null">
            AND fOperationType = #{operationType}
        </if>
    </delete>

    <select id="findExistCaptureRankJob" resultType="com.keymanager.ckadmin.entity.CaptureRankJob">
        SELECT
            crj.fUuid AS 'uuid',
            crj.fGroupNames AS 'groupNames'
        FROM t_capture_rank_job crj
        WHERE crj.fQZSettingUuid = #{qzSettingUuid}
        AND crj.fOperationType = #{operationType}
        LIMIT 1
    </select>

    <select id="hasUncompletedCaptureRankJob" resultType="Long">
        SELECT
        1
        FROM t_capture_rank_job c
        WHERE (
        c.fExectionStatus = 'New'
        OR (c.fExectionStatus = 'Complete'
        AND c.fExectionType = 'Everyday'
        AND c.fLastExecutionDate &lt; curdate())
        )
        <if test="rankJobArea != null">
            AND fRankJobArea = #{rankJobArea}
        </if>
        AND c.fCaptureRankJobStatus = 1
        <if test="groupNames!=null">and c.fGroupNames IN
            <foreach collection="groupNames" item="groupName" open="(" separator="," close=")">
                #{groupName}
            </foreach>
        </if>
        LIMIT 1
    </select>

    <update id="changeCaptureRankJobStatuses">
        UPDATE t_capture_rank_job
        SET fUpdateTime = NOW(), fUpdateBy = #{updateBy}, fCaptureRankJobStatus = #{captureRankJobStatus}
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" separator="," open="(" close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="resetCaptureRankJobs">
        UPDATE t_capture_rank_job
        SET fExectionStatus = 'New'
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" separator="," open="(" close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="getCaptureRankJobUuids" resultType="java.lang.Long">
        SELECT fUuid FROM t_capture_rank_job WHERE fQZSettingUuid IN
        <foreach collection="uuids" item="uuid" separator="," open="(" close=")">
            #{uuid}
        </foreach>
    </select>

    <update id="updateCaptureRankJobCustomerUuids">
        UPDATE t_capture_rank_job SET fCustomerUuid = #{customerUuid} WHERE fUuid IN
        <foreach collection="jobUuids" item="uuid" separator="," open="(" close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="selectPageByCriteria" resultType="com.keymanager.ckadmin.entity.CaptureRankJob">
        SELECT
        <include refid="colID"/>
        FROM t_capture_rank_job c
        WHERE 1 = 1
        <if test="criteria.init != null and criteria.init == 'init'">
            AND 1 != 1
        </if>
        <if test="criteria.groupNames != null and criteria.groupNames != ''">
            AND c.fGroupNames LIKE CONCAT('', '%')
        </if>
        <if test="criteria.customerUuid != null and criteria.customerUuid != ''">
            AND c.fCustomerUuid = #{criteria.customerUuid}
        </if>
        <if test="criteria.operationType != null and criteria.operationType != ''">
            AND c.fOperationType = #{criteria.operationType}
        </if>
        <if test="criteria.exectionType != null and criteria.exectionType != ''">
            AND c.fExectionType = #{criteria.exectionType}
        </if>
        <if test="criteria.exectionStatus != null and criteria.exectionStatus != ''">
            AND c.fExectionStatus = #{criteria.exectionStatus}
        </if>
        <choose>
            <when test="criteria.rankJobType == 'Common'">
                AND c.fRankJobType = #{criteria.rankJobType}
                AND c.fQZSettingUuid IS NULL
            </when>
            <when test="criteria.rankJobType == 'Station'">
                AND c.fQZSettingUuid > ''
            </when>
            <otherwise>
                AND c.fRankJobType = #{criteria.rankJobType}
            </otherwise>
        </choose>
        <if test="criteria.rankJobArea != null and criteria.rankJobArea != ''">
            AND c.fRankJobArea = #{criteria.rankJobArea}
        </if>
        <if test="criteria.rankJobCity != null and criteria.rankJobCity != ''">
            AND c.fRankJobCity = #{criteria.rankJobCity}
        </if>
    </select>
</mapper>