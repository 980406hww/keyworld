<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.ckadmin.dao.CustomerKeywordDao">
    <sql id="dailyReportColID">
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fTitle	AS	'title',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fTodayFee  AS 'todayFee',
        ck.fSequence	AS	'sequence',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fInitialIndexCount	AS	'initialIndexCount',
        ck.fInitialPosition	AS	'initialPosition',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fCurrentPosition	AS	'currentPosition',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee',
        ck.fCreateTime              AS 'createTime'
    </sql>

    <select id="getCustomerKeywordsCount" resultType="java.util.Map">
        SELECT ck.fCustomerUuid as 'customerUuid', COUNT(1) as 'totalCount', SUM(IF(ck.fStatus = 1, 1, 0)) AS
        'activeCount'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType}
        AND ck.fType = #{entryType}
        AND ck.fCustomerUuid IN
        <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getMachineGroups" resultType="java.lang.String">
        SELECT
          CONCAT(fTerminalType, '####', fMachineGroup, '####', COUNT(1))
        FROM t_machine_info mi
        WHERE fMachineGroup > ''
        GROUP BY fTerminalType, fMachineGroup
    </select>

    <select id="fetchCustomerKeywordsForCache" resultType="com.keymanager.ckadmin.vo.OptimizationKeywordVO">
        SELECT
            ck.fUuid              AS 'uuid',
            ck.fTerminalType      AS 'terminalType',
            ck.fKeyword           AS 'keyword',
            ck.fUrl               AS 'url',
            ck.fBearPawNumber     AS 'bearPawNumber',
            ck.fType              AS 'entryType',
            ck.fTitle             AS 'title',
            ck.fSearchEngine      AS 'searchEngine',
            ck.fOptimizeGroupName AS 'optimizeGroup',
            ck.fOptimizedCount	  AS 'optimizedCount',
            ck.fQueryInterval	  AS 'queryInterval',
            ck.fCurrentPosition   AS 'currentPosition',
            ck.fOptimizePlanCount AS 'optimizePlanCount'
        FROM t_customer_keyword ck
        WHERE ck.fMachineGroup = #{machineGroup}
        AND ck.fStatus = 1
        AND ck.fOptimizeRemainingCount > 0
        AND ck.fTerminalType = #{terminalType}
        AND ck.fQueryTime <![CDATA[<]]> NOW()
        AND ck.fInvalidFlag = 0
        ORDER BY ck.fQueryTime
        LIMIT #{batchCount}
    </select>

    <update id="changeCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fCustomerUuid = #{customerUuid}
        AND fTerminalType = #{terminalType}
        AND fType = #{entryType}
    </update>

    <update id="updateOptimizationQueryTime">
        UPDATE t_customer_keyword
        SET fQueryDate = CURRENT_DATE(),
        fQueryCount = fQueryCount + 1,
        fInvalidRefreshCount = fInvalidRefreshCount + 1,
        fQueryTime = DATE_ADD(fQueryTime, INTERVAL ROUND(fQueryInterval * (2*RAND() + 8)/10) SECOND ),
        fInvalidFlag = if(fInvalidRefreshCount > 8, 1, 0)
        WHERE fUuid IN
        <foreach item="uuid" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <delete id="deleteCustomerKeywordsByCustomerUuid">
        delete from t_customer_keyword where fCustomerUuid = #{customerUuid}
    </delete>

    <select id="getCustomerKeywordCount" resultType="int">
        SELECT COUNT(1) FROM t_customer_keyword ck WHERE ck.fCustomerUuid = #{customerUuid} and ck.fTerminalType = #{terminalType} and ck.fType = #{entryType}
    </select>

    <update id="excludeCustomerKeyword">
        UPDATE t_customer_keyword ck
        SET ck.fStatus = 3
        <where>
            <if test="criteria.customerUuid != null and criteria.customerUuid != ''">
                ck.fCustomerUuid = #{criteria.customerUuid}
            </if>
            <if test="criteria.type != null and criteria.type != ''">
                AND ck.fType = #{criteria.type}
            </if>
            <if test="criteria.terminalType != null and criteria.terminalType != ''">
                AND ck.fTerminalType = #{criteria.terminalType}
            </if>
            <if test="criteria.keywords.size > 0">
                AND ck.fKeyword IN
                <foreach item="keyword" collection="criteria.keywords" open="(" separator="," close=")">
                    #{keyword}
                </foreach>
            </if>
            <if test="criteria.domain != null and criteria.domain != ''">
                AND FIND_IN_SET(#{criteria.domain}, ck.fUrl)
            </if>
        </where>
    </update>

    <insert id="addCustomerKeywords">
        INSERT INTO t_customer_keyword (
        fTerminalType,
        fCustomerUuid,
        fQZSettingUuid,
        fKeyword,
        fUrl,
        fType,
        fBearPawNumber,
        fOriginalUrl,
        fTitle,
        fSequence,
        fAutoUpdateNegativeDateTime,
        fSearchEngine,
        fInitialIndexCount,
        fCurrentIndexCount,
        fCurrentPosition,
        fQueryDate,
        fQueryTime,
        fServiceProvider,
        fOptimizeGroupName,
        fMachineGroup,
        fOptimizePlanCount,
        fOptimizeTodayCount,
        fOptimizeRemainingCount,
        fLastReachStandardDate,
        fPositionFirstFee,
        fPositionSecondFee,
        fPositionThirdFee,
        fPositionForthFee,
        fPositionFifthFee,
        fPositionFirstPageFee,
        fCapturePositionQueryTime,
        fCaptureIndexQueryTime,
        fCollectMethod,
        fStartOptimizedTime,
        fOrderNumber,
        fStatus,
        fManualCleanTitle,
        fKeywordEffect,
        fCustomerKeywordSource,
        fRemarks,
        fUpdateTime,
        fCreateTime
        )
        VALUES
        <foreach collection="customerKeywords" item="customerKeyword" separator=",">
            (
            #{customerKeyword.terminalType},
            #{customerKeyword.customerUuid},
            #{customerKeyword.qzSettingUuid},
            #{customerKeyword.keyword},
            #{customerKeyword.url},
            #{customerKeyword.type},
            #{customerKeyword.bearPawNumber},
            #{customerKeyword.originalUrl},
            #{customerKeyword.title},
            #{customerKeyword.sequence},
            #{customerKeyword.autoUpdateNegativeDateTime},
            #{customerKeyword.searchEngine},
            #{customerKeyword.initialIndexCount},
            #{customerKeyword.currentIndexCount},
            #{customerKeyword.currentPosition},
            #{customerKeyword.queryDate},
            #{customerKeyword.queryTime},
            #{customerKeyword.serviceProvider},
            #{customerKeyword.optimizeGroupName},
            #{customerKeyword.machineGroup},
            <choose>
                <when test="customerKeyword.optimizePlanCount != null">
                    #{customerKeyword.optimizePlanCount},
                </when>
                <when test="customerKeyword.optimizePlanCount == null">10,</when>
            </choose>
            #{customerKeyword.optimizeTodayCount},
            #{customerKeyword.optimizeRemainingCount},
            #{customerKeyword.lastReachStandardDate},
            <choose>
                <when test="customerKeyword.positionFirstFee != null">#{customerKeyword.positionFirstFee},</when>
                <when test="customerKeyword.positionFirstFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionSecondFee != null">#{customerKeyword.positionSecondFee},</when>
                <when test="customerKeyword.positionSecondFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionThirdFee != null">#{customerKeyword.positionThirdFee},</when>
                <when test="customerKeyword.positionThirdFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionForthFee != null">#{customerKeyword.positionForthFee},</when>
                <when test="customerKeyword.positionForthFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionFifthFee != null">#{customerKeyword.positionFifthFee},</when>
                <when test="customerKeyword.positionFifthFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionFirstPageFee != null">#{customerKeyword.positionFirstPageFee},</when>
                <when test="customerKeyword.positionFirstPageFee == null">0.00,</when>
            </choose>
            #{customerKeyword.capturePositionQueryTime},
            #{customerKeyword.captureIndexQueryTime},
            #{customerKeyword.collectMethod},
            #{customerKeyword.startOptimizedTime},
            #{customerKeyword.orderNumber},
            #{customerKeyword.status},
            <choose>
                <when test="customerKeyword.manualCleanTitle != null">#{customerKeyword.manualCleanTitle},</when>
                <when test="customerKeyword.manualCleanTitle == null">0,</when>
            </choose>
            #{customerKeyword.keywordEffect},
            #{customerKeyword.customerKeywordSource},
            #{customerKeyword.remarks},
            #{customerKeyword.updateTime},
            #{customerKeyword.createTime}
            )
        </foreach>
    </insert>

    <select id="getOneSameCustomerKeyword" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid AS 'uuid',
        ck.fTerminalType AS 'terminalType',
        ck.fCustomerUuid AS 'customerUuid',
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fOriginalUrl AS 'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle AS 'title',
        ck.fStatus AS 'status',
        ck.fSearchEngine AS 'searchEngine',
        ck.fKeywordEffect AS 'keywordEffect',
        ck.fOptimizePlanCount AS 'optimizePlanCount'
        FROM t_customer_keyword ck
        <where>
            AND ck.fCustomerUuid = #{customerUuid}
            <if test="qzSettingUuid != null and qzSettingUuid != 0">
                AND ck.fQZSettingUuid = #{qzSettingUuid}
            </if>
            AND ck.fKeyword = #{keyword}
            AND ck.fTerminalType = #{terminalType}
            <choose>
                <when test="url == 'NoUrl'">
                    AND ck.fTitle = #{title}
                </when>
                <otherwise>
                    AND ck.fUrl = #{url}
                </otherwise>
            </choose>
            LIMIT 1
        </where>
    </select>

    <update id="updateSameCustomerKeyword">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeyword.customerKeywordSource},
        fKeywordEffect = #{customerKeyword.keywordEffect},
        fOptimizePlanCount = #{customerKeyword.optimizePlanCount}
        WHERE fKeyword = #{customerKeyword.keyword}
        AND fTerminalType = #{customerKeyword.terminalType}
        AND fCustomerUuid = #{customerKeyword.customerUuid}
        <choose>
            <when test="customerKeyword.url == 'NoUrl'">
                AND fTitle = #{customerKeyword.title}
            </when>
            <otherwise>
                AND fUrl = #{customerKeyword.url}
            </otherwise>
        </choose>
    </update>

    <select id="getOneSimilarCustomerKeyword" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid AS 'uuid',
        ck.fTerminalType AS 'terminalType',
        ck.fCustomerUuid AS 'customerUuid',
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fOriginalUrl AS 'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle AS 'title',
        ck.fStatus AS 'status',
        ck.fSearchEngine AS 'searchEngine',
        ck.fKeywordEffect AS 'keywordEffect',
        ck.fOptimizePlanCount AS 'optimizePlanCount'
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fCustomerUuid = #{customerUuid}
        <if test="qzSettingUuid != null and qzSettingUuid != 0">
            AND ck.fQZSettingUuid = #{qzSettingUuid}
        </if>
        <choose>
            <when test="originalUrl == 'NoUrl'">
                AND ck.fTitle = #{title}
            </when>
            <otherwise>
                AND ck.fOriginalUrl <![CDATA[ > ]]> ''
                AND ck.fOriginalUrl like concat('%', #{originalUrl})
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <update id="updateSimilarCustomerKeyword">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeyword.customerKeywordSource},
        fKeywordEffect = #{customerKeyword.keywordEffect},
        fOptimizePlanCount = #{customerKeyword.optimizePlanCount}
        WHERE fKeyword = #{customerKeyword.keyword}
        AND fTerminalType = #{customerKeyword.terminalType}
        AND fCustomerUuid = #{customerKeyword.customerUuid}
        <choose>
            <when test="customerKeyword.originalUrl == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fOriginalUrl <![CDATA[ > ]]> ''
                AND fOriginalUrl like concat('%', #{customerKeyword.originalUrl})
            </otherwise>
        </choose>
    </update>

    <select id="getCustomerKeywordCountByOptimizeGroupName" resultType="int">
        SELECT COUNT(1)
        FROM t_customer_keyword
        WHERE fOptimizeGroupName LIKE CONCAT(#{groupName}, '%')
    </select>

    <select id="searchCustomerKeywordSummaryInfo" resultType="com.keymanager.ckadmin.vo.CustomerKeywordSummaryInfoVO">
        SELECT
            fKeyword      AS 'keyword',
            fTerminalType AS 'terminalType'
        FROM t_customer_keyword
        WHERE fCustomerUuid = #{customerUuid}
        AND fType = #{entryType}
        AND fStatus = 1
        GROUP BY fKeyword, fTerminalType
    </select>

    <select id="getCustomerKeywordsCountByCustomerUuid" resultType="com.keymanager.ckadmin.vo.KeywordCountVO">
        SELECT
            ck.fTerminalType AS 'terminalType',
            COUNT(1)         AS 'totalCount',
            SUM(IF(ck.fStatus = 1, 1, 0)) AS 'activeCount'
        FROM t_customer_keyword ck
        WHERE ck.fCustomerUuid = #{customerUuid}
        AND ck.fType = #{type}
        GROUP BY ck.fTerminalType
    </select>

    <update id="resetInvalidRefreshCount">
        UPDATE t_customer_keyword
        SET fInvalidRefreshCount = 0, fInvalidFlag = 0,
        fQueryTime = DATE_ADD(CURRENT_DATE(), INTERVAL fOptimizedCount * fQueryInterval SECOND)
        WHERE fType = #{criteria.entryType}
        AND fTerminalType = #{criteria.terminalType}
        <if test="criteria.customerName != null and criteria.customerName != ''">
            AND EXISTS (
                SELECT 1
                FROM t_customer c
                WHERE c.fUuid = fCustomerUuid
                AND c.fContactPerson LIKE concat('%', #{criteria.customerName}, '%')
            )
        </if>
        <if test="criteria.groupName!=null and criteria.groupName!=''">
            <choose>
                <when test="criteria.fullMatchGroup == true">
                    AND fOptimizeGroupName = #{criteria.groupName}
                </when>
                <otherwise>
                    AND fOptimizeGroupName LIKE concat(#{criteria.groupName}, '%')
                </otherwise>
            </choose>
        </if>
        <if test="criteria.machineGroup!=null and criteria.machineGroup!=''">
            <choose>
                <when test="criteria.fullMatchGroup == true">
                    AND fMachineGroup = #{criteria.machineGroup}
                </when>
                <otherwise>
                    AND fMachineGroup LIKE concat(#{criteria.machineGroup}, '%')
                </otherwise>
            </choose>
        </if>
    </update>

    <sql id="searchCustomerKeywordsCriteria">
        <if test="keywordCriteria.customerUuid != null and keywordCriteria.customerUuid != ''">
            AND ck.fCustomerUuid = #{keywordCriteria.customerUuid}
        </if>
        <if test="keywordCriteria.keyword != null and keywordCriteria.keyword != ''">
            <choose>
                <when test="keywordCriteria.notLike != null and keywordCriteria.notLike == 'on'">
                    AND ck.fKeyword = #{keywordCriteria.keyword}
                </when>
                <otherwise>
                    AND ck.fKeyword LIKE CONCAT(#{keywordCriteria.keyword},'%')
                </otherwise>
            </choose>
        </if>
        <if test="keywordCriteria.userName != null and keywordCriteria.userName != ''">
            AND c.fUserID = #{keywordCriteria.userName}
        </if>
        <if test="keywordCriteria.url != null and keywordCriteria.url != ''">
            AND ck.fUrl LIKE CONCAT('%', #{keywordCriteria.url},'%')
        </if>
        <if test="keywordCriteria.bearPawNumber != null and keywordCriteria.bearPawNumber != ''">
            AND ck.fBearPawNumber LIKE CONCAT(#{keywordCriteria.bearPawNumber},'%')
        </if>
        <if test="keywordCriteria.status != null and keywordCriteria.status != ''">
            AND ck.fStatus = #{keywordCriteria.status}
        </if>
        <if test="keywordCriteria.optimizeGroupName != null and keywordCriteria.optimizeGroupName != ''">
            <choose>
                <when test="keywordCriteria.optimizeGroupNameLike != null and keywordCriteria.optimizeGroupNameLike == 'on'">
                    AND ck.fOptimizeGroupName LIKE CONCAT(#{keywordCriteria.optimizeGroupName},'%')
                </when>
                <otherwise>
                    AND ck.fOptimizeGroupName = #{keywordCriteria.optimizeGroupName}
                </otherwise>
            </choose>
        </if>
        <if test="keywordCriteria.machineGroup != null and keywordCriteria.machineGroup != ''">
            AND ck.fMachineGroup LIKE CONCAT(#{keywordCriteria.machineGroup},'%')
        </if>
        <if test="keywordCriteria.remarks != null and keywordCriteria.remarks != ''">
            AND ck.fRemarks LIKE CONCAT(#{keywordCriteria.remarks},'%')
        </if>
        <if test="keywordCriteria.failedCause != null and keywordCriteria.failedCause != ''">
            AND ck.fFailedCause = #{keywordCriteria.failedCause}
        </if>
        <if test="keywordCriteria.terminalType != null and keywordCriteria.terminalType != ''">
            AND ck.fTerminalType = #{keywordCriteria.terminalType}
        </if>
        <if test="keywordCriteria.searchEngine != null and keywordCriteria.searchEngine != ''">
            AND ck.fSearchEngine = #{keywordCriteria.searchEngine}
        </if>
        <if test="keywordCriteria.customerKeywordSource != null and keywordCriteria.customerKeywordSource != ''">
            AND ck.fCustomerKeywordSource = #{keywordCriteria.customerKeywordSource}
        </if>
        <if test="keywordCriteria.gtOptimizePlanCount != null">
            AND ck.fOptimizePlanCount &gt;= #{keywordCriteria.gtOptimizePlanCount}
        </if>
        <if test="keywordCriteria.ltOptimizePlanCount != null">
            AND ck.fOptimizePlanCount &lt;= #{keywordCriteria.ltOptimizePlanCount}
        </if>
        <if test="keywordCriteria.gtOptimizedCount != null">
            AND ck.fOptimizedCount &gt;= #{keywordCriteria.gtOptimizedCount}
        </if>
        <if test="keywordCriteria.ltOptimizedCount != null">
            AND ck.fOptimizedCount &lt;= #{keywordCriteria.ltOptimizedCount}
        </if>
        <if test="keywordCriteria.gtPosition != null and (keywordCriteria.noPosition == null or keywordCriteria.noPosition == '') ">
            AND ck.fCurrentPosition &gt;= #{keywordCriteria.gtPosition}
        </if>
        <if test="keywordCriteria.ltPosition != null and (keywordCriteria.noPosition == null or keywordCriteria.noPosition == '') ">
            AND ck.fCurrentPosition &lt;= #{keywordCriteria.ltPosition}
        </if>
        <if test="keywordCriteria.invalidRefreshCount != null and keywordCriteria.invalidRefreshCount != ''">
            AND ck.fInvalidRefreshCount &gt;= #{keywordCriteria.invalidRefreshCount}
        </if>
        <if test="keywordCriteria.gtCreateTime != null and keywordCriteria.gtCreateTime != ''">
            AND ck.fCreateTime &gt;= #{keywordCriteria.gtCreateTime}
        </if>
        <if test="keywordCriteria.ltCreateTime != null and keywordCriteria.ltCreateTime != ''">
            AND ck.fCreateTime &lt;= #{keywordCriteria.ltCreateTime}
        </if>
        <if test="keywordCriteria.noPosition != null and keywordCriteria.noPosition != ''">
            AND ck.fCurrentPosition = 0
        </if>
        <if test="keywordCriteria.pushPay != null and keywordCriteria.pushPay != ''">
            AND ((ck.fCollectMethod = 'PerDay' AND ck.fEffectiveToTime is not null) OR (ck.fEffectiveToTime &lt;= DATE_ADD(CURDATE(),INTERVAL 3 DAY)))
        </if>
        <if test="keywordCriteria.requireDelete != null and keywordCriteria.requireDelete != ''">
            AND ck.fRequireDelete = 1
        </if>
        <if test="keywordCriteria.type != null and keywordCriteria.type != ''">
            AND ck.fType = #{keywordCriteria.type}
        </if>
        <if test="keywordCriteria.titleFlag == 1">
            AND (ck.fTitle = '' OR ck.fTitle IS NULL)
        </if>
        <if test="keywordCriteria.titleFlag == 2">
            AND ck.fTitle > ''
        </if>
        <if test="keywordCriteria.gtCurrentIndexCount != null">
            AND ck.fCurrentIndexCount &gt;= #{keywordCriteria.gtCurrentIndexCount}
        </if>
        <if test="keywordCriteria.ltCurrentIndexCount != null">
            AND ck.fCurrentIndexCount &lt;= #{keywordCriteria.ltCurrentIndexCount}
        </if>
        <if test="keywordCriteria.noReachStandardDays != null and keywordCriteria.noReachStandardDays > 0">
            AND ck.fLastReachStandardDate &lt;= DATE_SUB(CURRENT_DATE(), INTERVAL #{keywordCriteria.noReachStandardDays} DAY)
        </if>
        <if test="keywordCriteria.keywordEffect != null and keywordCriteria.keywordEffect != ''">
            AND ck.fKeywordEffect = #{keywordCriteria.keywordEffect}
        </if>
        <if test="keywordCriteria.type == 'qz' and keywordCriteria.qzUuid != null and keywordCriteria.qzUuid != ''">
            <choose>
                <when test="keywordCriteria.qzUuid == -1">
                    AND ck.fQZSettingUuid IS NULL
                </when>
                <otherwise>
                    AND ck.fQZSettingUuid = #{keywordCriteria.qzUuid}
                </otherwise>
            </choose>
        </if>
        <if test="keywordCriteria.capturePositionFailIdentify != null">
            AND ck.fCapturePositionFailIdentify = #{keywordCriteria.capturePositionFailIdentify}
        </if>
        <if test="keywordCriteria.gtStartOptimizedTime != null and keywordCriteria.gtStartOptimizedTime != ''">
            AND ck.fStartOptimizedTime &gt;= #{keywordCriteria.gtStartOptimizedTime}
        </if>
        <if test="keywordCriteria.ltStartOptimizedTime != null and keywordCriteria.ltStartOptimizedTime != ''">
            AND ck.fStartOptimizedTime &lt;= #{keywordCriteria.ltStartOptimizedTime}
        </if>
        <if test="keywordCriteria.includeStatus != null and keywordCriteria.includeStatus != ''">
            AND ck.fIncludeStatus = #{keywordCriteria.includeStatus}
        </if>
        <if test="keywordCriteria.orderingElement != null and keywordCriteria.orderingElement != ''">
            ORDER BY ${keywordCriteria.orderingElement}
        </if>
    </sql>

    <sql id="updateCustomerKeywordsCriteria">
        <if test="keywordCriteria.uuids != null">
            AND ck.fUuid IN
            <foreach item="item" collection="keywordCriteria.uuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="keywordCriteria.customerUuid != null and keywordCriteria.customerUuid != ''">
            AND ck.fCustomerUuid = #{keywordCriteria.customerUuid}
        </if>
        <if test="keywordCriteria.keyword != null and keywordCriteria.keyword != ''">
            AND ck.fKeyword LIKE CONCAT(#{keywordCriteria.keyword},'%')
        </if>
        <if test="keywordCriteria.userName != null and keywordCriteria.userName != ''">
            AND c.fUserID = #{keywordCriteria.userName}
        </if>
        <if test="keywordCriteria.url != null and keywordCriteria.url != ''">
            AND ck.fUrl LIKE CONCAT(#{keywordCriteria.url},'%')
        </if>
        <if test="keywordCriteria.bearPawNumber != null and keywordCriteria.bearPawNumber != ''">
            AND ck.fBearPawNumber LIKE CONCAT(#{keywordCriteria.bearPawNumber},'%')
        </if>
        <if test="keywordCriteria.status != null and keywordCriteria.status != ''">
            AND ck.fStatus = #{keywordCriteria.status}
        </if>
        <if test="keywordCriteria.optimizeGroupName != null and keywordCriteria.optimizeGroupName != ''">
            AND ck.fOptimizeGroupName LIKE CONCAT(#{keywordCriteria.optimizeGroupName},'%')
        </if>
        <if test="keywordCriteria.machineGroup != null and keywordCriteria.machineGroup != ''">
            AND ck.fMachineGroup LIKE CONCAT(#{keywordCriteria.machineGroup},'%')
        </if>
        <if test="keywordCriteria.remarks != null and keywordCriteria.remarks != ''">
            AND ck.fRemarks LIKE CONCAT(#{keywordCriteria.remarks},'%')
        </if>
        <if test="keywordCriteria.failedCause != null and keywordCriteria.failedCause != ''">
            AND ck.fFailedCause = #{keywordCriteria.failedCause}
        </if>
        <if test="keywordCriteria.terminalType != null || keywordCriteria.terminalType != ''">
            AND ck.fTerminalType = #{keywordCriteria.terminalType}
        </if>
        <if test="keywordCriteria.searchEngine != null and keywordCriteria.searchEngine != ''">
            AND ck.fSearchEngine = #{keywordCriteria.searchEngine}
        </if>
        <if test="keywordCriteria.customerKeywordSource != null and keywordCriteria.customerKeywordSource != ''">
            AND ck.fCustomerKeywordSource = #{keywordCriteria.customerKeywordSource}
        </if>
        <if test="keywordCriteria.gtOptimizePlanCount != null">
            AND ck.fOptimizePlanCount &gt;= #{keywordCriteria.gtOptimizePlanCount}
        </if>
        <if test="keywordCriteria.ltOptimizePlanCount != null">
            AND ck.fOptimizePlanCount &lt;= #{keywordCriteria.ltOptimizePlanCount}
        </if>
        <if test="keywordCriteria.gtOptimizedCount != null">
            AND ck.fOptimizedCount &gt;= #{keywordCriteria.gtOptimizedCount}
        </if>
        <if test="keywordCriteria.ltOptimizedCount != null">
            AND ck.fOptimizedCount &lt;= #{keywordCriteria.ltOptimizedCount}
        </if>
        <if test="keywordCriteria.gtPosition != null and (keywordCriteria.noPosition == null or keywordCriteria.noPosition == '') ">
            AND ck.fCurrentPosition &gt;= #{keywordCriteria.gtPosition}
        </if>
        <if test="keywordCriteria.ltPosition != null and (keywordCriteria.noPosition == null or keywordCriteria.noPosition == '') ">
            AND ck.fCurrentPosition &lt;= #{keywordCriteria.ltPosition}
        </if>
        <if test="keywordCriteria.invalidRefreshCount != null and keywordCriteria.invalidRefreshCount != ''">
            AND ck.fInvalidRefreshCount &gt;= #{keywordCriteria.invalidRefreshCount}
        </if>
        <if test="keywordCriteria.gtCreateTime != null and keywordCriteria.gtCreateTime != ''">
            AND ck.fCreateTime &gt;= #{keywordCriteria.gtCreateTime}
        </if>
        <if test="keywordCriteria.ltCreateTime != null and keywordCriteria.ltCreateTime != ''">
            AND ck.fCreateTime &lt;= #{keywordCriteria.ltCreateTime}
        </if>
        <if test="keywordCriteria.noPosition != null and keywordCriteria.noPosition != ''">
            AND ck.fCurrentPosition = 0
        </if>
        <if test="keywordCriteria.pushPay != null and keywordCriteria.pushPay != ''">
            AND ((ck.fCollectMethod = 'PerDay' AND ck.fEffectiveToTime > '') OR (ck.fEffectiveToTime &lt;= DATE_ADD(CURDATE(),INTERVAL 3 DAY)))
        </if>
        <if test="keywordCriteria.requireDelete != null and keywordCriteria.requireDelete != ''">
            AND ck.fRequireDelete = 1
        </if>
        <if test="keywordCriteria.type != null and keywordCriteria.type != ''">
            AND ck.fType = #{keywordCriteria.type}
        </if>
        <if test="keywordCriteria.titleFlag == 1">
            AND (ck.fTitle = '' OR ck.fTitle IS NULL)
        </if>
        <if test="keywordCriteria.titleFlag == 2">
            AND ck.fTitle > ''
        </if>
        <if test="keywordCriteria.gtCurrentIndexCount != null">
            AND ck.fCurrentIndexCount &gt;= #{keywordCriteria.gtCurrentIndexCount}
        </if>
        <if test="keywordCriteria.ltCurrentIndexCount != null">
            AND ck.fCurrentIndexCount &lt;= #{keywordCriteria.ltCurrentIndexCount}
        </if>
        <if test="keywordCriteria.noReachStandardDays != null and keywordCriteria.noReachStandardDays > 0">
            AND ck.fLastReachStandardDate &lt;= DATE_SUB(CURRENT_DATE(), INTERVAL #{keywordCriteria.noReachStandardDays} DAY)
        </if>
        <if test="keywordCriteria.keywordEffect != null and keywordCriteria.keywordEffect != ''">
            AND ck.fKeywordEffect = #{keywordCriteria.keywordEffect}
        </if>
        <if test="keywordCriteria.type == 'qz' and keywordCriteria.qzUuid != null and keywordCriteria.qzUuid != ''">
            <choose>
                <when test="keywordCriteria.qzUuid == -1">
                    AND ck.fQZSettingUuid IS NULL
                </when>
                <otherwise>
                    AND ck.fQZSettingUuid = #{keywordCriteria.qzUuid}
                </otherwise>
            </choose>
        </if>
        <if test="keywordCriteria.capturePositionFailIdentify != null">
            AND ck.fCapturePositionFailIdentify = #{keywordCriteria.capturePositionFailIdentify}
        </if>
        <if test="keywordCriteria.gtStartOptimizedTime != null and keywordCriteria.gtStartOptimizedTime != ''">
            AND ck.fStartOptimizedTime &gt;= #{keywordCriteria.gtStartOptimizedTime}
        </if>
        <if test="keywordCriteria.ltStartOptimizedTime != null and keywordCriteria.ltStartOptimizedTime != ''">
            AND ck.fStartOptimizedTime &lt;= #{keywordCriteria.ltStartOptimizedTime}
        </if>
    </sql>

    <select id="searchKeywords" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid AS 'uuid',
        c.fUserID AS 'userID',
        c.fContactPerson AS 'contactPerson',
        ck.fTerminalType AS 'terminalType',
        ck.fCustomerUuid AS 'customerUuid',
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fOriginalUrl AS 'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle AS 'title',
        ck.fStatus AS 'status',
        ck.fSearchEngine AS 'searchEngine',
        ck.fCity AS 'city',
        ck.fCollectMethod AS 'collectMethod',
        ck.fInitialPosition AS 'initialPosition',
        ck.fCurrentIndexCount AS 'currentIndexCount',
        ck.fCurrentPosition AS 'currentPosition',
        ck.fInvalidRefreshCount AS 'invalidRefreshCount',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fOptimizePlanCount AS 'optimizePlanCount',
        ck.fOptimizedCount AS 'optimizedCount',
        ck.fOptimizedPercentage AS 'optimizedPercentage',
        ck.fOptimizeDate AS 'optimizeDate',
        ck.fPaymentStatus AS 'paymentStatus',
        ck.fOrderNumber AS 'orderNumber',
        ck.fRemarks AS 'remarks',
        ck.fFailedCause AS 'failedCause',
        ck.fCapturePositionQueryTime AS 'capturePositionQueryTime',
        ck.fOptimizeGroupName AS 'optimizeGroupName',
        ck.fMachineGroup AS 'machineGroup',
        ck.fCapturePositionFailIdentify AS 'capturePositionFailIdentify',
        ck.fIncludeStatus AS 'includeStatus'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <select id="getKeywordCountByKeywordCriteria" resultType="int">
        SELECT
        COUNT(1)
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <update id="updateCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateOptimizeGroupName" parameterType="com.keymanager.ckadmin.criteria.KeywordCriteria">
        UPDATE
        t_customer_keyword ck,t_customer c
        SET
        ck.fOptimizeGroupName = #{keywordCriteria.targetOptimizeGroupName},
        ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <update id="updateMachineGroup">
        UPDATE t_customer_keyword ck, t_customer c
        SET ck.fMachineGroup = #{keywordCriteria.targetMachineGroup}, ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <update id="updateBearPawNumber" parameterType="com.keymanager.ckadmin.criteria.KeywordCriteria">
        UPDATE
        t_customer_keyword ck,t_customer c
        SET
        ck.fBearPawNumber = #{keywordCriteria.targetBearPawNumber},
        ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <update id="updCustomerKeywordFormQz">
        UPDATE
        t_customer_keyword
        SET fQZSettingUuid = #{qzUuid}
        WHERE fUuid IN
        <foreach item="item" collection="ckUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <delete id="deleteCustomerKeywordsByUuids">
        DELETE FROM t_customer_keyword WHERE fUuid IN
        <foreach item="item" index="index" collection="customerKeywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitle">
        DELETE FROM t_customer_keyword
        WHERE 1 = 1
        <if test="keywordCriteria.qzUuid != null and keywordCriteria.qzUuid != ''">
            AND fQZSettingUuid = #{keywordCriteria.qzUuid}
        </if>
        AND fCustomerUuid = #{keywordCriteria.customerUuid}
        AND fTerminalType = #{keywordCriteria.terminalType}
        AND (fTitle = '' OR fTitle IS NULL)
    </delete>

    <delete id="deleteCustomerKeywordsWhenEmptyTitleAndUrl">
        DELETE FROM t_customer_keyword
        WHERE 1 = 1
        <if test="keywordCriteria.qzUuid != null and keywordCriteria.qzUuid != ''">
            AND fQZSettingUuid = #{keywordCriteria.qzUuid}
        </if>
        AND fCustomerUuid = #{keywordCriteria.customerUuid}
        AND fTerminalType = #{keywordCriteria.terminalType}
        AND fType = #{keywordCriteria.type}
        AND (fTitle = '' OR fTitle IS NULL)
        AND (fUrl = '' OR fUrl IS NULL)
    </delete>

    <select id="searchCustomerKeywords" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid AS 'uuid',
        c.fUserID AS 'userID',
        c.fContactPerson AS 'contactPerson',
        ck.fTerminalType AS 'terminalType',
        ck.fCustomerUuid AS 'customerUuid',
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fOriginalUrl AS 'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle AS 'title',
        ck.fStatus AS 'status',
        ck.fSearchEngine AS 'searchEngine',
        ck.fCity AS 'city',
        ck.fCollectMethod AS 'collectMethod',
        ck.fInitialPosition AS 'initialPosition',
        ck.fCurrentIndexCount AS 'currentIndexCount',
        ck.fCurrentPosition AS 'currentPosition',
        ck.fInvalidRefreshCount AS 'invalidRefreshCount',
        ck.fCapturePositionCity AS 'capturePositionCity',
        ck.fOptimizePlanCount AS 'optimizePlanCount',
        ck.fOptimizedCount AS 'optimizedCount',
        ck.fOptimizedPercentage AS 'optimizedPercentage',
        ck.fOptimizeDate AS 'optimizeDate',
        ck.fStartOptimizedTime AS 'startOptimizedTime',
        ck.fLastOptimizeDateTime AS 'lastOptimizeDateTime',
        ck.fLastReachStandardDate AS 'lastReachStandardDate',
        ck.fPaymentStatus AS 'paymentStatus',
        ck.fOrderNumber AS 'orderNumber',
        ck.fRemarks AS 'remarks',
        ck.fFailedCause AS 'failedCause',
        ck.fCapturePositionQueryTime AS 'capturePositionQueryTime',
        ck.fOptimizeGroupName AS 'optimizeGroupName',
        ck.fMachineGroup AS 'machineGroup',
        ck.fCapturePositionQueryTime AS 'capturePositionQueryTime',
        ck.fIncludeStatus AS 'includeStatus'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="searchCustomerKeywordsCriteria"/>
    </select>

    <update id="updateOptimizePlanCount">
        UPDATE
        t_customer_keyword ck,t_customer c
        SET
        ck.fOptimizePlanCount = #{keywordCriteria.targetOptimizePlanCount},
        ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <select id="searchCustomerKeywordsForDailyReport" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        <include refid="dailyReportColID"/>
        FROM
        t_customer_keyword ck
        WHERE ck.fCustomerUuid = #{keywordCriteria.customerUuid}
        AND ck.fStatus = 1
        AND fTerminalType = #{keywordCriteria.terminalType}
        AND fQZSettingUuid IS NULL
        ORDER BY ck.fSequence
    </select>

    <select id="getGroups" resultType="String">
        SELECT ck.fOptimizeGroupName as 'group' FROM t_customer_keyword ck WHERE ck.fStatus = 1
        <if test="customerUuids != null">
            AND ck.fCustomerUuid IN
            <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND ck.fOptimizeGroupName &gt; '' GROUP BY ck.fOptimizeGroupName
    </select>

    <select id="getCustomerUuids" resultType="java.lang.Long">
        SELECT DISTINCT ck.fCustomerUuid
        FROM t_customer_keyword ck
        WHERE ck.fType =  #{entryType}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fStatus = 1
        AND fQZSettingUuid IS NULL
    </select>

    <select id="searchCustomerKeywordInfo" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fOriginalUrl AS 'originalUrl',
        ck.fTitle AS 'title',
        ck.fInitialPosition AS 'initialPosition',
        ck.fCurrentPosition AS 'currentPosition',
        ck.fOptimizePlanCount AS 'optimizePlanCount',
        ck.fOptimizedCount AS 'optimizedCount',
        ck.fPositionFirstFee AS 'positionFirstFee',
        ck.fPositionSecondFee AS 'positionSecondFee',
        ck.fPositionThirdFee AS 'positionThirdFee',
        ck.fPositionForthFee AS 'positionForthFee',
        ck.fPositionFifthFee AS 'positionFifthFee',
        ck.fPositionFirstPageFee AS 'positionFirstPageFee',
        ck.fCurrentIndexCount AS 'currentIndexCount',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fRemarks AS 'remarks'
        FROM
        t_customer_keyword ck
        <where>
            <include refid="searchCustomerKeywordsCriteria"/>
        </where>
    </select>

    <select id="selectAllKeywordAndUrl" resultType="java.util.Map">
        SELECT
        fKeyword AS 'keyword',
        fUrl     AS 'url'
        FROM
        t_customer_keyword
        WHERE fCustomerUuid = #{customerUuid}
        AND fTerminalType = #{terminalType}
        AND fType = #{type}
    </select>

    <update id="updateSearchEngine">
        UPDATE t_customer_keyword ck, t_customer c
        SET ck.fSearchEngine = #{keywordCriteria.targetSearchEngine}, ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <update id="changeCustomerKeywordStatusInCKPage">
        UPDATE
        t_customer_keyword ck,t_customer c
        SET
        ck.fStatus = #{customerKeywordUpdateStatusCriteria.targetStatus},
        ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <if test="customerKeywordUpdateStatusCriteria.uuids != null">
            AND ck.fUuid IN
            <foreach item="item" collection="customerKeywordUpdateStatusCriteria.uuids" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="customerKeywordUpdateStatusCriteria.customerUuid != null and customerKeywordUpdateStatusCriteria.customerUuid != ''">
            AND ck.fCustomerUuid = #{customerKeywordUpdateStatusCriteria.customerUuid}
        </if>
        <if test="customerKeywordUpdateStatusCriteria.type != null and customerKeywordUpdateStatusCriteria.type != ''">
            AND ck.fType = #{customerKeywordUpdateStatusCriteria.type}
        </if>
        <if test="customerKeywordUpdateStatusCriteria.terminalType != null and customerKeywordUpdateStatusCriteria.terminalType != ''">
            AND ck.fTerminalType = #{customerKeywordUpdateStatusCriteria.terminalType}
        </if>
    </update>

    <update id="updCKStatusFromQZ" parameterType="java.util.HashMap">
        UPDATE t_customer_keyword ck
        SET ck.fStatus = #{condition.newStatus}
        WHERE ck.fQZSettingUuid = #{condition.qzUuid}
        AND ck.fStatus = #{condition.status}
        AND ck.fTerminalType = #{condition.terminalType}
    </update>
    
    <update id="cleanSelectedCustomerKeywordTitle">
        UPDATE t_customer_keyword
        SET fTitle = NULL ,
        fManualCleanTitle = 1
        WHERE fUuid IN
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>
    
    <update id="cleanCustomerTitle">
        UPDATE t_customer_keyword
        SET fTitle = NULL,
        fManualCleanTitle = 1
        <where>
            <if test="qzUuid != null and qzUuid != ''">
                AND fQZSettingUuid = #{qzUuid}
            </if>
            AND fCustomerUuid = #{customerUuid}
            AND fTerminalType = #{terminalType}
            AND fType = #{type}
        </where>
    </update>

    <update id="cleanCaptureTitleFlag">
        UPDATE t_customer_keyword
        SET fTitle = NULL,
        fCaptureTitleQueryTime = NULL,
        fCapturedTitle = 0
        <where>
            <if test="qzUuid != null and qzUuid != ''">
                AND fQZSettingUuid = #{qzUuid}
            </if>
            AND fCustomerUuid = #{customerUuid}
            AND fTerminalType = #{terminalType}
            AND fType = #{type}
            AND fManualCleanTitle = 0
        </where>
    </update>

    <update id="cleanCaptureTitleBySelected">
        UPDATE t_customer_keyword
        SET fTitle = NULL,
        fCaptureTitleQueryTime = NULL,
        fCapturedTitle = 0
        WHERE fUuid IN
        <foreach item="item" index="index" collection="uuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="searchDuplicateKeywords" resultType="java.lang.String">
        SELECT GROUP_CONCAT(CAST(fUuid AS CHAR) ORDER BY fUuid) AS 'uuids'
        FROM t_customer_keyword
        <where>
            <if test="customerKeywordUpdateStatusCriteria.customerUuid != null and customerKeywordUpdateStatusCriteria.customerUuid != ''">
                AND fCustomerUuid = #{customerKeywordUpdateStatusCriteria.customerUuid}
            </if>
            <if test="customerKeywordUpdateStatusCriteria.terminalType != null and customerKeywordUpdateStatusCriteria.terminalType != ''">
                AND fTerminalType = #{customerKeywordUpdateStatusCriteria.terminalType}
            </if>
            <if test="customerKeywordUpdateStatusCriteria.type != null and customerKeywordUpdateStatusCriteria.type != ''">
                AND fType = #{customerKeywordUpdateStatusCriteria.type}
            </if>
            <if test="customerKeywordUpdateStatusCriteria.qzUuid != null and customerKeywordUpdateStatusCriteria.qzUuid != ''">
                AND fQZSettingUuid = #{customerKeywordUpdateStatusCriteria.qzUuid}
            </if>
        </where>
        GROUP BY fCustomerUuid, fQZSettingUuid, fKeyword, fUrl
        HAVING COUNT(1) > 1
    </select>

    <update id="batchUpdateKeywords">
        UPDATE t_customer_keyword
        SET fTerminalType = fTerminalType
        <if test="keywordChecks.keyword==1">,fKeyword = #{keywordValues.keyword}</if>
        <if test="keywordChecks.title==1">,fTitle = #{keywordValues.title}</if>
        <if test="keywordChecks.bearPawNumber==1">,fBearPawNumber = #{keywordValues.bearPawNumber}</if>
        <if test="keywordChecks.url==1">,fUrl = #{keywordValues.url}</if>
        <if test="keywordChecks.originalUrl==1">,fOriginalUrl = #{keywordValues.originalUrl}</if>
        <if test="keywordChecks.optimizePlanCount==1">
            , fOptimizePlanCount = #{keywordValues.optimizePlanCount}
            , fOptimizeTodayCount = IF(fOptimizePlanCount > 0, fOptimizePlanCount * ROUND((RAND() * 0.7 + 0.5), 1) , 0)
            , fOptimizeRemainingCount = fOptimizeTodayCount - fOptimizedCount
            , fQueryInterval = IF(fOptimizeTodayCount > 0, (24 * 60 * 60 / fOptimizeTodayCount), 24 * 60 * 60)
            , fQueryTime = DATE_ADD(CURRENT_DATE(), INTERVAL fOptimizedCount * fQueryInterval SECOND)
        </if>
        <if test="keywordChecks.optimizeGroupName==1">,fOptimizeGroupName = #{keywordValues.optimizeGroupName}</if>
        <if test="keywordChecks.machineGroup==1">,fMachineGroup = #{keywordValues.machineGroup}</if>
        <if test="keywordChecks.initialIndexCount==1">,fInitialIndexCount = #{keywordValues.initialIndexCount}</if>
        <if test="keywordChecks.initialPosition==1">,fInitialPosition = #{keywordValues.initialPosition}</if>
        <if test="keywordChecks.positionFirstFee==1">,fPositionFirstFee = #{keywordValues.positionFirstFee}</if>
        <if test="keywordChecks.positionSecondFee==1">,fPositionSecondFee = #{keywordValues.positionSecondFee}</if>
        <if test="keywordChecks.positionThirdFee==1">,fPositionThirdFee = #{keywordValues.positionThirdFee}</if>
        <if test="keywordChecks.positionForthFee==1">,fPositionForthFee = #{keywordValues.positionForthFee}</if>
        <if test="keywordChecks.positionFifthFee==1">,fPositionFifthFee = #{keywordValues.positionFifthFee}</if>
        <if test="keywordChecks.positionFirstPageFee==1">,fPositionFirstPageFee = #{keywordValues.positionFirstPageFee}</if>
        <if test="keywordChecks.serviceProvider==1">,fServiceProvider = #{keywordValues.serviceProvider}</if>
        <if test="keywordChecks.keywordEffect==1">,fKeywordEffect = #{keywordValues.keywordEffect}</if>
        <if test="keywordChecks.collectMethod==1">,fCollectMethod = #{keywordValues.collectMethod}</if>
        <if test="keywordChecks.searchEngine==1">,fSearchEngine = #{keywordValues.searchEngine}</if>
        <if test="keywordChecks.city==1">,fCity = #{keywordValues.city}</if>
        <if test="keywordChecks.sequence==1">,fSequence = #{keywordValues.sequence}</if>
        <if test="keywordChecks.orderNumber==1">,fOrderNumber = #{keywordValues.orderNumber}</if>
        <if test="keywordChecks.paymentStatus==1">,fPaymentStatus = #{keywordValues.paymentStatus}</if>
        <if test="keywordChecks.recommendKeywords==1">,fRecommendKeywords = #{keywordValues.recommendKeywords}</if>
        <if test="keywordChecks.negativeKeywords==1">,fNegativeKeywords = #{keywordValues.negativeKeywords}</if>
        <if test="keywordChecks.excludeKeywords==1">,fExcludeKeywords = #{keywordValues.excludeKeywords}</if>
        <if test="keywordChecks.showPage==1">,fShowPage = #{keywordValues.showPage}</if>
        <if test="keywordChecks.relatedKeywordPercentage==1">,frelatedKeywordPercentage = #{keywordValues.relatedKeywordPercentage}</if>
        <if test="keywordChecks.remarks==1">,fRemarks = #{keywordValues.remarks}</if>
        <if test="keywordChecks.positionFirstCost==1">,fPositionFirstCost = #{keywordValues.positionFirstCost}</if>
        <if test="keywordChecks.positionSecondCost==1">,fPositionSecondCost = #{keywordValues.positionSecondCost}</if>
        <if test="keywordChecks.positionThirdCost==1">,fPositionThirdCost = #{keywordValues.positionThirdCost}</if>
        <if test="keywordChecks.positionForthCost==1">,fPositionForthCost = #{keywordValues.positionForthCost}</if>
        <if test="keywordChecks.positionFifthCost==1">,fPositionFifthCost = #{keywordValues.positionFifthCost}</if>
        <if test="keywordChecks.operateSelectKeyword==1">,fOperateSelectKeyword = #{keywordValues.operateSelectKeyword}</if>
        <if test="keywordChecks.operateRelatedKeyword==1">,fOperateRelatedKeyword = #{keywordValues.operateRelatedKeyword}</if>
        <if test="keywordChecks.operateRecommendKeyword==1">,fOperateRecommendKeyword = #{keywordValues.operateRecommendKeyword}</if>
        <if test="keywordChecks.operateSearchAfterSelectKeyword==1">,fOperateSearchAfterSelectKeyword = #{keywordValues.operateSearchAfterSelectKeyword}</if>
        <if test="keywordChecks.clickUrl==1">,fClickUrl = #{keywordValues.clickUrl}</if>
        <if test="keywordChecks.failedCause == 1">,fFailedCause = NULL</if>
        WHERE fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="searchCustomerKeywordForNoReachStandard" resultType="int">
        SELECT
        COUNT(1)
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        AND ck.fStatus = #{keywordStandardCriteria.status}
        AND ck.fType = #{keywordStandardCriteria.type}
        AND ck.fTerminalType = #{keywordStandardCriteria.terminalType}
        AND ck.fLastReachStandardDate &lt;= DATE_SUB(CURRENT_DATE(), INTERVAL #{keywordStandardCriteria.noReachStandardDays} DAY)
    </select>

    <select id="searchGroupsByTerminalType" resultType="com.keymanager.ckadmin.vo.CodeNameVo">
        SELECT
        fOptimizeGroupName as 'name'
        FROM
        t_customer_keyword
        WHERE
        fTerminalType = #{terminalType}
        AND
        fOptimizeGroupName IS NOT NULL
        AND
        fOptimizeGroupName &gt; ''
        GROUP BY
        fOptimizeGroupName
    </select>

    <select id="getAvailableOptimizationGroups" resultType="com.keymanager.ckadmin.vo.GroupVO">
        SELECT
        ck.fOptimizeGroupName AS 'groupName'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{groupSettingCriteria.terminalType}
        <if test="groupSettingCriteria.optimizedGroupName != null and groupSettingCriteria.optimizedGroupName != ''">
            AND ck.fOptimizeGroupName LIKE CONCAT(#{groupSettingCriteria.optimizedGroupName},'%')
        </if>
        AND ck.fOptimizeGroupName > ''
        AND ck.fStatus = 1
        GROUP BY ck.fOptimizeGroupName
    </select>

    <select id="searchPTKeywordCount" resultType="com.keymanager.ckadmin.vo.PTkeywordCountVO">
        SELECT
        ck.fKeyword AS 'keyword',
        ck.fSearchEngine AS 'searchEngine',
        COUNT(1) AS 'keywordCount',
        SUM(IF(ck.fCurrentPosition BETWEEN 1 AND 3, 1, 0)) AS 'topThree',
        SUM(IF(ck.fCurrentPosition BETWEEN 1 AND 10, 1, 0)) AS 'topTen',
        COUNT(DISTINCT ck.fCustomerUuid) AS 'customerCount',
        COUNT(DISTINCT c.fUserID) AS 'userCount'
        FROM
        t_customer_keyword ck,
        t_customer c
        WHERE c.fUuid = ck.fCustomerUuid
        AND ck.fType IN ('pt', 'qt')
        AND ck.fTerminalType = #{keywordCriteria.terminalType}
        <if test="keywordCriteria.keyword != null and keywordCriteria.keyword != ''">
            AND ck.fKeyword like concat(#{keywordCriteria.keyword}, '%')
        </if>
        <if test="keywordCriteria.searchEngine != null and keywordCriteria.searchEngine != ''">
            AND ck.fSearchEngine = #{keywordCriteria.searchEngine}
        </if>
        <if test="keywordCriteria.userName != null and keywordCriteria.userName != ''">
            AND c.fUserID = #{keywordCriteria.userName}
        </if>
        GROUP BY ck.fKeyword, ck.fSearchEngine
        ORDER BY keywordCount DESC
    </select>

    <update id="updateKeywordCustomerUuid">
        UPDATE t_customer_keyword
        SET fCustomerUuid = #{customerUuid}
        WHERE
        fTerminalType = #{terminalType}
        AND fUuid IN
        <foreach item="item" index="index" collection="keywordUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="updateCustomerUuidByQzUuids">
        UPDATE t_customer_keyword
        SET fCustomerUuid = #{customerUuid}
        WHERE fQZSettingUuid IN
        <foreach item="item" collection="qzUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <update id="editOptimizePlanCountByCustomerUuid">
        UPDATE t_customer_keyword
        <if test="settingType == 'setCurrentCount'">
            SET fOptimizePlanCount = IF((fOptimizePlanCount + (#{optimizePlanCount})) > 0, (fOptimizePlanCount + (#{optimizePlanCount})), 0)
        </if>
        <if test="settingType == 'setSpecificCount'">
            SET fOptimizePlanCount = #{optimizePlanCount}
        </if>
        , fOptimizeTodayCount = IF(fOptimizePlanCount > 0, fOptimizePlanCount * ROUND((RAND() * 0.7 + 0.5), 1) , 0)
        , fOptimizeRemainingCount = fOptimizeTodayCount - fOptimizedCount
        , fQueryInterval = IF(fOptimizeTodayCount > 0, (24 * 60 * 60 / fOptimizeTodayCount), 24 * 60 * 60)
        , fQueryTime = DATE_ADD(CURRENT_DATE(), INTERVAL fOptimizedCount * fQueryInterval SECOND)
        WHERE fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fCustomerUuid = #{customerUuid}
    </update>

    <update id="editCustomerOptimizePlanCount">
        UPDATE t_customer_keyword
        <if test="settingType == 'setCurrentCount'">
            SET fOptimizePlanCount = IF((fOptimizePlanCount + (#{optimizePlanCount})) > 0, (fOptimizePlanCount + (#{optimizePlanCount})), 0)
        </if>
        <if test="settingType == 'setSpecificCount'">
            SET fOptimizePlanCount = #{optimizePlanCount}
        </if>
        , fOptimizeTodayCount = IF(fOptimizePlanCount > 0, fOptimizePlanCount * ROUND((RAND() * 0.7 + 0.5), 1) , 0)
        , fOptimizeRemainingCount = fOptimizeTodayCount - fOptimizedCount
        , fQueryInterval = IF(fOptimizeTodayCount > 0, (24 * 60 * 60 / fOptimizeTodayCount), 24 * 60 * 60)
        , fQueryTime = DATE_ADD(CURRENT_DATE(), INTERVAL fOptimizedCount * fQueryInterval SECOND)
        WHERE fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateSelectFailReason" parameterType="com.keymanager.ckadmin.criteria.KeywordCriteria">
        UPDATE t_customer_keyword ck, t_customer c
        SET ck.fFailedCause = null, ck.fUpdateTime = NOW()
        WHERE c.fUuid = ck.fCustomerUuid
        <include refid="updateCustomerKeywordsCriteria"/>
    </update>

    <select id="getMaxSequence" resultType="java.lang.Integer">
        select max(fSequence)
        from t_customer_keyword
        where fCustomerUuid = #{customerUuid}
        and fTerminalType = #{terminalType}
        and fType = #{entryType}
    </select>

    <select id="searchSameCustomerKeywords" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fInitialIndexCount	AS	'initialIndexCount',
        ck.fCurrentIndexCount	AS	'currentIndexCount',
        ck.fOptimizePlanCount	AS	'optimizePlanCount',
        ck.fPositionFirstFee	AS	'positionFirstFee',
        ck.fPositionSecondFee	AS	'positionSecondFee',
        ck.fPositionThirdFee	AS	'positionThirdFee',
        ck.fPositionForthFee	AS	'positionForthFee',
        ck.fPositionFifthFee	AS	'positionFifthFee',
        ck.fPositionFirstPageFee	AS	'positionFirstPageFee'
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fCustomerUuid = #{customerUuid}
        AND ck.fSearchEngine = #{searchEngine}
        ORDER BY ck.fCreateTime
    </select>
    
     <select id="getMaxInvalidCountByMachineGroup" resultType="java.lang.Integer">
        SELECT toc.fMaxInvalidCount
        FROM t_customer_keyword ck
        LEFT JOIN t_group g
        ON ck.fOptimizeGroupName = g.fGroupName
        LEFT JOIN t_operation_combine toc
        ON toc.fUuid = g.fOperationCombineUuid
        WHERE ck.fMachineGroup = #{machineGroup}
        GROUP BY ck.fOptimizeGroupName
        LIMIT 1
    </select>
    
    <select id="getQZRateKeywordCount" resultType="com.keymanager.ckadmin.vo.QZRateKeywordCountVO">
        SELECT
            c.fUuid AS customerUuid,
            c.fContactPerson AS customerName,
            ck.fQZSettingUuid AS qzUuid,
            qz.fDomain AS qzDomain,
            <if test="qzRateKewordCountCriteria.terminalType == null or qzRateKewordCountCriteria.terminalType == ''">
                IF(qz.fPcGroup > '', 1, 0) AS hasPC,
                IF(qz.fPhoneGroup > '', 1, 0) AS hasPhone,
            </if>
            COUNT(1) AS totalKeywordCount,
            SUM(IF(ck.fCurrentPosition BETWEEN 1 AND 10, 1, 0)) AS topTenKeywordCount
        FROM t_customer_keyword ck
        LEFT JOIN t_qz_setting qz on ck.fQZSettingUuid = qz.fUuid
        LEFT JOIN t_customer c on c.fUuid = qz.fCustomerUuid
        WHERE 1 = 1
        <if test="qzRateKewordCountCriteria.searchEngine != null and qzRateKewordCountCriteria.searchEngine != ''">
            AND ck.fSearchEngine = #{qzRateKewordCountCriteria.searchEngine}
        </if>
        <if test="qzRateKewordCountCriteria.terminalType != null and qzRateKewordCountCriteria.terminalType != ''">
            AND ck.fTerminalType = #{qzRateKewordCountCriteria.terminalType}
        </if>
        <if test="qzRateKewordCountCriteria.customerUuid != null and qzRateKewordCountCriteria.customerUuid != ''">
            AND c.fUuid = #{qzRateKewordCountCriteria.customerUuid}
        </if>
        <if test="qzRateKewordCountCriteria.domain != null and qzRateKewordCountCriteria.domain != ''">
            AND qz.fDomain LIKE CONCAT(#{qzRateKewordCountCriteria.domain},'%')
        </if>
        <if test="qzRateKewordCountCriteria.qzUuids != null">
            AND ck.fQZSettingUuid IN
            <foreach item="qzUuid"  collection="qzRateKewordCountCriteria.qzUuids" open="(" separator="," close=")">
                #{qzUuid}
            </foreach>
        </if>
        GROUP BY ck.fQZSettingUuid
    </select>

    <select id="getQZRateKeywordCountByCriteria" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM (
        SELECT
        ck.fQZSettingUuid
        FROM t_customer_keyword ck
        LEFT JOIN t_qz_setting qz on ck.fQZSettingUuid = qz.fUuid
        LEFT JOIN t_customer c on c.fUuid = qz.fCustomerUuid
        WHERE 1 = 1
        <if test="criteria.searchEngine != null and criteria.searchEngine != ''">
            AND ck.fSearchEngine = #{criteria.searchEngine}
        </if>
        <if test="criteria.terminalType != null and criteria.terminalType != ''">
            AND ck.fTerminalType = #{criteria.terminalType}
        </if>
        <if test="criteria.customerUuid != null and criteria.customerUuid != ''">
            AND c.fUuid = #{criteria.customerUuid}
        </if>
        <if test="criteria.domain != null and criteria.domain != ''">
            AND qz.fDomain LIKE CONCAT(#{criteria.domain},'%')
        </if>
        <if test="criteria.qzUuids != null">
            AND ck.fQZSettingUuid IN
            <foreach item="qzUuid" collection="criteria.qzUuids" open="(" separator="," close=")">
                #{qzUuid}
            </foreach>
        </if>
        GROUP BY ck.fQZSettingUuid
        ) T
    </select>
    
    <select id="getCustomerKeywordStatusCount" resultType="java.util.Map">
        SELECT
        COUNT(ck.fStatus = 2 OR NULL)  AS 'addCount',
        COUNT(ck.fStatus = 1 OR NULL)  AS 'operatorCount',
        COUNT(ck.fStatus = 0 OR NULL)  AS 'stopCount',
        COUNT(ck.fStatus = 3 OR NULL)  AS 'obtainedCount'
        FROM t_customer_keyword ck
        <if test="loginName != null and loginName != ''">
            WHERE EXISTS(SELECT 1 FROM t_customer c WHERE c.fUuid = ck.fCustomerUuid AND c.fUserID = #{loginName})
        </if>
    </select>

    <select id="getUseMachineProportion" resultType="java.util.Map">
        SELECT
            t1.terminalType AS 'terminalType',
            ROUND(t1.number / t2.total * 100.000000, 6) AS 'proportion'
        FROM
        (
            SELECT
            ck.fTerminalType AS 'terminalType',
            SUM(fQueryCount) AS 'number'
            FROM t_customer_keyword ck
            LEFT JOIN t_customer c
            ON c.fUuid = ck.fCustomerUuid
            WHERE ck.fStatus > 0
            AND c.fUserID = #{username}
            GROUP BY c.fUserID, ck.fTerminalType
        ) t1,
        (
            SELECT
            ck.fTerminalType AS 'terminalType',
            SUM(fQueryCount) AS 'total'
            FROM t_customer_keyword ck
            LEFT JOIN t_customer c
            ON c.fUuid = ck.fCustomerUuid
            WHERE ck.fStatus > 0
            GROUP BY ck.fTerminalType
        ) t2
        WHERE t1.terminalType = t2.terminalType
    </select>


    <select id="getCustomerKeywordUuidForCapturePositionTemp" resultType="Long">
        SELECT
        ck.fUuid AS 'uuid'
        FROM t_customer_keyword ck
        <where>
            <if test="customerUuid != null">
                AND ck.fCustomerUuid = #{customerUuid}
            </if>
            <if test="groupName != null">
                AND ck.fOptimizeGroupName = #{groupName}
            </if>
            AND ck.fTerminalType = #{terminalType}
            AND ck.fStatus = 1
            AND fCaptureStatus = #{captureStatus}
            <if test="startTime != null and captureStatus == 0">
                AND ck.fCapturePositionQueryTime &lt; #{startTime}
                <if test="saveTopThree == true">
                    AND !(ck.fCapturePositionQueryTime &gt; CURRENT_DATE() AND ck.fCurrentPosition &lt; 4 AND ck.fCurrentPosition &gt; 0)
                </if>
            </if>
            <if test="startTime != null and captureStatus == 1">
                AND ck.fCapturePositionQueryTime &lt; DATE_SUB( NOW(), INTERVAL 3 MINUTE )
            </if>
            LIMIT 10
        </where>
    </select>

    <select id="getCustomerKeywordForCapturePositionTemp" resultType="com.keymanager.value.CustomerKeywordForCapturePosition">
        SELECT
        ck.fUuid AS 'uuid',
        ck.fTerminalType AS 'terminalType',
        ck.fKeyword AS 'keyword',
        ck.fUrl AS 'url',
        ck.fTitle AS 'title',
        ck.fSearchEngine AS 'searchEngine',
        ck.fBearPawNumber AS 'bearPawNumber'
        FROM
        t_customer_keyword ck
        WHERE
        ck.fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </select>

    <update id="updateCapturePositionQueryTimeAndCaptureStatusTemp">
        UPDATE
        t_customer_keyword
        SET
        fCaptureStatus = 1,
        fCapturePositionQueryTime = NOW()
        WHERE
        fUuid IN
        <foreach item="uuid" collection="uuids" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="getCustomerKeywordFee" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
          ck.fUuid                 AS 'uuid',
          ck.fPositionFirstFee     AS 'positionFirstFee',
          ck.fPositionSecondFee    AS 'positionSecondFee',
          ck.fPositionThirdFee     AS 'positionThirdFee',
          ck.fPositionForthFee     AS 'positionForthFee',
          ck.fPositionFifthFee     AS 'positionFifthFee',
          ck.fPositionFirstPageFee AS 'positionFirstPageFee',
          ck.fSearchEngine AS 'searchEngine',
          ck.fTerminalType AS 'terminalType',
          ck.fCustomerUuid AS 'customerUuid',
          ck.fType AS 'type'
        FROM t_customer_keyword ck
        WHERE ck.fUuid = #{uuid}
    </select>

    <update id="updatePosition">
        UPDATE
        t_customer_keyword
        SET
        fCurrentPosition = IF(fLastReachStandardDate = CURRENT_DATE(),IF(#{position} > 0 AND #{position} &lt; fCurrentPosition, #{position}, fCurrentPosition),
        #{position}),
        fInitialPosition = IFNULL(fInitialPosition, #{position}),
        fCapturePositionQueryTime = IFNULL(#{capturePositionQueryTime}, fCapturePositionQueryTime),
        fTodayFee = if(fLastReachStandardDate = CURRENT_DATE(), if(fTodayFee > #{todayFee} OR #{todayFee} is null, fTodayFee, #{todayFee}), #{todayFee}),
        fCapturePositionIP = #{ip}, fCapturePositionCity = #{city},
        <if test="todayFee != null">
            fLastReachStandardDate = CURRENT_DATE(),
        </if>
        fCaptureStatus = 0,
        fUpdateTime = NOW()
        WHERE fUuid = #{uuid}
    </update>

    <update id="updateCustomerKeywordQueryTime">
        UPDATE t_customer_keyword
        SET fCaptureStatus = 0,
        fCapturePositionQueryTime = #{capturePositionQueryTime}
        <if test="capturePositionFailIdentify != null">
            , fCapturePositionFailIdentify = #{capturePositionFailIdentify}
        </if>
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <select id="getCrawlRankKeywords" resultType="com.keymanager.ckadmin.vo.CustomerKeyWordCrawlRankVO">
        (
            SELECT
            ck.fUuid AS 'uuid',
            ck.fTerminalType AS 'terminalType',
            ck.fType AS 'type',
            ck.fCity AS 'city',
            ck.fTitle AS 'title',
            ck.fKeyword AS 'keyword',
            ck.fUrl AS 'url',
            ck.fSearchEngine AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
            FROM t_customer_keyword ck
            WHERE ck.fType = #{type}
            AND ck.fSearchEngine = ''
            <if test="type == 'qz'">
                AND ck.fTerminalType = 'PC'
            </if>
            <choose>
                <when test="captureStatus == 1">
                    AND ck.fCaptureStatus = 1
                    AND ck.fCapturePositionQueryTime &lt;= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
                </when>
                <otherwise>
                    AND ck.fCaptureStatus = 0
                    AND ck.fCapturePositionQueryTime &lt; CURRENT_DATE()
                </otherwise>
            </choose>
            LIMIT 3000
        )
        UNION ALL
        (
            SELECT
            ck.fUuid AS 'uuid',
            ck.fTerminalType AS 'terminalType',
            ck.fType AS 'type',
            ck.fCity AS 'city',
            ck.fTitle AS 'title',
            ck.fKeyword AS 'keyword',
            ck.fUrl AS 'url',
            ck.fSearchEngine AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
            FROM t_customer_keyword ck
            WHERE ck.fType = #{type}
            AND ck.fSearchEngine = ''
            <choose>
                <when test="captureStatus == 1">
                    AND ck.fCaptureStatus = 1
                    AND ck.fCapturePositionQueryTime &lt;= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
                </when>
                <otherwise>
                    AND ck.fCaptureStatus = 0
                    AND ck.fCapturePositionQueryTime &lt; CURRENT_DATE()
                </otherwise>
            </choose>
            LIMIT 3000
        )
        UNION ALL
        (
            SELECT
            ck.fUuid AS 'uuid',
            ck.fTerminalType AS 'terminalType',
            ck.fType AS 'type',
            ck.fCity AS 'city',
            ck.fTitle AS 'title',
            ck.fKeyword AS 'keyword',
            ck.fUrl AS 'url',
            ck.fSearchEngine AS 'searchEngine',
            ck.fBearPawNumber AS 'bearPawNumber'
            FROM t_customer_keyword ck
            WHERE ck.fType = #{type}
            AND ck.fSearchEngine = '360'
            <choose>
                <when test="captureStatus == 1">
                    AND ck.fCaptureStatus = 1
                    AND ck.fCapturePositionQueryTime &lt;= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
                </when>
                <otherwise>
                    AND ck.fCaptureStatus = 0
                    AND ck.fCapturePositionQueryTime &lt; CURRENT_DATE()
                </otherwise>
            </choose>
            LIMIT 3000
        )
        LIMIT 3000
    </select>

    <update id="updateCrawlRankKeywordTimeByUuids">
        UPDATE t_customer_keyword
        SET
        fCapturePositionQueryTime = NOW(),
        fCaptureStatus = 1
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="getGroupsByUser" resultType="java.lang.String">
        SELECT DISTINCT
        ck.fOptimizeGroupName as 'group'
        FROM t_customer_keyword ck
        WHERE ck.fStatus = 1
        AND ck.fOptimizeGroupName &gt; ''
        AND EXISTS(SELECT 1 FROM t_customer c,t_customer_business cb
        WHERE c.fUuid = ck.fCustomerUuid
        AND cb.fCustomerUuid = c.fUuid
        <if test="username != null and username != ''">
            AND c.fUserID = #{username}
        </if>
        AND cb.fType = #{type})
    </select>

    <delete id="deleteSysCustomerKeywordByQzId">
        DELETE FROM sys_customer_keyword WHERE QS_ID = #{uuid}
    </delete>

    <select id="cacheCustomerKeywordForCapturePosition" resultType="com.keymanager.value.CustomerKeywordForCapturePosition">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fTitle	AS	'title',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fBearPawNumber AS 'bearPawNumber'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType} and ck.fStatus = 1
        AND fCaptureStatus = #{captureStatus}
        <if test="startTime != null and captureStatus == 0">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> #{startTime}
            AND !(ck.fCapturePositionQueryTime > CURRENT_DATE() AND ck.fCurrentPosition &lt; 4 AND ck.fCurrentPosition &gt; 0)
        </if>
        <if test="startTime != null and captureStatus == 1">
            AND ck.fCapturePositionQueryTime <![CDATA[<]]> DATE_SUB( NOW(), INTERVAL 3 MINUTE )
        </if>
        <if test="customerUuid != null">
            AND ck.fCustomerUuid = #{customerUuid}
        </if>
        <choose>
            <when test="groupNames != null">
                AND ck.fOptimizeGroupName IN
                <foreach item="item" index="index" collection="groupNames" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                AND ck.fOptimizeGroupName IS NULL
            </otherwise>
        </choose>
        LIMIT 500
    </select>

    <update id="batchUpdateOptimizedCountFromCache" parameterType="java.util.Collection">
        UPDATE t_customer_keyword
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="fOptimizedCount = fOptimizedCount + (case" suffix="end),">
                <foreach collection="updateOptimizedCountVOs" item="updateOptimizedCountVO">
                    when fUuid = #{updateOptimizedCountVO.customerKeywordUuid} then #{updateOptimizedCountVO.totalSucceedCount}
                </foreach>
            </trim>
            <trim prefix="fOptimizeRemainingCount = fOptimizeRemainingCount - (case" suffix="end),">
                <foreach collection="updateOptimizedCountVOs" item="updateOptimizedCountVO">
                    when fUuid = #{updateOptimizedCountVO.customerKeywordUuid} then #{updateOptimizedCountVO.totalSucceedCount}
                </foreach>
            </trim>
            <trim prefix="fFailedCause =  (case" suffix="end),">
                <foreach collection="updateOptimizedCountVOs" item="updateOptimizedCountVO">
                    when fUuid = #{updateOptimizedCountVO.customerKeywordUuid} then #{updateOptimizedCountVO.failedCause}
                </foreach>
            </trim>
            <trim prefix="fBearPawNumber =  (case" suffix="end),">
                <foreach collection="updateOptimizedCountVOs" item="updateOptimizedCountVO">
                    when fUuid = #{updateOptimizedCountVO.customerKeywordUuid} then
                    <choose>
                        <when test="updateOptimizedCountVO.bearpawNumber != null and updateOptimizedCountVO.bearpawNumber != ''">
                            #{updateOptimizedCountVO.bearpawNumber}
                        </when>
                        <otherwise>
                            fBearPawNumber
                        </otherwise>
                    </choose>
                </foreach>
            </trim>
            <trim prefix="fInvalidRefreshCount = (case" suffix="end),">
                <foreach collection="updateOptimizedCountVOs" item="updateOptimizedCountVO">
                    when fUuid = #{updateOptimizedCountVO.customerKeywordUuid} then
                    <choose>
                        <when test="updateOptimizedCountVO.totalSucceedCount > 0">
                            0
                        </when>
                        <otherwise>
                            fInvalidRefreshCount
                        </otherwise>
                    </choose>
                </foreach>
            </trim>
            fInvalidFlag = if(fInvalidRefreshCount > 8 or (fFailedCause > ''  AND fOptimizedCount = 0), 1, 0),
            fLastOptimizeDateTime = now(),
            fQueryTime = if(fOptimizeTodayCount > fOptimizedCount, fQueryTime,DATE_ADD(NOW(), INTERVAL 1 DAY)),
            fUpdateTime = NOW()
        </trim>
        WHERE fUuid IN
        <foreach item="updateOptimizedCountVO" index="index" collection="updateOptimizedCountVOs" open="(" separator="," close=")">
            #{updateOptimizedCountVO.customerKeywordUuid}
        </foreach>
    </update>

    <select id="getCustomerKeywordUuidsForBDExcel" resultType="java.lang.Long">
        SELECT ck.fUuid
        FROM
            t_customer_keyword ck,
            t_customer c
        WHERE
            c.fUuid = ck.fCustomerUuid
            AND c.fUserID = #{username}
            AND ck.fKeyword = #{customerKeyword.keyword}
            AND ck.fUrl = #{customerKeyword.url}
            AND ck.fSearchEngine = #{customerKeyword.searchEngine}
            AND ck.fType = #{customerKeyword.type}
            AND ck.fTerminalType = #{customerKeyword.terminalType}
    </select>

    <update id="batchDownKeywordByExcel">
        UPDATE t_customer_keyword
        SET
        fStatus = 3,
        fUpdateTime = NOW()
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <select id="fetchCustomerKeywordsForIncludeCheck"  resultType="com.keymanager.ckadmin.vo.CustomerKeywordIncludeVO">
        SELECT
            fUuid AS 'uuid',
            fTerminalType AS 'terminalType',
            fKeyword AS 'keyword',
            fUrl AS 'url',
            fSearchEngine AS 'searchEngine'
        FROM
            t_customer_keyword
        WHERE
            fStatus = 1
            AND (
                ( fIncludeCheckTime &lt; DATE_SUB( CURRENT_DATE(), INTERVAL 3 DAY ) AND fIncludeStatus = 0 )
                OR ( fOptimizedCount = 0 AND fFailedCause = "" AND fIncludeCheckTime &lt; CURRENT_DATE() )
            )
        LIMIT 1000
    </select>

    <update id="updateIncludeCheckTimeByUuids">
        UPDATE t_customer_keyword
        SET fIncludeCheckTime = NOW(), fIncludeStatus = 1
        WHERE fUuid IN
        <foreach collection="uuids" item="uuid" open="(" separator="," close=")">
            #{uuid}
        </foreach>
    </update>

    <update id="updateCustomerKeywordIncludeStatus">
        UPDATE t_customer_keyword
        SET fIncludeStatus = #{includeStatus}
        WHERE fUuid = #{customerKeywordUuid}
    </update>

    <update id="updateCustomerKeywordIncludeCheckTime">
        UPDATE t_customer_keyword
        SET fIncludeCheckTime = #{includeCheckTime}
        WHERE fUuid = #{customerKeywordUuid}
    </update>
</mapper>