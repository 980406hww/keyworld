<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.keymanager.ckadmin.dao.CustomerKeywordDao">

    <select id="getCustomerKeywordsCount" resultType="java.util.Map">
        SELECT ck.fCustomerUuid as 'customerUuid', COUNT(1) as 'totalCount', SUM(IF(ck.fStatus = 1, 1, 0)) AS
        'activeCount'
        FROM t_customer_keyword ck
        WHERE ck.fTerminalType = #{terminalType}
        AND ck.fType = #{entryType}
        AND ck.fCustomerUuid IN
        <foreach item="item" index="index" collection="customerUuids" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <update id="changeCustomerKeywordStatus">
        UPDATE t_customer_keyword SET fStatus = #{status}
        WHERE fTerminalType = #{terminalType}
        AND fType = #{entryType}
        AND fCustomerUuid = #{customerUuid}
    </update>

    <delete id="deleteCustomerKeywordsByCustomerUuid">
        delete from t_customer_keyword where fCustomerUuid = #{customerUuid}
    </delete>

    <select id="getCustomerKeywordCount" resultType="int">
        SELECT COUNT(1) FROM t_customer_keyword ck WHERE ck.fType = #{entryType} and ck.fTerminalType = #{terminalType} and ck.fCustomerUuid = #{customerUuid}
    </select>

    <update id="excludeCustomerKeyword">
        UPDATE  t_customer_keyword ck
        SET ck.fStatus = 3
        WHERE 1=1
        <if test="qzSettingExcludeCustomerKeywordsCriteria.customerUuid != null and qzSettingExcludeCustomerKeywordsCriteria.customerUuid != ''">
            AND ck.fCustomerUuid = #{qzSettingExcludeCustomerKeywordsCriteria.customerUuid}
        </if>
        AND ck.fType = #{qzSettingExcludeCustomerKeywordsCriteria.type}
        AND ck.fTerminalType = #{qzSettingExcludeCustomerKeywordsCriteria.terminalType}
        AND ck.fKeyword IN
        <foreach item = "keyword" collection = "qzSettingExcludeCustomerKeywordsCriteria.keywords" open="(" separator="," close=")">
            #{keyword}
        </foreach>
        AND ck.fUrl LIKE CONCAT(#{qzSettingExcludeCustomerKeywordsCriteria.domain},'%')
    </update>

    <insert id="addCustomerKeywords">
        INSERT INTO t_customer_keyword (
        fTerminalType,
        fCustomerUuid,
        fQZSettingUuid,
        fKeyword,
        fUrl,
        fType,
        fBearPawNumber,
        fOriginalUrl,
        fTitle,
        fSequence,
        fAutoUpdateNegativeDateTime,
        fSearchEngine,
        fInitialIndexCount,
        fCurrentIndexCount,
        fCurrentPosition,
        fQueryDate,
        fQueryTime,
        fServiceProvider,
        fOptimizeGroupName,
        fMachineGroup,
        fOptimizePlanCount,
        fOptimizeTodayCount,
        fOptimizeRemainingCount,
        fLastReachStandardDate,
        fPositionFirstFee,
        fPositionSecondFee,
        fPositionThirdFee,
        fPositionForthFee,
        fPositionFifthFee,
        fPositionFirstPageFee,
        fCapturePositionQueryTime,
        fCollectMethod,
        fStartOptimizedTime,
        fOrderNumber,
        fStatus,
        fManualCleanTitle,
        fKeywordEffect,
        fCustomerKeywordSource,
        fRemarks,
        fUpdateTime,
        fCreateTime
        )
        VALUES
        <foreach collection="customerKeywords" item="customerKeyword" separator=",">
            (
            #{customerKeyword.terminalType},
            #{customerKeyword.customerUuid},
            #{customerKeyword.qzSettingUuid},
            #{customerKeyword.keyword},
            #{customerKeyword.url},
            #{customerKeyword.type},
            #{customerKeyword.bearPawNumber},
            #{customerKeyword.originalUrl},
            #{customerKeyword.title},
            #{customerKeyword.sequence},
            #{customerKeyword.autoUpdateNegativeDateTime},
            #{customerKeyword.searchEngine},
            #{customerKeyword.initialIndexCount},
            #{customerKeyword.currentIndexCount},
            #{customerKeyword.currentPosition},
            #{customerKeyword.queryDate},
            #{customerKeyword.queryTime},
            #{customerKeyword.serviceProvider},
            #{customerKeyword.optimizeGroupName},
            #{customerKeyword.machineGroup},
            <choose>
                <when test="customerKeyword.optimizePlanCount != null">
                    #{customerKeyword.optimizePlanCount},
                </when>
                <when test="customerKeyword.optimizePlanCount == null">10,</when>
            </choose>
            #{customerKeyword.optimizeTodayCount},
            #{customerKeyword.optimizeRemainingCount},
            #{customerKeyword.lastReachStandardDate},
            <choose>
                <when test="customerKeyword.positionFirstFee != null">#{customerKeyword.positionFirstFee},</when>
                <when test="customerKeyword.positionFirstFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionSecondFee != null">#{customerKeyword.positionSecondFee},</when>
                <when test="customerKeyword.positionSecondFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionThirdFee != null">#{customerKeyword.positionThirdFee},</when>
                <when test="customerKeyword.positionThirdFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionForthFee != null">#{customerKeyword.positionForthFee},</when>
                <when test="customerKeyword.positionForthFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionFifthFee != null">#{customerKeyword.positionFifthFee},</when>
                <when test="customerKeyword.positionFifthFee == null">0.00,</when>
            </choose>
            <choose>
                <when test="customerKeyword.positionFirstPageFee != null">#{customerKeyword.positionFirstPageFee},</when>
                <when test="customerKeyword.positionFirstPageFee == null">0.00,</when>
            </choose>
            #{customerKeyword.capturePositionQueryTime},
            #{customerKeyword.collectMethod},
            #{customerKeyword.startOptimizedTime},
            #{customerKeyword.orderNumber},
            #{customerKeyword.status},
            <choose>
                <when test="customerKeyword.manualCleanTitle != null">#{customerKeyword.manualCleanTitle},</when>
                <when test="customerKeyword.manualCleanTitle == null">0,</when>
            </choose>
            #{customerKeyword.keywordEffect},
            #{customerKeyword.customerKeywordSource},
            #{customerKeyword.remarks},
            #{customerKeyword.updateTime},
            #{customerKeyword.createTime}
            )
        </foreach>
    </insert>

    <select id="getOneSameCustomerKeyword" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle	AS	'title',
        ck.fStatus	AS	'status',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fKeywordEffect AS 'keywordEffect',
        ck.fOptimizePlanCount	AS	'optimizePlanCount'
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fCustomerUuid = #{customerUuid}
        <choose>
            <when test="url == 'NoUrl'">
                AND ck.fTitle = #{title}
            </when>
            <otherwise>
                AND ck.fUrl = #{url}
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <update id="updateSameCustomerKeyword">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeyword.customerKeywordSource},
        fKeywordEffect = #{customerKeyword.keywordEffect},
        fOptimizePlanCount = #{customerKeyword.optimizePlanCount}
        WHERE fKeyword = #{customerKeyword.keyword}
        AND fTerminalType = #{customerKeyword.terminalType}
        AND fCustomerUuid = #{customerKeyword.customerUuid}
        <choose>
            <when test="customerKeyword.url == 'NoUrl'">
                AND fTitle = #{customerKeyword.title}
            </when>
            <otherwise>
                AND fUrl = #{customerKeyword.url}
            </otherwise>
        </choose>
    </update>

    <select id="getOneSimilarCustomerKeyword" resultType="com.keymanager.ckadmin.entity.CustomerKeyword">
        SELECT
        ck.fUuid	AS	'uuid',
        ck.fTerminalType	AS	'terminalType',
        ck.fCustomerUuid	AS	'customerUuid',
        ck.fKeyword	AS	'keyword',
        ck.fUrl	AS	'url',
        ck.fOriginalUrl	AS	'originalUrl',
        ck.fBearPawNumber AS 'bearPawNumber',
        ck.fTitle	AS	'title',
        ck.fStatus	AS	'status',
        ck.fSearchEngine	AS	'searchEngine',
        ck.fKeywordEffect AS 'keywordEffect',
        ck.fOptimizePlanCount	AS	'optimizePlanCount'
        FROM t_customer_keyword ck
        WHERE ck.fKeyword = #{keyword}
        AND ck.fTerminalType = #{terminalType}
        AND ck.fCustomerUuid = #{customerUuid}
        <choose>
            <when test="originalUrl == 'NoUrl'">
                AND ck.fTitle = #{title}
            </when>
            <otherwise>
                AND ck.fOriginalUrl <![CDATA[ > ]]> ''
                AND ck.fOriginalUrl like concat('%', #{originalUrl})
            </otherwise>
        </choose>
        LIMIT 1
    </select>

    <update id="updateSimilarCustomerKeyword">
        UPDATE t_customer_keyword
        SET fCustomerKeywordSource = #{customerKeyword.customerKeywordSource},
        fKeywordEffect = #{customerKeyword.keywordEffect},
        fOptimizePlanCount = #{customerKeyword.optimizePlanCount}
        WHERE fKeyword = #{customerKeyword.keyword}
        AND fTerminalType = #{customerKeyword.terminalType}
        AND fCustomerUuid = #{customerKeyword.customerUuid}

        <choose>
            <when test="customerKeyword.originalUrl == 'NoUrl'">
                AND fTitle = #{title}
            </when>
            <otherwise>
                AND fOriginalUrl <![CDATA[ > ]]> ''
                AND fOriginalUrl like concat('%', #{customerKeyword.originalUrl})
            </otherwise>
        </choose>
    </update>

    <select id="getCustomerKeywordCountByOptimizeGroupName" resultType="int">
        SELECT COUNT(1)
        FROM t_customer_keyword
        WHERE fOptimizeGroupName LIKE CONCAT(#{groupName}, '%')
    </select>

</mapper>